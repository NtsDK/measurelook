/*Copyright 2017 Timofey Rechkalov <ntsdk@yandex.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

'use strict';

function makeLocalDBMS(fullVersion) {
    const opts = {
        Migrator,
        CommonUtils,
        EventEmitter,
        Precondition,
        R,
        Ajv,
        Schema,
        Errors,
        listeners: {},
        Constants,
        dbmsUtils: {},
        dateFormat,
    };

    function LocalDBMS() {
        this._init(opts.listeners);
    }

    LocalDBMS.prototype.getSettings = () => this.database.Settings;

    const func = name => window[name](LocalDBMS, opts);

    [
        'baseAPI',
        'consistencyCheckAPI',
        //        'logAPI',
        //        'charsheetAPI',
        //        'settingsAPI',
    ].map(func);

    //    Logger.attachLogCalls(LocalDBMS, R, false);
    return LocalDBMS;
}

/*Copyright 2015-2017 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

'use strict';

((exports) => {
    const state = {};

    exports.init = (callback) => {
        state.callback = callback;
    };

    exports.makeNewBase = () => {
        Utils.confirm(getL10n('utils-new-base-warning'), () => {
            DBMS.setDatabase(CommonUtils.clone(EmptyBase.data), state.callback);
        });
    };

    exports.openHelp = () => {
        window.open('extras/doc/nims.html');
    };

    exports.readSingleFile = (evt) => {
        // Retrieve the first (and only!) File from the FileList object
        const f = evt.target.files[0];

        if (f) {
            const r = new FileReader();
            r.onload = (e) => {
                const contents = e.target.result;
                const database = JSON.parse(contents);
                DBMS.setDatabase(database, state.callback);
            };
            r.readAsText(f);
        } else {
            Utils.alert(getL10n('utils-base-file-loading-error'));
        }
    };

    exports.saveFile = () => {
        DBMS.getDatabase((err, database) => {
            if (err) { Utils.handleError(err); return; }
            exports.json2File(database, `${BASE_FILE_NAME}.json`);
        });
    };

    exports.json2File = (str, fileName) => {
        exports.str2File(JSON.stringify(str, null, '  '), fileName);
    };

    exports.str2File = (str, fileName) => {
        const blob = new Blob([str], {
            type: 'text/plain;charset=utf-8'
        });
        saveAs(blob, fileName);
    };

    function preprocessCsvStr(str) {
        if (!(typeof str === 'string' || str instanceof String)) {
            return str;
        }
        let result = str.replace(/"/g, '""');
        if (result.search(/("|,|\n)/g) >= 0) {
            result = `"${result}"`;
        }
        return result;
    }

    exports.arr2d2Csv = (arr, fileName) => {
        const csv = `\ufeff${arr.map(dataArray => dataArray.map(preprocessCsvStr).join(';')).join('\n')}`;

        const out = new Blob([csv], {
            type: 'text/csv;charset=utf-8;'
        });
        saveAs(out, 'table.csv');
    };
})(this.FileUtils = {});

/*Copyright 2015-2017 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

'use strict';

/* eslint-disable no-var,vars-on-top */

((exports, Dictionaries) => {
    const state = {};

    state.initialized = false;
    state.l10nDelegates = [];
    state.dictionaries = {};
    state.lang = defaultLang;

    const init = () => {
        if (state.initialized) {
            return;
        }
        //        console.log(navigator.language);

        state.dictionaries = R.map(processDictionary, Dictionaries);

        //    var lang = (navigator.languages ? navigator.languages[0] : navigator.browserLanguage).split('-')[0];
        //    var lang = 'ru';
        //        var lang = defaultLang;
        //        console.log(lang);

        if (state.dictionaries[defaultLang]) {
            state.dict = state.dictionaries[defaultLang];
        } else {
            state.dict = state.dictionaries.en;
        }
        setHtmlLang(defaultLang);
        exports.onL10nChange(exports.localizeStatic);
        state.initialized = true;
    };

    var processDictionary = (dictionary) => {
        const processedDictionary = {};
        R.toPairs(dictionary).forEach(([sectionName, section]) => {
            R.toPairs(section).forEach(([key, value]) => {
                processedDictionary[`${sectionName}-${key}`] = value;
            });
        });
        //        for (const sectionName in dictionary) {
        //            for (const name in dictionary[sectionName]) {
        //                processedDictionary[`${sectionName}-${name}`] = dictionary[sectionName][name];
        //            }
        //        }
        return processedDictionary;
    };

    var setHtmlLang = lang => setAttr(document.getElementsByTagName('html')[0], 'lang', lang);

    exports.toggleL10n = () => {
        if (state.lang === 'ru') {
            state.dict = state.dictionaries.en;
            state.lang = 'en';
        } else {
            state.dict = state.dictionaries.ru;
            state.lang = 'ru';
        }
        setHtmlLang(state.lang);
        state.l10nDelegates.forEach((delegate) => {
            delegate();
        });
    };

    exports.getLang = () => state.lang.toLowerCase();

    exports.format = R.curry((namespace, name, args) => strFormat(exports.get(namespace, name), args));

    exports.get = R.curry((namespace, name) => L10n.getValue(`${namespace}-${name}`));

    exports.getValue = (name) => {
        const value = state.dict[name];
        if (value === undefined) console.log(`Value is not found: ${name}`);
        return value || `${name}:RA RA-AH-AH-AH ROMA ROMA-MA GAGA OH LA-LA`;
    };

    exports.onL10nChange = (delegate) => {
        state.l10nDelegates.push(delegate);
    };

    exports.localizeStatic = () => {
        init();
        nl2array(document.querySelectorAll('[l10n-id]')).map(el => addEl(clearEl(el), makeText(exports.getValue(getAttr(el, 'l10n-id')))));
        nl2array(document.querySelectorAll('[l10n-placeholder-id]')).map(el => setAttr(el, 'placeholder', exports.getValue(getAttr(el, 'l10n-placeholder-id'))));
    };
})(this.L10n = {}, Dictionaries);

/*Copyright 2015-2017 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

'use strict';

/* eslint-disable no-var,vars-on-top */

((exports) => {
    exports.initTabPanel = (tabClazz, containerClazz) => {
        const containers = getEls(containerClazz);

        let i;
        for (i = 1; i < containers.length; i++) { // don't hide 1st element
            addClass(containers[i], 'hidden');
        }

        const tabButtons = getEls(tabClazz);

        addClass(tabButtons[0], 'active');

        for (i = 0; i < tabButtons.length; i++) {
            listen(tabButtons[i], 'click', tabButtonClick(tabButtons, containers));
        }
    };

    var tabButtonClick = (buttons, containers) => (event) => {
        for (let i = 0; i < buttons.length; i++) {
            setClassByCondition(buttons[i], 'active', event.target.id === buttons[i].id);
        }
        for (let i = 0; i < containers.length; i++) {
            setClassByCondition(containers[i], 'hidden', `${event.target.id}Container` !== containers[i].id);
        }
    };

    exports.fillShowItemSelector = (selector, displayArray) => {
        let el;
        setAttr(selector, 'size', displayArray.length);
        displayArray.forEach((value) => {
            el = setProps(makeEl('option'), {
                selected: true,
            });
            setClassByCondition(el, 'hidden', value.hidden);
            addEl(selector, addEl(el, makeText(value.name)));
        });
    };

    exports.fillShowItemSelector2 = (selector, optionGroups) => {
        let el, groupEl, counter = 0;
        addEls(selector, optionGroups.map((group) => {
            counter++;
            groupEl = setAttr(makeEl('optgroup'), 'label', group.name);
            addEls(groupEl, group.array.map((value) => {
                el = setProps(makeEl('option'), {
                    selected: true,
                });
                setClassByCondition(el, 'hidden', value.hidden);
                counter += (value.hidden ? 0 : 1);
                return addEl(el, makeText(value.name));
            }));
            return groupEl;
        }));
        setAttr(selector, 'size', counter);
    };

    exports.showSelectedEls = classKey => (event) => {
        const el = event.target;
        let els, i, j;
        for (i = 0; i < el.options.length; i += 1) {
            els = getEls(i + classKey);
            for (j = 0; j < els.length; j++) {
                setClassByCondition(els[j], 'hidden', !el.options[i].selected);
            }
        }
    };

    exports.initSelectorFilters = () => {
        const elems = document.querySelectorAll('[selector-filter]');
        let el, sel;
        for (let i = 0; i < elems.length; i++) {
            el = elems[i];
            sel = queryEl(getAttr(el, 'selector-filter'));
            el.value = '';
            listen(el, 'input', filterOptions(sel));
        }
    };

    var filterOptions = sel => (event) => {
        let val = event.target.value;
        let i, opt;
        val = CommonUtils.globStringToRegex(val.trim().toLowerCase());
        for (i = 0; i < sel.options.length; i += 1) {
            opt = sel.options[i];
            const isVisible = opt.innerHTML.toLowerCase().search(val) !== -1;
            if (!isVisible) {
                opt.selected = false;
            }
            setClassByCondition(opt, 'hidden', !isVisible);
            //                setClassByCondition(opt, "hidden", opt.innerHTML.toLowerCase().search(val) === -1);
        }
        sel.dispatchEvent(new Event('change'));
    };

    exports.initPanelTogglers = () => {
        const elems = document.querySelectorAll('[panel-toggler]');
        let el, sel, attr;
        for (let i = 0; i < elems.length; i++) {
            el = elems[i];
            attr = getAttr(el, 'panel-toggler');
            sel = document.querySelector(attr);
            if (sel == null) {
                Utils.alert(`Panel toggler is broken: ${attr}`);
            }
            listen(el, 'click', exports.togglePanel(sel));
        }
    };

    exports.togglePanel = sel => (event) => {
        toggleClass(sel, 'hidden');
    };

    exports.makeEventTimePicker = (opts) => {
        const input = makeEl('input');
        R.ap([addClass(input)], opts.extraClasses);
        addClass(input, 'eventTime');
        input.value = opts.eventTime;

        input.eventIndex = opts.index;

        const pickerOpts = {
            lang: L10n.getLang(),
            mask: true,
            startDate: new Date(opts.preGameDate),
            endDate: new Date(opts.date),
            onChangeDateTime: opts.onChangeDateTimeCreator(input),
        };

        if (opts.eventTime !== '') {
            pickerOpts.value = opts.eventTime;
        } else {
            pickerOpts.value = opts.date;
            addClass(input, 'defaultDate');
        }

        jQuery(input).datetimepicker(pickerOpts);
        return input;
    };

    // bug about setting 0900 years in Braavos game is event date. Fixed in production.
    //  exports.makeEventTimePicker = function (opts) {
    //      var input = makeEl("input");
    //      R.ap([addClass(input)], opts.extraClasses);
    //      addClass(input, "eventTime");
    //      input.value = opts.eventTime;
    //
    //      input.eventIndex = opts.index;
    //
    //      var pickerOpts = {
    //          lang : L10n.getLang(),
    //          mask : true,
    //          startDate : new Date(opts.preGameDate),
    //          endDate : new Date(opts.date),
    //          onChangeDateTime : opts.onChangeDateTimeCreator(input),
    //      };
    //
    //      var picker = jQuery(input).datetimepicker(pickerOpts);
    //
    //      var value;
    //      if (opts.eventTime !== "") {
    //          value = new Date(opts.eventTime);
    //      } else {
    //          value = opts.date;
    //          addClass(input, "defaultDate");
    //      }
    //
    //      picker.value = value;
    //
    //
    //      return input;
    //  };

    exports.resizeTextarea = (ev) => {
        const that = ev.target;
        that.style.height = '24px';
        that.style.height = `${that.scrollHeight + 12}px`;
    };

    exports.resizeTextarea2 = (that) => {
        that.style.height = '24px';
        that.style.height = `${that.scrollHeight + 12}px`;
    };

    exports.makeAdaptationTimeInput = (storyName, event, characterName, isEditable) => {
        const input = makeEl('input');
        setClassByCondition(input, 'notEditable', !isEditable);
        addClass(input, 'adaptationTimeInput');
        input.value = event.characters[characterName].time;
        input.dataKey = JSON.stringify([storyName, event.index, characterName]);
        listen(input, 'change', onChangePersonalTimeDelegate);
        return input;
    };

    var onChangePersonalTimeDelegate = (event) => {
        const dataKey = JSON.parse(event.target.dataKey);
        const time = event.target.value;
        DBMS.setEventAdaptationProperty(dataKey[0], dataKey[1], dataKey[2], 'time', time, Utils.processError());
    };

    exports.makeAdaptationReadyInput = (storyName, event, characterName, isEditable) => {
        const div = makeEl('div');
        const input = makeEl('input');
        setClassByCondition(input, 'notEditable', !isEditable);
        input.type = 'checkbox';
        input.checked = event.characters[characterName].ready;
        input.dataKey = JSON.stringify([storyName, event.index, characterName]);
        input.id = `${event.index}-${storyName}-${characterName}`;
        listen(input, 'change', onChangeReadyStatus);
        addEl(div, input);

        addEl(div, setAttr(addEl(makeEl('label'), makeText(constL10n(Constants.finishedText))), 'for', input.id));
        return div;
    };

    var onChangeReadyStatus = (event) => {
        const dataKey = JSON.parse(event.target.dataKey);
        const value = event.target.checked;
        DBMS.setEventAdaptationProperty(dataKey[0], dataKey[1], dataKey[2], 'ready', value, Utils.processError());
    };

    exports.makePanelCore = (title, content) => {
        const panel = addClasses(makeEl('div'), ['panel', 'panel-default']);
        const h3 = addClass(addEl(makeEl('h3'), title), 'panel-title');
        const a = setAttr(makeEl('a'), 'href', '#/');
        const headDiv = addClass(makeEl('div'), 'panel-heading');
        addEl(panel, addEl(headDiv, addEl(a, h3)));
        const contentDiv = addClass(makeEl('div'), 'panel-body');
        addEl(panel, addEl(contentDiv, content));
        return {
            panel,
            contentDiv,
            a
        };
    };

    exports.makeProfileTable = (profileStructure, profile) => {
        let value;
        const profileDiv = addEls(makeEl('tbody'), profileStructure.filter(element => element.doExport).map((element) => {
            switch (element.type) {
            case 'text':
                value = addClass(makeEl('span'), 'briefingTextSpan');
                addEl(value, makeText(profile[element.name]));
                break;
            case 'enum':
            case 'multiEnum':
            case 'number':
            case 'string':
                value = makeText(profile[element.name]);
                break;
            case 'checkbox':
                value = makeText(constL10n(Constants[profile[element.name]]));
                break;
            default:
                throw new Error(`Unexpected type ${element.type}`);
            }
            return exports.makeTableRow(makeText(element.name), value);
        }));
        return addEl(addClasses(makeEl('table'), ['table', 'table-striped']), profileDiv);
    };

    exports.makeTableRow = (col1, col2) => addEls(makeEl('tr'), [addEl(makeEl('td'), col1), addEl(makeEl('td'), col2)]);
})(this.UI = {});

/*Copyright 2015-2017 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

'use strict';

// TODO need to lint utils with NIMS fixes
/* eslint-disable */

const strFormat = R.curry(CommonUtils.strFormat);

function getL10n(key) {
    return L10n.getValue(key);
}

function constL10n(key) {
    return L10n.getValue(`constant-${key}`);
}

function isEmpty(obj) {
    return (Object.getOwnPropertyNames(obj).length === 0);
}

const addClass = R.curry((o, c) => {
    const re = new RegExp(`(^|\\s)${c}(\\s|$)`, 'g');
    if (re.test(o.className)) return o;
    o.className = (`${o.className} ${c}`).replace(/\s+/g, ' ').replace(/(^ | $)/g, '');
    return o;
});

const addClasses = R.curry((o, c) => {
    R.ap([addClass(o)], c);
    return o;
});

const rAddClass = R.curry((c, o) => addClass(o, c));

function hasClass(o, c) {
    const re = new RegExp(`(^|\\s)${c}(\\s|$)`, 'g');
    return (re.test(o.className));
}

const removeClass = R.curry((o, c) => {
    const re = new RegExp(`(^|\\s)${c}(\\s|$)`, 'g');
    o.className = o.className.replace(re, '$1').replace(/\s+/g, ' ').replace(/(^ | $)/g, '');
});

const toggleClass = R.curry((o, c) => {
    if (hasClass(o, c)) {
        removeClass(o, c);
    } else {
        addClass(o, c);
    }
});

function setClassByCondition(o, c, condition) {
    if (condition) {
        addClass(o, c);
    } else {
        removeClass(o, c);
    }
    return o;
}

function getEl(id) {
    return document.getElementById(id);
}

function queryEl(sel) {
    return document.querySelector(sel);
}

function queryEls(sel) {
    return nl2array(document.querySelectorAll(sel));
}

function queryElEls(el, sel) {
    return nl2array(el.querySelectorAll(sel));
}

function getEls(clazz) {
    return document.getElementsByClassName(clazz);
}

function makeEl(elTag) {
    return document.createElement(elTag);
}

function makeText(text) {
    return document.createTextNode(text);
}

const addEl = R.curry((parent, child) => {
    parent.appendChild(child);
    return parent;
});
const addEls = R.curry((parent, children) => {
    R.ap([addEl(parent)], children);
    return parent;
});

const makeOpt = function (label) {
    const option = makeEl('option');
    addEl(option, (makeText(label)));
    return option;
};

const rAddEl = R.curry((child, parent) => {
    parent.appendChild(child);
    return parent;
});


const setAttr = R.curry((el, name, value) => {
    el.setAttribute(name, value);
    return el;
});

const setStyle = R.curry((el, name, value) => {
    el.style.setProperty(name, value);
    return el;
});

const setImportantStyle = R.curry((el, name, value) => {
    el.style.setProperty(name, value, 'important');
    return el;
});

function delAttr(el, name) {
    el.removeAttribute(name);
    return el;
}

function getAttr(el, name) {
    return el.getAttribute(name);
}

const setProp = R.curry((el, key, value) => {
    el[key] = value;
    return el;
});

const setProps = R.curry((el, map) => {
    for (const key in map) {
        setProp(el, key, map[key]);
    }
    return el;
});

function clearEl(el) {
    Utils.removeChildren(el);
    return el;
}

function passEls(src, dst) {
    for (let i = 0; i < src.children.length; i++) {
        addEl(dst, src.children[i]);
    }
}

const listen = R.curry((el, event, listener) => {
    el.addEventListener(event, listener);
    return el;
});

const listenOnEnter = R.curry((el, callback) => {
    listen(el, 'keydown', (e) => {
        if (e.keyCode === 13) {
            callback();
        }
    });
});

const fillSelector = R.curry((sel, data) => addEls(sel, data.map((item) => {
    const opt = makeEl('option');
    addEl(opt, makeText(item.name));
    if (item.value) { opt.value = item.value; }
    if (item.selected) { opt.selected = true; }
    if (item.className) { addClass(opt, item.className); }
    return opt;
})));

function nl2array(nodeList) {
    return Array.prototype.slice.call(nodeList);
}

const remapProps = R.curry((outKeys, pickKeys, obj) => R.compose(R.zipObj(outKeys), R.values, R.pick(pickKeys))(obj));

const remapProps4Select2 = remapProps(['id', 'text'], ['value', 'displayName']);
const remapProps4Select = remapProps(['value', 'name'], ['value', 'displayName']);

const getSelect2DataCommon = R.curry((preparator, obj) => R.compose(R.zipObj(['data']), R.append(R.__, []), R.map(preparator))(obj));

const getSelect2Data = getSelect2DataCommon(remapProps4Select2);

const makeSelect2Opt = R.compose(R.zipObj(['id', 'text']), R.repeat(R.__, 2));
const arr2Select2 = R.compose(R.assoc('data', R.__, {}), R.map(makeSelect2Opt));
const arr2Select = R.map(R.compose(R.zipObj(['value', 'name']), R.repeat(R.__, 2)));
const constArr2Select = R.map(R.compose(R.zipObj(['value', 'name']), name => [name, constL10n(name)]));

const getSelectedRadio = function (query) {
    const els = document.querySelectorAll(query);
    for (let i = 0; i < els.length; i++) {
        if (els[i].checked === true) {
            return els[i];
        }
    }
    return null;
};

const debugInterceptor = function (callback) {
    return function () {
        console.log(JSON.stringify(arguments[0]));
        callback(...arguments);
    };
};

const Utils = {};

/** opts
    tooltip - add tooltip to button, used for iconic buttons
    id - set button id
    mainPage - enable view as first page
    toggle - toggle content, associated with button
*/
Utils.addView = function (containers, name, view, opts2) {
    const opts = opts2 || {};
    view.init();
    const buttonClass = 'navigation-button';
    containers.root.views[name] = view;
    const button = makeEl('button');
    function delegate() {
        $(button).attr('data-original-title', L10n.getValue(`header-${name}`));
    }
    if (opts.tooltip) {
        L10n.onL10nChange(delegate);
        $(button).tooltip({
            title: L10n.getValue(`header-${name}`),
            placement: 'bottom'
        });
    } else {
        addEl(button, makeText(L10n.getValue(`header-${name}`)));
        setAttr(button, 'l10n-id', `header-${name}`);
    }
    addClass(button, buttonClass);
    addClass(button, `-test-${name}`);
    addClass(button, `-toggle-class-${name}`);
    if (opts.clazz) {
        addClass(button, opts.clazz);
    }
    containers.navigation.appendChild(button);

    const onClickDelegate = function (view2) {
        return function (evt) {
            //Tests.run();
            const elems = containers.navigation.getElementsByClassName(buttonClass);
            if (opts.toggle) {
                const els = getEls(`-toggle-class-${name}`);
                for (let i = 0; i < els.length; i++) {
                    if (evt.target.isEqualNode(els[i])) {
                        continue;
                    }
                    if (hasClass(els[i], 'active')) {
                        els[i].click();
                    }
                }
            }

            const isActive = hasClass(evt.target, 'active');
            for (let i = 0; i < elems.length; i++) {
                removeClass(elems[i], 'active');
            }
            if (!opts.toggle || (opts.toggle && !isActive)) {
                addClass(evt.target, 'active');

                passEls(containers.content, getEl('warehouse'));
                containers.content.appendChild(view2.content);
                removeClass(containers.content, 'hidden');
                containers.root.currentView = view2;
                view2.refresh();
            } else {
                removeClass(evt.target, 'active');
                passEls(containers.content, getEl('warehouse'));
                containers.root.currentView = null;
                addClass(containers.content, 'hidden');
            }
        };
    };

    button.addEventListener('click', onClickDelegate(view));
    if (opts.mainPage) {
        addClass(button, 'active');
        containers.content.appendChild(view.content);
        containers.root.currentView = view;
    }
};

Utils.alert = function (message) {
    vex.dialog.alert(message);
};

Utils.confirm = function (message, onOk, onCancel) {
    vex.dialog.confirm({
        message,
        callback: (val) => {
            if (val) {
                if (onOk) onOk();
            } else if (onCancel) onCancel();
        }
    });
};

Utils.removeChildren = function (myNode) {
    if (!myNode) {
        return;
    }
    while (myNode.firstChild) {
        myNode.removeChild(myNode.firstChild);
    }
};

Utils.processError = function (callback) {
    return function (err) {
        if (err) {
            Utils.handleError(err);
            return;
        }

        if (callback) {
            const arr = [];
            for (let i = 1; i < arguments.length; i++) {
                arr.push(arguments[i]);
            }
            callback(...arr);
        }
    };
};

Utils.handleErrorMsg = function (err) {
    const checkErrorType = R.curry((err2, name) => err2 instanceof Errors[name] || (err2.name && err2.name === name));
    if (R.keys(Errors).some(checkErrorType(err))) {
        return strFormat(getL10n(err.messageId), err.parameters);
    } else if (typeof err === 'object') {
        return err.message;
    }
    return err;
};

Utils.handleError = err => Utils.alert(Utils.handleErrorMsg(err));

Utils.enableEl = R.curry((el, condition) => {
    const key = el.tagName.toLowerCase() === 'textarea' ? 'readonly' : 'disabled';
    if (condition) {
        el.removeAttribute(key);
    } else {
        el.setAttribute(key, key);
    }
});

Utils.enable = function (root, className, condition) {
    nl2array(root.getElementsByClassName(className)).map(Utils.enableEl(R.__, condition));
};

Utils.charOrdAObject = CommonUtils.charOrdAFactory(a => a.displayName.toLowerCase());

Utils.rebuildSelector = function (selector, names) {
    clearEl(selector);
    names.forEach((nameInfo) => {
        const option = makeEl('option');
        option.appendChild(makeText(nameInfo.displayName));
        option.value = nameInfo.value;
        selector.appendChild(option);
    });
};

Utils.rebuildSelectorArr = function (selector, names) {
    clearEl(selector);
    names.forEach((name) => {
        const option = makeEl('option');
        option.appendChild(makeText(name));
        selector.appendChild(option);
    });
};

String.prototype.endsWith = function (suffix) {
    return this.indexOf(suffix, this.length - suffix.length) !== -1;
};

// from date format utils
//For convenience...
Date.prototype.format = function (mask, utc) {
    return dateFormat(this, mask, utc);
};

/*Copyright 2017 Timofey Rechkalov <ntsdk@yandex.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

'use strict';

((exports) => {
    const state = {};
    state.views = {};

    const btnOpts = {
        tooltip: true,
        className: 'mainNavButton'
    };

    exports.onMasterPageLoad = () => {
        initPage();
        const LocalDBMS = makeLocalDBMS(true);
        if (MODE === 'Standalone') {
            window.DBMS = new LocalDBMS();
            DBMS.setDatabase(BaseExample.data, (err) => {
                if (err) { Utils.handleError(err); return; }
                consistencyCheck(onDatabaseLoad);
            });
        } else if (MODE === 'NIMS_Server') {
            const RemoteDBMS = makeRemoteDBMS(LocalDBMS);
            window.DBMS = new RemoteDBMS();
            consistencyCheck(onDatabaseLoad);
        }
    };

    function onDatabaseLoad() {
        //        initTheme();

        stateInit();

        Utils.addView(state.containers, 'performance', Performance, { mainPage: true });
        //        Utils.addView(state.containers, 'instruction', Instruction);

        addEl(state.navigation, addClass(makeEl('div'), 'nav-separator'));

        Utils.addView(state.containers, 'about', About);

        addEl(state.navigation, makeButton('testButton', 'test', runTests, btnOpts));

        const button = makeButton('dataLoadButton', 'open-database', null, btnOpts);
        button.addEventListener('change', FileUtils.readSingleFile, false);

        const input = makeEl('input');
        input.type = 'file';
        addClass(input, 'hidden');
        setAttr(input, 'tabindex', -1);
        button.appendChild(input);
        button.addEventListener('click', (e) => {
            input.value = '';
            input.click();
        });
        addEl(state.navigation, button);

        //                addEl(state.navigation, makeButton("themeButton", "theme", () => nextTheme(), btnOpts));
        addEl(state.navigation, makeButton('dataSaveButton', 'save-database', FileUtils.saveFile, btnOpts));
        //if (MODE === 'Standalone') {
        //  addEl(state.navigation, makeButton('newBaseButton', 'create-database', FileUtils.makeNewBase, btnOpts));
        //}
        //addEl(state.navigation, makeButton("mainHelpButton", "docs", FileUtils.openHelp, btnOpts));

        //        addEl(state.navigation, makeL10nButton());

        //        Utils.addView(state.containers, 'logViewer', LogViewer2, { clazz: 'logViewerButton', tooltip: true });
        //        addEl(state.navigation, makeButton('testButton', 'test', runTests, btnOpts));

        //addEl(state.navigation, makeButton("refreshButton", "refresh", () => state.currentView.refresh(), btnOpts));

        FileUtils.init((err) => {
            if (err) { Utils.handleError(err); return; }
            consistencyCheck(state.currentView.refresh);
        });

        state.currentView.refresh();
        addBeforeUnloadListener();
    }

    function initPage() {
        L10n.localizeStatic();
        L10n.onL10nChange(() => state.currentView.refresh());
        UI.initSelectorFilters();
        UI.initPanelTogglers();
        function updateDialogs() {
            vex.dialog.buttons.YES.text = getL10n('common-ok');
            vex.dialog.buttons.NO.text = getL10n('common-cancel');
        }
        updateDialogs();
        L10n.onL10nChange(updateDialogs);
    }

    //    var curTheme = Constants.themeList[1];
    //
    //    var initTheme = function() {
    //        if(DBMS.setTheme){
    //            DBMS.getTheme(function(err, theme){
    //                if(err) {console.log(err);}
    //                if(theme !== ''){
    //                    curTheme = theme;
    //                }
    //                addClass(queryEl('body'), curTheme);
    //            });
    //        } else {
    //            addClass(queryEl('body'), curTheme);
    //        }
    //    };
    //
    //    var nextTheme = function() {
    //        removeClass(queryEl('body'), curTheme);
    //        curTheme = Constants.themeList[(R.indexOf(curTheme, Constants.themeList)+1)%Constants.themeList.length];
    //        addClass(queryEl('body'), curTheme);
    //        if(DBMS.setTheme){
    //            DBMS.setTheme(curTheme, function(err){
    //                if(err) {console.log(err); return;}
    //            });
    //        }
    //    };

    function consistencyCheck(callback) {
        DBMS.getConsistencyCheckResult((err, consistencyErrors) => {
            if (err) { Utils.handleError(err); return; }
            consistencyErrors.forEach(CommonUtils.consoleLog);
            if (consistencyErrors.length > 0) {
                Utils.alert(getL10n('overview-consistency-problem-detected'));
            } else {
                console.log('Consistency check didn\'t find errors');
            }
            callback();
        });
    }

    function stateInit() {
        state.navigation = getEl('navigation');
        state.containers = {
            root: state,
            navigation: state.navigation,
            content: getEl('contentArea')
        };
    }

    function runTests() {
        DBMS.getConsistencyCheckResult((err, consistencyErrors) => {
            if (err) { Utils.handleError(err); return; }
            consistencyErrors.forEach(CommonUtils.consoleLog);
            if (consistencyErrors.length > 0) {
                Utils.alert(getL10n('overview-consistency-problem-detected'));
            } else {
                Utils.alert(getL10n('overview-consistency-is-ok'));
                console.log('Consistency check didn\'t find errors');
            }
        });
    }

    function makeButton(clazz, name, callback, opts) {
        const button = makeEl('button');
        addClass(button, clazz);
        function delegate() {
            $(button).attr('data-original-title', L10n.getValue(`header-${name}`));
        }
        if (opts.tooltip) {
            L10n.onL10nChange(delegate);
            $(button).tooltip({
                title: L10n.getValue(`header-${name}`),
                placement: 'bottom'
            });
        }
        addClass(button, 'action-button');
        if (opts.className) {
            addClass(button, opts.className);
        }
        if (callback) {
            listen(button, 'click', callback);
        }
        return button;
    }

    function makeL10nButton() {
        const l10nBtn = makeButton('toggleL10nButton', 'l10n', L10n.toggleL10n, btnOpts);
        function setIcon() {
            l10nBtn.style.backgroundImage = strFormat('url("./images/{0}.svg")', [getL10n('header-dictionary-icon')]);
        }
        L10n.onL10nChange(setIcon);
        setIcon();
        return l10nBtn;
    }

    function addBeforeUnloadListener() {
        window.onbeforeunload = (evt) => {
            const message = getL10n('utils-close-page-warning');
            if (typeof evt === 'undefined') {
                evt = window.event;
            }
            if (evt) {
                evt.returnValue = message;
            }
            return message;
        };
    }
    
    listen(window, 'paste', function (evt) {
        try{
            JSON.parse(evt.clipboardData.getData("text"))
        } catch(e){
            Utils.alert('Error on parsing base ' + e);
            return;
        }
        DBMS.setDatabase(JSON.parse(evt.clipboardData.getData("text")), (err) => {
            if (err) { Utils.handleError(err); return; }
            consistencyCheck(state.currentView.refresh);
        });
    });
})(this.PageManager = {});

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImpzL2RibXMvbG9jYWxEQk1TLmpzIiwiLi4vY29yZS9qcy9maWxlVXRpbHMuanMiLCIuLi9jb3JlL2pzL2wxMG4uanMiLCIuLi9jb3JlL2pzL3VpVXRpbHMuanMiLCIuLi9jb3JlL2pzL3V0aWxzLmpzIiwianMvcGFnZU1hbmFnZXIuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNuREE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ3hGQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ3RHQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUN6UkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ25aQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBIiwiZmlsZSI6InNjcmlwdHMubWluLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLypDb3B5cmlnaHQgMjAxNyBUaW1vZmV5IFJlY2hrYWxvdiA8bnRzZGtAeWFuZGV4LnJ1PlxyXG5cclxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcclxueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxyXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcclxuXHJcbmh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxyXG5cclxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxyXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXHJcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxyXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXHJcbiAgICBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4gKi9cclxuXHJcbid1c2Ugc3RyaWN0JztcclxuXHJcbmZ1bmN0aW9uIG1ha2VMb2NhbERCTVMoZnVsbFZlcnNpb24pIHtcclxuICAgIGNvbnN0IG9wdHMgPSB7XHJcbiAgICAgICAgTWlncmF0b3IsXHJcbiAgICAgICAgQ29tbW9uVXRpbHMsXHJcbiAgICAgICAgRXZlbnRFbWl0dGVyLFxyXG4gICAgICAgIFByZWNvbmRpdGlvbixcclxuICAgICAgICBSLFxyXG4gICAgICAgIEFqdixcclxuICAgICAgICBTY2hlbWEsXHJcbiAgICAgICAgRXJyb3JzLFxyXG4gICAgICAgIGxpc3RlbmVyczoge30sXHJcbiAgICAgICAgQ29uc3RhbnRzLFxyXG4gICAgICAgIGRibXNVdGlsczoge30sXHJcbiAgICAgICAgZGF0ZUZvcm1hdCxcclxuICAgIH07XHJcblxyXG4gICAgZnVuY3Rpb24gTG9jYWxEQk1TKCkge1xyXG4gICAgICAgIHRoaXMuX2luaXQob3B0cy5saXN0ZW5lcnMpO1xyXG4gICAgfVxyXG5cclxuICAgIExvY2FsREJNUy5wcm90b3R5cGUuZ2V0U2V0dGluZ3MgPSAoKSA9PiB0aGlzLmRhdGFiYXNlLlNldHRpbmdzO1xyXG5cclxuICAgIGNvbnN0IGZ1bmMgPSBuYW1lID0+IHdpbmRvd1tuYW1lXShMb2NhbERCTVMsIG9wdHMpO1xyXG5cclxuICAgIFtcclxuICAgICAgICAnYmFzZUFQSScsXHJcbiAgICAgICAgJ2NvbnNpc3RlbmN5Q2hlY2tBUEknLFxyXG4gICAgICAgIC8vICAgICAgICAnbG9nQVBJJyxcclxuICAgICAgICAvLyAgICAgICAgJ2NoYXJzaGVldEFQSScsXHJcbiAgICAgICAgLy8gICAgICAgICdzZXR0aW5nc0FQSScsXHJcbiAgICBdLm1hcChmdW5jKTtcclxuXHJcbiAgICAvLyAgICBMb2dnZXIuYXR0YWNoTG9nQ2FsbHMoTG9jYWxEQk1TLCBSLCBmYWxzZSk7XHJcbiAgICByZXR1cm4gTG9jYWxEQk1TO1xyXG59XHJcbiIsIi8qQ29weXJpZ2h0IDIwMTUtMjAxNyBUaW1vZmV5IFJlY2hrYWxvdiA8bnRzZGtAeWFuZGV4LnJ1PiwgTWFyaWEgU2lkZWtobWVub3ZhIDxtYXRpbGRhX0BsaXN0LnJ1PlxyXG5cclxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcclxueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxyXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcclxuXHJcbmh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxyXG5cclxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxyXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXHJcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxyXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXHJcbiAgICBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4gKi9cclxuXHJcbid1c2Ugc3RyaWN0JztcclxuXHJcbigoZXhwb3J0cykgPT4ge1xyXG4gICAgY29uc3Qgc3RhdGUgPSB7fTtcclxuXHJcbiAgICBleHBvcnRzLmluaXQgPSAoY2FsbGJhY2spID0+IHtcclxuICAgICAgICBzdGF0ZS5jYWxsYmFjayA9IGNhbGxiYWNrO1xyXG4gICAgfTtcclxuXHJcbiAgICBleHBvcnRzLm1ha2VOZXdCYXNlID0gKCkgPT4ge1xyXG4gICAgICAgIFV0aWxzLmNvbmZpcm0oZ2V0TDEwbigndXRpbHMtbmV3LWJhc2Utd2FybmluZycpLCAoKSA9PiB7XHJcbiAgICAgICAgICAgIERCTVMuc2V0RGF0YWJhc2UoQ29tbW9uVXRpbHMuY2xvbmUoRW1wdHlCYXNlLmRhdGEpLCBzdGF0ZS5jYWxsYmFjayk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG5cclxuICAgIGV4cG9ydHMub3BlbkhlbHAgPSAoKSA9PiB7XHJcbiAgICAgICAgd2luZG93Lm9wZW4oJ2V4dHJhcy9kb2Mvbmltcy5odG1sJyk7XHJcbiAgICB9O1xyXG5cclxuICAgIGV4cG9ydHMucmVhZFNpbmdsZUZpbGUgPSAoZXZ0KSA9PiB7XHJcbiAgICAgICAgLy8gUmV0cmlldmUgdGhlIGZpcnN0IChhbmQgb25seSEpIEZpbGUgZnJvbSB0aGUgRmlsZUxpc3Qgb2JqZWN0XHJcbiAgICAgICAgY29uc3QgZiA9IGV2dC50YXJnZXQuZmlsZXNbMF07XHJcblxyXG4gICAgICAgIGlmIChmKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHIgPSBuZXcgRmlsZVJlYWRlcigpO1xyXG4gICAgICAgICAgICByLm9ubG9hZCA9IChlKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBjb250ZW50cyA9IGUudGFyZ2V0LnJlc3VsdDtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGRhdGFiYXNlID0gSlNPTi5wYXJzZShjb250ZW50cyk7XHJcbiAgICAgICAgICAgICAgICBEQk1TLnNldERhdGFiYXNlKGRhdGFiYXNlLCBzdGF0ZS5jYWxsYmFjayk7XHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIHIucmVhZEFzVGV4dChmKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBVdGlscy5hbGVydChnZXRMMTBuKCd1dGlscy1iYXNlLWZpbGUtbG9hZGluZy1lcnJvcicpKTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG5cclxuICAgIGV4cG9ydHMuc2F2ZUZpbGUgPSAoKSA9PiB7XHJcbiAgICAgICAgREJNUy5nZXREYXRhYmFzZSgoZXJyLCBkYXRhYmFzZSkgPT4ge1xyXG4gICAgICAgICAgICBpZiAoZXJyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycik7IHJldHVybjsgfVxyXG4gICAgICAgICAgICBleHBvcnRzLmpzb24yRmlsZShkYXRhYmFzZSwgYCR7QkFTRV9GSUxFX05BTUV9Lmpzb25gKTtcclxuICAgICAgICB9KTtcclxuICAgIH07XHJcblxyXG4gICAgZXhwb3J0cy5qc29uMkZpbGUgPSAoc3RyLCBmaWxlTmFtZSkgPT4ge1xyXG4gICAgICAgIGV4cG9ydHMuc3RyMkZpbGUoSlNPTi5zdHJpbmdpZnkoc3RyLCBudWxsLCAnICAnKSwgZmlsZU5hbWUpO1xyXG4gICAgfTtcclxuXHJcbiAgICBleHBvcnRzLnN0cjJGaWxlID0gKHN0ciwgZmlsZU5hbWUpID0+IHtcclxuICAgICAgICBjb25zdCBibG9iID0gbmV3IEJsb2IoW3N0cl0sIHtcclxuICAgICAgICAgICAgdHlwZTogJ3RleHQvcGxhaW47Y2hhcnNldD11dGYtOCdcclxuICAgICAgICB9KTtcclxuICAgICAgICBzYXZlQXMoYmxvYiwgZmlsZU5hbWUpO1xyXG4gICAgfTtcclxuXHJcbiAgICBmdW5jdGlvbiBwcmVwcm9jZXNzQ3N2U3RyKHN0cikge1xyXG4gICAgICAgIGlmICghKHR5cGVvZiBzdHIgPT09ICdzdHJpbmcnIHx8IHN0ciBpbnN0YW5jZW9mIFN0cmluZykpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHN0cjtcclxuICAgICAgICB9XHJcbiAgICAgICAgbGV0IHJlc3VsdCA9IHN0ci5yZXBsYWNlKC9cIi9nLCAnXCJcIicpO1xyXG4gICAgICAgIGlmIChyZXN1bHQuc2VhcmNoKC8oXCJ8LHxcXG4pL2cpID49IDApIHtcclxuICAgICAgICAgICAgcmVzdWx0ID0gYFwiJHtyZXN1bHR9XCJgO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gcmVzdWx0O1xyXG4gICAgfVxyXG5cclxuICAgIGV4cG9ydHMuYXJyMmQyQ3N2ID0gKGFyciwgZmlsZU5hbWUpID0+IHtcclxuICAgICAgICBjb25zdCBjc3YgPSBgXFx1ZmVmZiR7YXJyLm1hcChkYXRhQXJyYXkgPT4gZGF0YUFycmF5Lm1hcChwcmVwcm9jZXNzQ3N2U3RyKS5qb2luKCc7JykpLmpvaW4oJ1xcbicpfWA7XHJcblxyXG4gICAgICAgIGNvbnN0IG91dCA9IG5ldyBCbG9iKFtjc3ZdLCB7XHJcbiAgICAgICAgICAgIHR5cGU6ICd0ZXh0L2NzdjtjaGFyc2V0PXV0Zi04OydcclxuICAgICAgICB9KTtcclxuICAgICAgICBzYXZlQXMob3V0LCAndGFibGUuY3N2Jyk7XHJcbiAgICB9O1xyXG59KSh0aGlzLkZpbGVVdGlscyA9IHt9KTtcclxuIiwiLypDb3B5cmlnaHQgMjAxNS0yMDE3IFRpbW9mZXkgUmVjaGthbG92IDxudHNka0B5YW5kZXgucnU+LCBNYXJpYSBTaWRla2htZW5vdmEgPG1hdGlsZGFfQGxpc3QucnU+XHJcblxyXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xyXG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXHJcbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxyXG5cclxuaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXHJcblxyXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXHJcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcclxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXHJcblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcclxuICAgIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLiAqL1xyXG5cclxuJ3VzZSBzdHJpY3QnO1xyXG5cclxuLyogZXNsaW50LWRpc2FibGUgbm8tdmFyLHZhcnMtb24tdG9wICovXHJcblxyXG4oKGV4cG9ydHMsIERpY3Rpb25hcmllcykgPT4ge1xyXG4gICAgY29uc3Qgc3RhdGUgPSB7fTtcclxuXHJcbiAgICBzdGF0ZS5pbml0aWFsaXplZCA9IGZhbHNlO1xyXG4gICAgc3RhdGUubDEwbkRlbGVnYXRlcyA9IFtdO1xyXG4gICAgc3RhdGUuZGljdGlvbmFyaWVzID0ge307XHJcbiAgICBzdGF0ZS5sYW5nID0gZGVmYXVsdExhbmc7XHJcblxyXG4gICAgY29uc3QgaW5pdCA9ICgpID0+IHtcclxuICAgICAgICBpZiAoc3RhdGUuaW5pdGlhbGl6ZWQpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyAgICAgICAgY29uc29sZS5sb2cobmF2aWdhdG9yLmxhbmd1YWdlKTtcclxuXHJcbiAgICAgICAgc3RhdGUuZGljdGlvbmFyaWVzID0gUi5tYXAocHJvY2Vzc0RpY3Rpb25hcnksIERpY3Rpb25hcmllcyk7XHJcblxyXG4gICAgICAgIC8vICAgIHZhciBsYW5nID0gKG5hdmlnYXRvci5sYW5ndWFnZXMgPyBuYXZpZ2F0b3IubGFuZ3VhZ2VzWzBdIDogbmF2aWdhdG9yLmJyb3dzZXJMYW5ndWFnZSkuc3BsaXQoJy0nKVswXTtcclxuICAgICAgICAvLyAgICB2YXIgbGFuZyA9ICdydSc7XHJcbiAgICAgICAgLy8gICAgICAgIHZhciBsYW5nID0gZGVmYXVsdExhbmc7XHJcbiAgICAgICAgLy8gICAgICAgIGNvbnNvbGUubG9nKGxhbmcpO1xyXG5cclxuICAgICAgICBpZiAoc3RhdGUuZGljdGlvbmFyaWVzW2RlZmF1bHRMYW5nXSkge1xyXG4gICAgICAgICAgICBzdGF0ZS5kaWN0ID0gc3RhdGUuZGljdGlvbmFyaWVzW2RlZmF1bHRMYW5nXTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBzdGF0ZS5kaWN0ID0gc3RhdGUuZGljdGlvbmFyaWVzLmVuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBzZXRIdG1sTGFuZyhkZWZhdWx0TGFuZyk7XHJcbiAgICAgICAgZXhwb3J0cy5vbkwxMG5DaGFuZ2UoZXhwb3J0cy5sb2NhbGl6ZVN0YXRpYyk7XHJcbiAgICAgICAgc3RhdGUuaW5pdGlhbGl6ZWQgPSB0cnVlO1xyXG4gICAgfTtcclxuXHJcbiAgICB2YXIgcHJvY2Vzc0RpY3Rpb25hcnkgPSAoZGljdGlvbmFyeSkgPT4ge1xyXG4gICAgICAgIGNvbnN0IHByb2Nlc3NlZERpY3Rpb25hcnkgPSB7fTtcclxuICAgICAgICBSLnRvUGFpcnMoZGljdGlvbmFyeSkuZm9yRWFjaCgoW3NlY3Rpb25OYW1lLCBzZWN0aW9uXSkgPT4ge1xyXG4gICAgICAgICAgICBSLnRvUGFpcnMoc2VjdGlvbikuZm9yRWFjaCgoW2tleSwgdmFsdWVdKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBwcm9jZXNzZWREaWN0aW9uYXJ5W2Ake3NlY3Rpb25OYW1lfS0ke2tleX1gXSA9IHZhbHVlO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuICAgICAgICAvLyAgICAgICAgZm9yIChjb25zdCBzZWN0aW9uTmFtZSBpbiBkaWN0aW9uYXJ5KSB7XHJcbiAgICAgICAgLy8gICAgICAgICAgICBmb3IgKGNvbnN0IG5hbWUgaW4gZGljdGlvbmFyeVtzZWN0aW9uTmFtZV0pIHtcclxuICAgICAgICAvLyAgICAgICAgICAgICAgICBwcm9jZXNzZWREaWN0aW9uYXJ5W2Ake3NlY3Rpb25OYW1lfS0ke25hbWV9YF0gPSBkaWN0aW9uYXJ5W3NlY3Rpb25OYW1lXVtuYW1lXTtcclxuICAgICAgICAvLyAgICAgICAgICAgIH1cclxuICAgICAgICAvLyAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBwcm9jZXNzZWREaWN0aW9uYXJ5O1xyXG4gICAgfTtcclxuXHJcbiAgICB2YXIgc2V0SHRtbExhbmcgPSBsYW5nID0+IHNldEF0dHIoZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2h0bWwnKVswXSwgJ2xhbmcnLCBsYW5nKTtcclxuXHJcbiAgICBleHBvcnRzLnRvZ2dsZUwxMG4gPSAoKSA9PiB7XHJcbiAgICAgICAgaWYgKHN0YXRlLmxhbmcgPT09ICdydScpIHtcclxuICAgICAgICAgICAgc3RhdGUuZGljdCA9IHN0YXRlLmRpY3Rpb25hcmllcy5lbjtcclxuICAgICAgICAgICAgc3RhdGUubGFuZyA9ICdlbic7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgc3RhdGUuZGljdCA9IHN0YXRlLmRpY3Rpb25hcmllcy5ydTtcclxuICAgICAgICAgICAgc3RhdGUubGFuZyA9ICdydSc7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHNldEh0bWxMYW5nKHN0YXRlLmxhbmcpO1xyXG4gICAgICAgIHN0YXRlLmwxMG5EZWxlZ2F0ZXMuZm9yRWFjaCgoZGVsZWdhdGUpID0+IHtcclxuICAgICAgICAgICAgZGVsZWdhdGUoKTtcclxuICAgICAgICB9KTtcclxuICAgIH07XHJcblxyXG4gICAgZXhwb3J0cy5nZXRMYW5nID0gKCkgPT4gc3RhdGUubGFuZy50b0xvd2VyQ2FzZSgpO1xyXG5cclxuICAgIGV4cG9ydHMuZm9ybWF0ID0gUi5jdXJyeSgobmFtZXNwYWNlLCBuYW1lLCBhcmdzKSA9PiBzdHJGb3JtYXQoZXhwb3J0cy5nZXQobmFtZXNwYWNlLCBuYW1lKSwgYXJncykpO1xyXG5cclxuICAgIGV4cG9ydHMuZ2V0ID0gUi5jdXJyeSgobmFtZXNwYWNlLCBuYW1lKSA9PiBMMTBuLmdldFZhbHVlKGAke25hbWVzcGFjZX0tJHtuYW1lfWApKTtcclxuXHJcbiAgICBleHBvcnRzLmdldFZhbHVlID0gKG5hbWUpID0+IHtcclxuICAgICAgICBjb25zdCB2YWx1ZSA9IHN0YXRlLmRpY3RbbmFtZV07XHJcbiAgICAgICAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQpIGNvbnNvbGUubG9nKGBWYWx1ZSBpcyBub3QgZm91bmQ6ICR7bmFtZX1gKTtcclxuICAgICAgICByZXR1cm4gdmFsdWUgfHwgYCR7bmFtZX06UkEgUkEtQUgtQUgtQUggUk9NQSBST01BLU1BIEdBR0EgT0ggTEEtTEFgO1xyXG4gICAgfTtcclxuXHJcbiAgICBleHBvcnRzLm9uTDEwbkNoYW5nZSA9IChkZWxlZ2F0ZSkgPT4ge1xyXG4gICAgICAgIHN0YXRlLmwxMG5EZWxlZ2F0ZXMucHVzaChkZWxlZ2F0ZSk7XHJcbiAgICB9O1xyXG5cclxuICAgIGV4cG9ydHMubG9jYWxpemVTdGF0aWMgPSAoKSA9PiB7XHJcbiAgICAgICAgaW5pdCgpO1xyXG4gICAgICAgIG5sMmFycmF5KGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJ1tsMTBuLWlkXScpKS5tYXAoZWwgPT4gYWRkRWwoY2xlYXJFbChlbCksIG1ha2VUZXh0KGV4cG9ydHMuZ2V0VmFsdWUoZ2V0QXR0cihlbCwgJ2wxMG4taWQnKSkpKSk7XHJcbiAgICAgICAgbmwyYXJyYXkoZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnW2wxMG4tcGxhY2Vob2xkZXItaWRdJykpLm1hcChlbCA9PiBzZXRBdHRyKGVsLCAncGxhY2Vob2xkZXInLCBleHBvcnRzLmdldFZhbHVlKGdldEF0dHIoZWwsICdsMTBuLXBsYWNlaG9sZGVyLWlkJykpKSk7XHJcbiAgICB9O1xyXG59KSh0aGlzLkwxMG4gPSB7fSwgRGljdGlvbmFyaWVzKTtcclxuIiwiLypDb3B5cmlnaHQgMjAxNS0yMDE3IFRpbW9mZXkgUmVjaGthbG92IDxudHNka0B5YW5kZXgucnU+LCBNYXJpYSBTaWRla2htZW5vdmEgPG1hdGlsZGFfQGxpc3QucnU+XHJcblxyXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xyXG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXHJcbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxyXG5cclxuaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXHJcblxyXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXHJcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcclxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXHJcblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcclxuICAgIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLiAqL1xyXG5cclxuJ3VzZSBzdHJpY3QnO1xyXG5cclxuLyogZXNsaW50LWRpc2FibGUgbm8tdmFyLHZhcnMtb24tdG9wICovXHJcblxyXG4oKGV4cG9ydHMpID0+IHtcclxuICAgIGV4cG9ydHMuaW5pdFRhYlBhbmVsID0gKHRhYkNsYXp6LCBjb250YWluZXJDbGF6eikgPT4ge1xyXG4gICAgICAgIGNvbnN0IGNvbnRhaW5lcnMgPSBnZXRFbHMoY29udGFpbmVyQ2xhenopO1xyXG5cclxuICAgICAgICBsZXQgaTtcclxuICAgICAgICBmb3IgKGkgPSAxOyBpIDwgY29udGFpbmVycy5sZW5ndGg7IGkrKykgeyAvLyBkb24ndCBoaWRlIDFzdCBlbGVtZW50XHJcbiAgICAgICAgICAgIGFkZENsYXNzKGNvbnRhaW5lcnNbaV0sICdoaWRkZW4nKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IHRhYkJ1dHRvbnMgPSBnZXRFbHModGFiQ2xhenopO1xyXG5cclxuICAgICAgICBhZGRDbGFzcyh0YWJCdXR0b25zWzBdLCAnYWN0aXZlJyk7XHJcblxyXG4gICAgICAgIGZvciAoaSA9IDA7IGkgPCB0YWJCdXR0b25zLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgIGxpc3Rlbih0YWJCdXR0b25zW2ldLCAnY2xpY2snLCB0YWJCdXR0b25DbGljayh0YWJCdXR0b25zLCBjb250YWluZXJzKSk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuXHJcbiAgICB2YXIgdGFiQnV0dG9uQ2xpY2sgPSAoYnV0dG9ucywgY29udGFpbmVycykgPT4gKGV2ZW50KSA9PiB7XHJcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBidXR0b25zLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgIHNldENsYXNzQnlDb25kaXRpb24oYnV0dG9uc1tpXSwgJ2FjdGl2ZScsIGV2ZW50LnRhcmdldC5pZCA9PT0gYnV0dG9uc1tpXS5pZCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY29udGFpbmVycy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICBzZXRDbGFzc0J5Q29uZGl0aW9uKGNvbnRhaW5lcnNbaV0sICdoaWRkZW4nLCBgJHtldmVudC50YXJnZXQuaWR9Q29udGFpbmVyYCAhPT0gY29udGFpbmVyc1tpXS5pZCk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuXHJcbiAgICBleHBvcnRzLmZpbGxTaG93SXRlbVNlbGVjdG9yID0gKHNlbGVjdG9yLCBkaXNwbGF5QXJyYXkpID0+IHtcclxuICAgICAgICBsZXQgZWw7XHJcbiAgICAgICAgc2V0QXR0cihzZWxlY3RvciwgJ3NpemUnLCBkaXNwbGF5QXJyYXkubGVuZ3RoKTtcclxuICAgICAgICBkaXNwbGF5QXJyYXkuZm9yRWFjaCgodmFsdWUpID0+IHtcclxuICAgICAgICAgICAgZWwgPSBzZXRQcm9wcyhtYWtlRWwoJ29wdGlvbicpLCB7XHJcbiAgICAgICAgICAgICAgICBzZWxlY3RlZDogdHJ1ZSxcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIHNldENsYXNzQnlDb25kaXRpb24oZWwsICdoaWRkZW4nLCB2YWx1ZS5oaWRkZW4pO1xyXG4gICAgICAgICAgICBhZGRFbChzZWxlY3RvciwgYWRkRWwoZWwsIG1ha2VUZXh0KHZhbHVlLm5hbWUpKSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG5cclxuICAgIGV4cG9ydHMuZmlsbFNob3dJdGVtU2VsZWN0b3IyID0gKHNlbGVjdG9yLCBvcHRpb25Hcm91cHMpID0+IHtcclxuICAgICAgICBsZXQgZWwsIGdyb3VwRWwsIGNvdW50ZXIgPSAwO1xyXG4gICAgICAgIGFkZEVscyhzZWxlY3Rvciwgb3B0aW9uR3JvdXBzLm1hcCgoZ3JvdXApID0+IHtcclxuICAgICAgICAgICAgY291bnRlcisrO1xyXG4gICAgICAgICAgICBncm91cEVsID0gc2V0QXR0cihtYWtlRWwoJ29wdGdyb3VwJyksICdsYWJlbCcsIGdyb3VwLm5hbWUpO1xyXG4gICAgICAgICAgICBhZGRFbHMoZ3JvdXBFbCwgZ3JvdXAuYXJyYXkubWFwKCh2YWx1ZSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgZWwgPSBzZXRQcm9wcyhtYWtlRWwoJ29wdGlvbicpLCB7XHJcbiAgICAgICAgICAgICAgICAgICAgc2VsZWN0ZWQ6IHRydWUsXHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIHNldENsYXNzQnlDb25kaXRpb24oZWwsICdoaWRkZW4nLCB2YWx1ZS5oaWRkZW4pO1xyXG4gICAgICAgICAgICAgICAgY291bnRlciArPSAodmFsdWUuaGlkZGVuID8gMCA6IDEpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGFkZEVsKGVsLCBtYWtlVGV4dCh2YWx1ZS5uYW1lKSk7XHJcbiAgICAgICAgICAgIH0pKTtcclxuICAgICAgICAgICAgcmV0dXJuIGdyb3VwRWw7XHJcbiAgICAgICAgfSkpO1xyXG4gICAgICAgIHNldEF0dHIoc2VsZWN0b3IsICdzaXplJywgY291bnRlcik7XHJcbiAgICB9O1xyXG5cclxuICAgIGV4cG9ydHMuc2hvd1NlbGVjdGVkRWxzID0gY2xhc3NLZXkgPT4gKGV2ZW50KSA9PiB7XHJcbiAgICAgICAgY29uc3QgZWwgPSBldmVudC50YXJnZXQ7XHJcbiAgICAgICAgbGV0IGVscywgaSwgajtcclxuICAgICAgICBmb3IgKGkgPSAwOyBpIDwgZWwub3B0aW9ucy5sZW5ndGg7IGkgKz0gMSkge1xyXG4gICAgICAgICAgICBlbHMgPSBnZXRFbHMoaSArIGNsYXNzS2V5KTtcclxuICAgICAgICAgICAgZm9yIChqID0gMDsgaiA8IGVscy5sZW5ndGg7IGorKykge1xyXG4gICAgICAgICAgICAgICAgc2V0Q2xhc3NCeUNvbmRpdGlvbihlbHNbal0sICdoaWRkZW4nLCAhZWwub3B0aW9uc1tpXS5zZWxlY3RlZCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9O1xyXG5cclxuICAgIGV4cG9ydHMuaW5pdFNlbGVjdG9yRmlsdGVycyA9ICgpID0+IHtcclxuICAgICAgICBjb25zdCBlbGVtcyA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJ1tzZWxlY3Rvci1maWx0ZXJdJyk7XHJcbiAgICAgICAgbGV0IGVsLCBzZWw7XHJcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBlbGVtcy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICBlbCA9IGVsZW1zW2ldO1xyXG4gICAgICAgICAgICBzZWwgPSBxdWVyeUVsKGdldEF0dHIoZWwsICdzZWxlY3Rvci1maWx0ZXInKSk7XHJcbiAgICAgICAgICAgIGVsLnZhbHVlID0gJyc7XHJcbiAgICAgICAgICAgIGxpc3RlbihlbCwgJ2lucHV0JywgZmlsdGVyT3B0aW9ucyhzZWwpKTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG5cclxuICAgIHZhciBmaWx0ZXJPcHRpb25zID0gc2VsID0+IChldmVudCkgPT4ge1xyXG4gICAgICAgIGxldCB2YWwgPSBldmVudC50YXJnZXQudmFsdWU7XHJcbiAgICAgICAgbGV0IGksIG9wdDtcclxuICAgICAgICB2YWwgPSBDb21tb25VdGlscy5nbG9iU3RyaW5nVG9SZWdleCh2YWwudHJpbSgpLnRvTG93ZXJDYXNlKCkpO1xyXG4gICAgICAgIGZvciAoaSA9IDA7IGkgPCBzZWwub3B0aW9ucy5sZW5ndGg7IGkgKz0gMSkge1xyXG4gICAgICAgICAgICBvcHQgPSBzZWwub3B0aW9uc1tpXTtcclxuICAgICAgICAgICAgY29uc3QgaXNWaXNpYmxlID0gb3B0LmlubmVySFRNTC50b0xvd2VyQ2FzZSgpLnNlYXJjaCh2YWwpICE9PSAtMTtcclxuICAgICAgICAgICAgaWYgKCFpc1Zpc2libGUpIHtcclxuICAgICAgICAgICAgICAgIG9wdC5zZWxlY3RlZCA9IGZhbHNlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHNldENsYXNzQnlDb25kaXRpb24ob3B0LCAnaGlkZGVuJywgIWlzVmlzaWJsZSk7XHJcbiAgICAgICAgICAgIC8vICAgICAgICAgICAgICAgIHNldENsYXNzQnlDb25kaXRpb24ob3B0LCBcImhpZGRlblwiLCBvcHQuaW5uZXJIVE1MLnRvTG93ZXJDYXNlKCkuc2VhcmNoKHZhbCkgPT09IC0xKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgc2VsLmRpc3BhdGNoRXZlbnQobmV3IEV2ZW50KCdjaGFuZ2UnKSk7XHJcbiAgICB9O1xyXG5cclxuICAgIGV4cG9ydHMuaW5pdFBhbmVsVG9nZ2xlcnMgPSAoKSA9PiB7XHJcbiAgICAgICAgY29uc3QgZWxlbXMgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCdbcGFuZWwtdG9nZ2xlcl0nKTtcclxuICAgICAgICBsZXQgZWwsIHNlbCwgYXR0cjtcclxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGVsZW1zLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgIGVsID0gZWxlbXNbaV07XHJcbiAgICAgICAgICAgIGF0dHIgPSBnZXRBdHRyKGVsLCAncGFuZWwtdG9nZ2xlcicpO1xyXG4gICAgICAgICAgICBzZWwgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGF0dHIpO1xyXG4gICAgICAgICAgICBpZiAoc2VsID09IG51bGwpIHtcclxuICAgICAgICAgICAgICAgIFV0aWxzLmFsZXJ0KGBQYW5lbCB0b2dnbGVyIGlzIGJyb2tlbjogJHthdHRyfWApO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGxpc3RlbihlbCwgJ2NsaWNrJywgZXhwb3J0cy50b2dnbGVQYW5lbChzZWwpKTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG5cclxuICAgIGV4cG9ydHMudG9nZ2xlUGFuZWwgPSBzZWwgPT4gKGV2ZW50KSA9PiB7XHJcbiAgICAgICAgdG9nZ2xlQ2xhc3Moc2VsLCAnaGlkZGVuJyk7XHJcbiAgICB9O1xyXG5cclxuICAgIGV4cG9ydHMubWFrZUV2ZW50VGltZVBpY2tlciA9IChvcHRzKSA9PiB7XHJcbiAgICAgICAgY29uc3QgaW5wdXQgPSBtYWtlRWwoJ2lucHV0Jyk7XHJcbiAgICAgICAgUi5hcChbYWRkQ2xhc3MoaW5wdXQpXSwgb3B0cy5leHRyYUNsYXNzZXMpO1xyXG4gICAgICAgIGFkZENsYXNzKGlucHV0LCAnZXZlbnRUaW1lJyk7XHJcbiAgICAgICAgaW5wdXQudmFsdWUgPSBvcHRzLmV2ZW50VGltZTtcclxuXHJcbiAgICAgICAgaW5wdXQuZXZlbnRJbmRleCA9IG9wdHMuaW5kZXg7XHJcblxyXG4gICAgICAgIGNvbnN0IHBpY2tlck9wdHMgPSB7XHJcbiAgICAgICAgICAgIGxhbmc6IEwxMG4uZ2V0TGFuZygpLFxyXG4gICAgICAgICAgICBtYXNrOiB0cnVlLFxyXG4gICAgICAgICAgICBzdGFydERhdGU6IG5ldyBEYXRlKG9wdHMucHJlR2FtZURhdGUpLFxyXG4gICAgICAgICAgICBlbmREYXRlOiBuZXcgRGF0ZShvcHRzLmRhdGUpLFxyXG4gICAgICAgICAgICBvbkNoYW5nZURhdGVUaW1lOiBvcHRzLm9uQ2hhbmdlRGF0ZVRpbWVDcmVhdG9yKGlucHV0KSxcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICBpZiAob3B0cy5ldmVudFRpbWUgIT09ICcnKSB7XHJcbiAgICAgICAgICAgIHBpY2tlck9wdHMudmFsdWUgPSBvcHRzLmV2ZW50VGltZTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBwaWNrZXJPcHRzLnZhbHVlID0gb3B0cy5kYXRlO1xyXG4gICAgICAgICAgICBhZGRDbGFzcyhpbnB1dCwgJ2RlZmF1bHREYXRlJyk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBqUXVlcnkoaW5wdXQpLmRhdGV0aW1lcGlja2VyKHBpY2tlck9wdHMpO1xyXG4gICAgICAgIHJldHVybiBpbnB1dDtcclxuICAgIH07XHJcblxyXG4gICAgLy8gYnVnIGFib3V0IHNldHRpbmcgMDkwMCB5ZWFycyBpbiBCcmFhdm9zIGdhbWUgaXMgZXZlbnQgZGF0ZS4gRml4ZWQgaW4gcHJvZHVjdGlvbi5cclxuICAgIC8vICBleHBvcnRzLm1ha2VFdmVudFRpbWVQaWNrZXIgPSBmdW5jdGlvbiAob3B0cykge1xyXG4gICAgLy8gICAgICB2YXIgaW5wdXQgPSBtYWtlRWwoXCJpbnB1dFwiKTtcclxuICAgIC8vICAgICAgUi5hcChbYWRkQ2xhc3MoaW5wdXQpXSwgb3B0cy5leHRyYUNsYXNzZXMpO1xyXG4gICAgLy8gICAgICBhZGRDbGFzcyhpbnB1dCwgXCJldmVudFRpbWVcIik7XHJcbiAgICAvLyAgICAgIGlucHV0LnZhbHVlID0gb3B0cy5ldmVudFRpbWU7XHJcbiAgICAvL1xyXG4gICAgLy8gICAgICBpbnB1dC5ldmVudEluZGV4ID0gb3B0cy5pbmRleDtcclxuICAgIC8vXHJcbiAgICAvLyAgICAgIHZhciBwaWNrZXJPcHRzID0ge1xyXG4gICAgLy8gICAgICAgICAgbGFuZyA6IEwxMG4uZ2V0TGFuZygpLFxyXG4gICAgLy8gICAgICAgICAgbWFzayA6IHRydWUsXHJcbiAgICAvLyAgICAgICAgICBzdGFydERhdGUgOiBuZXcgRGF0ZShvcHRzLnByZUdhbWVEYXRlKSxcclxuICAgIC8vICAgICAgICAgIGVuZERhdGUgOiBuZXcgRGF0ZShvcHRzLmRhdGUpLFxyXG4gICAgLy8gICAgICAgICAgb25DaGFuZ2VEYXRlVGltZSA6IG9wdHMub25DaGFuZ2VEYXRlVGltZUNyZWF0b3IoaW5wdXQpLFxyXG4gICAgLy8gICAgICB9O1xyXG4gICAgLy9cclxuICAgIC8vICAgICAgdmFyIHBpY2tlciA9IGpRdWVyeShpbnB1dCkuZGF0ZXRpbWVwaWNrZXIocGlja2VyT3B0cyk7XHJcbiAgICAvL1xyXG4gICAgLy8gICAgICB2YXIgdmFsdWU7XHJcbiAgICAvLyAgICAgIGlmIChvcHRzLmV2ZW50VGltZSAhPT0gXCJcIikge1xyXG4gICAgLy8gICAgICAgICAgdmFsdWUgPSBuZXcgRGF0ZShvcHRzLmV2ZW50VGltZSk7XHJcbiAgICAvLyAgICAgIH0gZWxzZSB7XHJcbiAgICAvLyAgICAgICAgICB2YWx1ZSA9IG9wdHMuZGF0ZTtcclxuICAgIC8vICAgICAgICAgIGFkZENsYXNzKGlucHV0LCBcImRlZmF1bHREYXRlXCIpO1xyXG4gICAgLy8gICAgICB9XHJcbiAgICAvL1xyXG4gICAgLy8gICAgICBwaWNrZXIudmFsdWUgPSB2YWx1ZTtcclxuICAgIC8vXHJcbiAgICAvL1xyXG4gICAgLy8gICAgICByZXR1cm4gaW5wdXQ7XHJcbiAgICAvLyAgfTtcclxuXHJcbiAgICBleHBvcnRzLnJlc2l6ZVRleHRhcmVhID0gKGV2KSA9PiB7XHJcbiAgICAgICAgY29uc3QgdGhhdCA9IGV2LnRhcmdldDtcclxuICAgICAgICB0aGF0LnN0eWxlLmhlaWdodCA9ICcyNHB4JztcclxuICAgICAgICB0aGF0LnN0eWxlLmhlaWdodCA9IGAke3RoYXQuc2Nyb2xsSGVpZ2h0ICsgMTJ9cHhgO1xyXG4gICAgfTtcclxuXHJcbiAgICBleHBvcnRzLnJlc2l6ZVRleHRhcmVhMiA9ICh0aGF0KSA9PiB7XHJcbiAgICAgICAgdGhhdC5zdHlsZS5oZWlnaHQgPSAnMjRweCc7XHJcbiAgICAgICAgdGhhdC5zdHlsZS5oZWlnaHQgPSBgJHt0aGF0LnNjcm9sbEhlaWdodCArIDEyfXB4YDtcclxuICAgIH07XHJcblxyXG4gICAgZXhwb3J0cy5tYWtlQWRhcHRhdGlvblRpbWVJbnB1dCA9IChzdG9yeU5hbWUsIGV2ZW50LCBjaGFyYWN0ZXJOYW1lLCBpc0VkaXRhYmxlKSA9PiB7XHJcbiAgICAgICAgY29uc3QgaW5wdXQgPSBtYWtlRWwoJ2lucHV0Jyk7XHJcbiAgICAgICAgc2V0Q2xhc3NCeUNvbmRpdGlvbihpbnB1dCwgJ25vdEVkaXRhYmxlJywgIWlzRWRpdGFibGUpO1xyXG4gICAgICAgIGFkZENsYXNzKGlucHV0LCAnYWRhcHRhdGlvblRpbWVJbnB1dCcpO1xyXG4gICAgICAgIGlucHV0LnZhbHVlID0gZXZlbnQuY2hhcmFjdGVyc1tjaGFyYWN0ZXJOYW1lXS50aW1lO1xyXG4gICAgICAgIGlucHV0LmRhdGFLZXkgPSBKU09OLnN0cmluZ2lmeShbc3RvcnlOYW1lLCBldmVudC5pbmRleCwgY2hhcmFjdGVyTmFtZV0pO1xyXG4gICAgICAgIGxpc3RlbihpbnB1dCwgJ2NoYW5nZScsIG9uQ2hhbmdlUGVyc29uYWxUaW1lRGVsZWdhdGUpO1xyXG4gICAgICAgIHJldHVybiBpbnB1dDtcclxuICAgIH07XHJcblxyXG4gICAgdmFyIG9uQ2hhbmdlUGVyc29uYWxUaW1lRGVsZWdhdGUgPSAoZXZlbnQpID0+IHtcclxuICAgICAgICBjb25zdCBkYXRhS2V5ID0gSlNPTi5wYXJzZShldmVudC50YXJnZXQuZGF0YUtleSk7XHJcbiAgICAgICAgY29uc3QgdGltZSA9IGV2ZW50LnRhcmdldC52YWx1ZTtcclxuICAgICAgICBEQk1TLnNldEV2ZW50QWRhcHRhdGlvblByb3BlcnR5KGRhdGFLZXlbMF0sIGRhdGFLZXlbMV0sIGRhdGFLZXlbMl0sICd0aW1lJywgdGltZSwgVXRpbHMucHJvY2Vzc0Vycm9yKCkpO1xyXG4gICAgfTtcclxuXHJcbiAgICBleHBvcnRzLm1ha2VBZGFwdGF0aW9uUmVhZHlJbnB1dCA9IChzdG9yeU5hbWUsIGV2ZW50LCBjaGFyYWN0ZXJOYW1lLCBpc0VkaXRhYmxlKSA9PiB7XHJcbiAgICAgICAgY29uc3QgZGl2ID0gbWFrZUVsKCdkaXYnKTtcclxuICAgICAgICBjb25zdCBpbnB1dCA9IG1ha2VFbCgnaW5wdXQnKTtcclxuICAgICAgICBzZXRDbGFzc0J5Q29uZGl0aW9uKGlucHV0LCAnbm90RWRpdGFibGUnLCAhaXNFZGl0YWJsZSk7XHJcbiAgICAgICAgaW5wdXQudHlwZSA9ICdjaGVja2JveCc7XHJcbiAgICAgICAgaW5wdXQuY2hlY2tlZCA9IGV2ZW50LmNoYXJhY3RlcnNbY2hhcmFjdGVyTmFtZV0ucmVhZHk7XHJcbiAgICAgICAgaW5wdXQuZGF0YUtleSA9IEpTT04uc3RyaW5naWZ5KFtzdG9yeU5hbWUsIGV2ZW50LmluZGV4LCBjaGFyYWN0ZXJOYW1lXSk7XHJcbiAgICAgICAgaW5wdXQuaWQgPSBgJHtldmVudC5pbmRleH0tJHtzdG9yeU5hbWV9LSR7Y2hhcmFjdGVyTmFtZX1gO1xyXG4gICAgICAgIGxpc3RlbihpbnB1dCwgJ2NoYW5nZScsIG9uQ2hhbmdlUmVhZHlTdGF0dXMpO1xyXG4gICAgICAgIGFkZEVsKGRpdiwgaW5wdXQpO1xyXG5cclxuICAgICAgICBhZGRFbChkaXYsIHNldEF0dHIoYWRkRWwobWFrZUVsKCdsYWJlbCcpLCBtYWtlVGV4dChjb25zdEwxMG4oQ29uc3RhbnRzLmZpbmlzaGVkVGV4dCkpKSwgJ2ZvcicsIGlucHV0LmlkKSk7XHJcbiAgICAgICAgcmV0dXJuIGRpdjtcclxuICAgIH07XHJcblxyXG4gICAgdmFyIG9uQ2hhbmdlUmVhZHlTdGF0dXMgPSAoZXZlbnQpID0+IHtcclxuICAgICAgICBjb25zdCBkYXRhS2V5ID0gSlNPTi5wYXJzZShldmVudC50YXJnZXQuZGF0YUtleSk7XHJcbiAgICAgICAgY29uc3QgdmFsdWUgPSBldmVudC50YXJnZXQuY2hlY2tlZDtcclxuICAgICAgICBEQk1TLnNldEV2ZW50QWRhcHRhdGlvblByb3BlcnR5KGRhdGFLZXlbMF0sIGRhdGFLZXlbMV0sIGRhdGFLZXlbMl0sICdyZWFkeScsIHZhbHVlLCBVdGlscy5wcm9jZXNzRXJyb3IoKSk7XHJcbiAgICB9O1xyXG5cclxuICAgIGV4cG9ydHMubWFrZVBhbmVsQ29yZSA9ICh0aXRsZSwgY29udGVudCkgPT4ge1xyXG4gICAgICAgIGNvbnN0IHBhbmVsID0gYWRkQ2xhc3NlcyhtYWtlRWwoJ2RpdicpLCBbJ3BhbmVsJywgJ3BhbmVsLWRlZmF1bHQnXSk7XHJcbiAgICAgICAgY29uc3QgaDMgPSBhZGRDbGFzcyhhZGRFbChtYWtlRWwoJ2gzJyksIHRpdGxlKSwgJ3BhbmVsLXRpdGxlJyk7XHJcbiAgICAgICAgY29uc3QgYSA9IHNldEF0dHIobWFrZUVsKCdhJyksICdocmVmJywgJyMvJyk7XHJcbiAgICAgICAgY29uc3QgaGVhZERpdiA9IGFkZENsYXNzKG1ha2VFbCgnZGl2JyksICdwYW5lbC1oZWFkaW5nJyk7XHJcbiAgICAgICAgYWRkRWwocGFuZWwsIGFkZEVsKGhlYWREaXYsIGFkZEVsKGEsIGgzKSkpO1xyXG4gICAgICAgIGNvbnN0IGNvbnRlbnREaXYgPSBhZGRDbGFzcyhtYWtlRWwoJ2RpdicpLCAncGFuZWwtYm9keScpO1xyXG4gICAgICAgIGFkZEVsKHBhbmVsLCBhZGRFbChjb250ZW50RGl2LCBjb250ZW50KSk7XHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgcGFuZWwsXHJcbiAgICAgICAgICAgIGNvbnRlbnREaXYsXHJcbiAgICAgICAgICAgIGFcclxuICAgICAgICB9O1xyXG4gICAgfTtcclxuXHJcbiAgICBleHBvcnRzLm1ha2VQcm9maWxlVGFibGUgPSAocHJvZmlsZVN0cnVjdHVyZSwgcHJvZmlsZSkgPT4ge1xyXG4gICAgICAgIGxldCB2YWx1ZTtcclxuICAgICAgICBjb25zdCBwcm9maWxlRGl2ID0gYWRkRWxzKG1ha2VFbCgndGJvZHknKSwgcHJvZmlsZVN0cnVjdHVyZS5maWx0ZXIoZWxlbWVudCA9PiBlbGVtZW50LmRvRXhwb3J0KS5tYXAoKGVsZW1lbnQpID0+IHtcclxuICAgICAgICAgICAgc3dpdGNoIChlbGVtZW50LnR5cGUpIHtcclxuICAgICAgICAgICAgY2FzZSAndGV4dCc6XHJcbiAgICAgICAgICAgICAgICB2YWx1ZSA9IGFkZENsYXNzKG1ha2VFbCgnc3BhbicpLCAnYnJpZWZpbmdUZXh0U3BhbicpO1xyXG4gICAgICAgICAgICAgICAgYWRkRWwodmFsdWUsIG1ha2VUZXh0KHByb2ZpbGVbZWxlbWVudC5uYW1lXSkpO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgJ2VudW0nOlxyXG4gICAgICAgICAgICBjYXNlICdtdWx0aUVudW0nOlxyXG4gICAgICAgICAgICBjYXNlICdudW1iZXInOlxyXG4gICAgICAgICAgICBjYXNlICdzdHJpbmcnOlxyXG4gICAgICAgICAgICAgICAgdmFsdWUgPSBtYWtlVGV4dChwcm9maWxlW2VsZW1lbnQubmFtZV0pO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgJ2NoZWNrYm94JzpcclxuICAgICAgICAgICAgICAgIHZhbHVlID0gbWFrZVRleHQoY29uc3RMMTBuKENvbnN0YW50c1twcm9maWxlW2VsZW1lbnQubmFtZV1dKSk7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgZGVmYXVsdDpcclxuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgVW5leHBlY3RlZCB0eXBlICR7ZWxlbWVudC50eXBlfWApO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiBleHBvcnRzLm1ha2VUYWJsZVJvdyhtYWtlVGV4dChlbGVtZW50Lm5hbWUpLCB2YWx1ZSk7XHJcbiAgICAgICAgfSkpO1xyXG4gICAgICAgIHJldHVybiBhZGRFbChhZGRDbGFzc2VzKG1ha2VFbCgndGFibGUnKSwgWyd0YWJsZScsICd0YWJsZS1zdHJpcGVkJ10pLCBwcm9maWxlRGl2KTtcclxuICAgIH07XHJcblxyXG4gICAgZXhwb3J0cy5tYWtlVGFibGVSb3cgPSAoY29sMSwgY29sMikgPT4gYWRkRWxzKG1ha2VFbCgndHInKSwgW2FkZEVsKG1ha2VFbCgndGQnKSwgY29sMSksIGFkZEVsKG1ha2VFbCgndGQnKSwgY29sMildKTtcclxufSkodGhpcy5VSSA9IHt9KTtcclxuIiwiLypDb3B5cmlnaHQgMjAxNS0yMDE3IFRpbW9mZXkgUmVjaGthbG92IDxudHNka0B5YW5kZXgucnU+LCBNYXJpYSBTaWRla2htZW5vdmEgPG1hdGlsZGFfQGxpc3QucnU+XHJcblxyXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xyXG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXHJcbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxyXG5cclxuaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXHJcblxyXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXHJcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcclxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXHJcblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcclxuICAgIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLiAqL1xyXG5cclxuJ3VzZSBzdHJpY3QnO1xyXG5cclxuLy8gVE9ETyBuZWVkIHRvIGxpbnQgdXRpbHMgd2l0aCBOSU1TIGZpeGVzXHJcbi8qIGVzbGludC1kaXNhYmxlICovXHJcblxyXG5jb25zdCBzdHJGb3JtYXQgPSBSLmN1cnJ5KENvbW1vblV0aWxzLnN0ckZvcm1hdCk7XHJcblxyXG5mdW5jdGlvbiBnZXRMMTBuKGtleSkge1xyXG4gICAgcmV0dXJuIEwxMG4uZ2V0VmFsdWUoa2V5KTtcclxufVxyXG5cclxuZnVuY3Rpb24gY29uc3RMMTBuKGtleSkge1xyXG4gICAgcmV0dXJuIEwxMG4uZ2V0VmFsdWUoYGNvbnN0YW50LSR7a2V5fWApO1xyXG59XHJcblxyXG5mdW5jdGlvbiBpc0VtcHR5KG9iaikge1xyXG4gICAgcmV0dXJuIChPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lcyhvYmopLmxlbmd0aCA9PT0gMCk7XHJcbn1cclxuXHJcbmNvbnN0IGFkZENsYXNzID0gUi5jdXJyeSgobywgYykgPT4ge1xyXG4gICAgY29uc3QgcmUgPSBuZXcgUmVnRXhwKGAoXnxcXFxccykke2N9KFxcXFxzfCQpYCwgJ2cnKTtcclxuICAgIGlmIChyZS50ZXN0KG8uY2xhc3NOYW1lKSkgcmV0dXJuIG87XHJcbiAgICBvLmNsYXNzTmFtZSA9IChgJHtvLmNsYXNzTmFtZX0gJHtjfWApLnJlcGxhY2UoL1xccysvZywgJyAnKS5yZXBsYWNlKC8oXiB8ICQpL2csICcnKTtcclxuICAgIHJldHVybiBvO1xyXG59KTtcclxuXHJcbmNvbnN0IGFkZENsYXNzZXMgPSBSLmN1cnJ5KChvLCBjKSA9PiB7XHJcbiAgICBSLmFwKFthZGRDbGFzcyhvKV0sIGMpO1xyXG4gICAgcmV0dXJuIG87XHJcbn0pO1xyXG5cclxuY29uc3QgckFkZENsYXNzID0gUi5jdXJyeSgoYywgbykgPT4gYWRkQ2xhc3MobywgYykpO1xyXG5cclxuZnVuY3Rpb24gaGFzQ2xhc3MobywgYykge1xyXG4gICAgY29uc3QgcmUgPSBuZXcgUmVnRXhwKGAoXnxcXFxccykke2N9KFxcXFxzfCQpYCwgJ2cnKTtcclxuICAgIHJldHVybiAocmUudGVzdChvLmNsYXNzTmFtZSkpO1xyXG59XHJcblxyXG5jb25zdCByZW1vdmVDbGFzcyA9IFIuY3VycnkoKG8sIGMpID0+IHtcclxuICAgIGNvbnN0IHJlID0gbmV3IFJlZ0V4cChgKF58XFxcXHMpJHtjfShcXFxcc3wkKWAsICdnJyk7XHJcbiAgICBvLmNsYXNzTmFtZSA9IG8uY2xhc3NOYW1lLnJlcGxhY2UocmUsICckMScpLnJlcGxhY2UoL1xccysvZywgJyAnKS5yZXBsYWNlKC8oXiB8ICQpL2csICcnKTtcclxufSk7XHJcblxyXG5jb25zdCB0b2dnbGVDbGFzcyA9IFIuY3VycnkoKG8sIGMpID0+IHtcclxuICAgIGlmIChoYXNDbGFzcyhvLCBjKSkge1xyXG4gICAgICAgIHJlbW92ZUNsYXNzKG8sIGMpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgICBhZGRDbGFzcyhvLCBjKTtcclxuICAgIH1cclxufSk7XHJcblxyXG5mdW5jdGlvbiBzZXRDbGFzc0J5Q29uZGl0aW9uKG8sIGMsIGNvbmRpdGlvbikge1xyXG4gICAgaWYgKGNvbmRpdGlvbikge1xyXG4gICAgICAgIGFkZENsYXNzKG8sIGMpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgICByZW1vdmVDbGFzcyhvLCBjKTtcclxuICAgIH1cclxuICAgIHJldHVybiBvO1xyXG59XHJcblxyXG5mdW5jdGlvbiBnZXRFbChpZCkge1xyXG4gICAgcmV0dXJuIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGlkKTtcclxufVxyXG5cclxuZnVuY3Rpb24gcXVlcnlFbChzZWwpIHtcclxuICAgIHJldHVybiBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKHNlbCk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHF1ZXJ5RWxzKHNlbCkge1xyXG4gICAgcmV0dXJuIG5sMmFycmF5KGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoc2VsKSk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHF1ZXJ5RWxFbHMoZWwsIHNlbCkge1xyXG4gICAgcmV0dXJuIG5sMmFycmF5KGVsLnF1ZXJ5U2VsZWN0b3JBbGwoc2VsKSk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGdldEVscyhjbGF6eikge1xyXG4gICAgcmV0dXJuIGRvY3VtZW50LmdldEVsZW1lbnRzQnlDbGFzc05hbWUoY2xhenopO1xyXG59XHJcblxyXG5mdW5jdGlvbiBtYWtlRWwoZWxUYWcpIHtcclxuICAgIHJldHVybiBkb2N1bWVudC5jcmVhdGVFbGVtZW50KGVsVGFnKTtcclxufVxyXG5cclxuZnVuY3Rpb24gbWFrZVRleHQodGV4dCkge1xyXG4gICAgcmV0dXJuIGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKHRleHQpO1xyXG59XHJcblxyXG5jb25zdCBhZGRFbCA9IFIuY3VycnkoKHBhcmVudCwgY2hpbGQpID0+IHtcclxuICAgIHBhcmVudC5hcHBlbmRDaGlsZChjaGlsZCk7XHJcbiAgICByZXR1cm4gcGFyZW50O1xyXG59KTtcclxuY29uc3QgYWRkRWxzID0gUi5jdXJyeSgocGFyZW50LCBjaGlsZHJlbikgPT4ge1xyXG4gICAgUi5hcChbYWRkRWwocGFyZW50KV0sIGNoaWxkcmVuKTtcclxuICAgIHJldHVybiBwYXJlbnQ7XHJcbn0pO1xyXG5cclxuY29uc3QgbWFrZU9wdCA9IGZ1bmN0aW9uIChsYWJlbCkge1xyXG4gICAgY29uc3Qgb3B0aW9uID0gbWFrZUVsKCdvcHRpb24nKTtcclxuICAgIGFkZEVsKG9wdGlvbiwgKG1ha2VUZXh0KGxhYmVsKSkpO1xyXG4gICAgcmV0dXJuIG9wdGlvbjtcclxufTtcclxuXHJcbmNvbnN0IHJBZGRFbCA9IFIuY3VycnkoKGNoaWxkLCBwYXJlbnQpID0+IHtcclxuICAgIHBhcmVudC5hcHBlbmRDaGlsZChjaGlsZCk7XHJcbiAgICByZXR1cm4gcGFyZW50O1xyXG59KTtcclxuXHJcblxyXG5jb25zdCBzZXRBdHRyID0gUi5jdXJyeSgoZWwsIG5hbWUsIHZhbHVlKSA9PiB7XHJcbiAgICBlbC5zZXRBdHRyaWJ1dGUobmFtZSwgdmFsdWUpO1xyXG4gICAgcmV0dXJuIGVsO1xyXG59KTtcclxuXHJcbmNvbnN0IHNldFN0eWxlID0gUi5jdXJyeSgoZWwsIG5hbWUsIHZhbHVlKSA9PiB7XHJcbiAgICBlbC5zdHlsZS5zZXRQcm9wZXJ0eShuYW1lLCB2YWx1ZSk7XHJcbiAgICByZXR1cm4gZWw7XHJcbn0pO1xyXG5cclxuY29uc3Qgc2V0SW1wb3J0YW50U3R5bGUgPSBSLmN1cnJ5KChlbCwgbmFtZSwgdmFsdWUpID0+IHtcclxuICAgIGVsLnN0eWxlLnNldFByb3BlcnR5KG5hbWUsIHZhbHVlLCAnaW1wb3J0YW50Jyk7XHJcbiAgICByZXR1cm4gZWw7XHJcbn0pO1xyXG5cclxuZnVuY3Rpb24gZGVsQXR0cihlbCwgbmFtZSkge1xyXG4gICAgZWwucmVtb3ZlQXR0cmlidXRlKG5hbWUpO1xyXG4gICAgcmV0dXJuIGVsO1xyXG59XHJcblxyXG5mdW5jdGlvbiBnZXRBdHRyKGVsLCBuYW1lKSB7XHJcbiAgICByZXR1cm4gZWwuZ2V0QXR0cmlidXRlKG5hbWUpO1xyXG59XHJcblxyXG5jb25zdCBzZXRQcm9wID0gUi5jdXJyeSgoZWwsIGtleSwgdmFsdWUpID0+IHtcclxuICAgIGVsW2tleV0gPSB2YWx1ZTtcclxuICAgIHJldHVybiBlbDtcclxufSk7XHJcblxyXG5jb25zdCBzZXRQcm9wcyA9IFIuY3VycnkoKGVsLCBtYXApID0+IHtcclxuICAgIGZvciAoY29uc3Qga2V5IGluIG1hcCkge1xyXG4gICAgICAgIHNldFByb3AoZWwsIGtleSwgbWFwW2tleV0pO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIGVsO1xyXG59KTtcclxuXHJcbmZ1bmN0aW9uIGNsZWFyRWwoZWwpIHtcclxuICAgIFV0aWxzLnJlbW92ZUNoaWxkcmVuKGVsKTtcclxuICAgIHJldHVybiBlbDtcclxufVxyXG5cclxuZnVuY3Rpb24gcGFzc0VscyhzcmMsIGRzdCkge1xyXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzcmMuY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICBhZGRFbChkc3QsIHNyYy5jaGlsZHJlbltpXSk7XHJcbiAgICB9XHJcbn1cclxuXHJcbmNvbnN0IGxpc3RlbiA9IFIuY3VycnkoKGVsLCBldmVudCwgbGlzdGVuZXIpID0+IHtcclxuICAgIGVsLmFkZEV2ZW50TGlzdGVuZXIoZXZlbnQsIGxpc3RlbmVyKTtcclxuICAgIHJldHVybiBlbDtcclxufSk7XHJcblxyXG5jb25zdCBsaXN0ZW5PbkVudGVyID0gUi5jdXJyeSgoZWwsIGNhbGxiYWNrKSA9PiB7XHJcbiAgICBsaXN0ZW4oZWwsICdrZXlkb3duJywgKGUpID0+IHtcclxuICAgICAgICBpZiAoZS5rZXlDb2RlID09PSAxMykge1xyXG4gICAgICAgICAgICBjYWxsYmFjaygpO1xyXG4gICAgICAgIH1cclxuICAgIH0pO1xyXG59KTtcclxuXHJcbmNvbnN0IGZpbGxTZWxlY3RvciA9IFIuY3VycnkoKHNlbCwgZGF0YSkgPT4gYWRkRWxzKHNlbCwgZGF0YS5tYXAoKGl0ZW0pID0+IHtcclxuICAgIGNvbnN0IG9wdCA9IG1ha2VFbCgnb3B0aW9uJyk7XHJcbiAgICBhZGRFbChvcHQsIG1ha2VUZXh0KGl0ZW0ubmFtZSkpO1xyXG4gICAgaWYgKGl0ZW0udmFsdWUpIHsgb3B0LnZhbHVlID0gaXRlbS52YWx1ZTsgfVxyXG4gICAgaWYgKGl0ZW0uc2VsZWN0ZWQpIHsgb3B0LnNlbGVjdGVkID0gdHJ1ZTsgfVxyXG4gICAgaWYgKGl0ZW0uY2xhc3NOYW1lKSB7IGFkZENsYXNzKG9wdCwgaXRlbS5jbGFzc05hbWUpOyB9XHJcbiAgICByZXR1cm4gb3B0O1xyXG59KSkpO1xyXG5cclxuZnVuY3Rpb24gbmwyYXJyYXkobm9kZUxpc3QpIHtcclxuICAgIHJldHVybiBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChub2RlTGlzdCk7XHJcbn1cclxuXHJcbmNvbnN0IHJlbWFwUHJvcHMgPSBSLmN1cnJ5KChvdXRLZXlzLCBwaWNrS2V5cywgb2JqKSA9PiBSLmNvbXBvc2UoUi56aXBPYmoob3V0S2V5cyksIFIudmFsdWVzLCBSLnBpY2socGlja0tleXMpKShvYmopKTtcclxuXHJcbmNvbnN0IHJlbWFwUHJvcHM0U2VsZWN0MiA9IHJlbWFwUHJvcHMoWydpZCcsICd0ZXh0J10sIFsndmFsdWUnLCAnZGlzcGxheU5hbWUnXSk7XHJcbmNvbnN0IHJlbWFwUHJvcHM0U2VsZWN0ID0gcmVtYXBQcm9wcyhbJ3ZhbHVlJywgJ25hbWUnXSwgWyd2YWx1ZScsICdkaXNwbGF5TmFtZSddKTtcclxuXHJcbmNvbnN0IGdldFNlbGVjdDJEYXRhQ29tbW9uID0gUi5jdXJyeSgocHJlcGFyYXRvciwgb2JqKSA9PiBSLmNvbXBvc2UoUi56aXBPYmooWydkYXRhJ10pLCBSLmFwcGVuZChSLl9fLCBbXSksIFIubWFwKHByZXBhcmF0b3IpKShvYmopKTtcclxuXHJcbmNvbnN0IGdldFNlbGVjdDJEYXRhID0gZ2V0U2VsZWN0MkRhdGFDb21tb24ocmVtYXBQcm9wczRTZWxlY3QyKTtcclxuXHJcbmNvbnN0IG1ha2VTZWxlY3QyT3B0ID0gUi5jb21wb3NlKFIuemlwT2JqKFsnaWQnLCAndGV4dCddKSwgUi5yZXBlYXQoUi5fXywgMikpO1xyXG5jb25zdCBhcnIyU2VsZWN0MiA9IFIuY29tcG9zZShSLmFzc29jKCdkYXRhJywgUi5fXywge30pLCBSLm1hcChtYWtlU2VsZWN0Mk9wdCkpO1xyXG5jb25zdCBhcnIyU2VsZWN0ID0gUi5tYXAoUi5jb21wb3NlKFIuemlwT2JqKFsndmFsdWUnLCAnbmFtZSddKSwgUi5yZXBlYXQoUi5fXywgMikpKTtcclxuY29uc3QgY29uc3RBcnIyU2VsZWN0ID0gUi5tYXAoUi5jb21wb3NlKFIuemlwT2JqKFsndmFsdWUnLCAnbmFtZSddKSwgbmFtZSA9PiBbbmFtZSwgY29uc3RMMTBuKG5hbWUpXSkpO1xyXG5cclxuY29uc3QgZ2V0U2VsZWN0ZWRSYWRpbyA9IGZ1bmN0aW9uIChxdWVyeSkge1xyXG4gICAgY29uc3QgZWxzID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbChxdWVyeSk7XHJcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGVscy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgIGlmIChlbHNbaV0uY2hlY2tlZCA9PT0gdHJ1ZSkge1xyXG4gICAgICAgICAgICByZXR1cm4gZWxzW2ldO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiBudWxsO1xyXG59O1xyXG5cclxuY29uc3QgZGVidWdJbnRlcmNlcHRvciA9IGZ1bmN0aW9uIChjYWxsYmFjaykge1xyXG4gICAgcmV0dXJuIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICBjb25zb2xlLmxvZyhKU09OLnN0cmluZ2lmeShhcmd1bWVudHNbMF0pKTtcclxuICAgICAgICBjYWxsYmFjayguLi5hcmd1bWVudHMpO1xyXG4gICAgfTtcclxufTtcclxuXHJcbmNvbnN0IFV0aWxzID0ge307XHJcblxyXG4vKiogb3B0c1xyXG4gICAgdG9vbHRpcCAtIGFkZCB0b29sdGlwIHRvIGJ1dHRvbiwgdXNlZCBmb3IgaWNvbmljIGJ1dHRvbnNcclxuICAgIGlkIC0gc2V0IGJ1dHRvbiBpZFxyXG4gICAgbWFpblBhZ2UgLSBlbmFibGUgdmlldyBhcyBmaXJzdCBwYWdlXHJcbiAgICB0b2dnbGUgLSB0b2dnbGUgY29udGVudCwgYXNzb2NpYXRlZCB3aXRoIGJ1dHRvblxyXG4qL1xyXG5VdGlscy5hZGRWaWV3ID0gZnVuY3Rpb24gKGNvbnRhaW5lcnMsIG5hbWUsIHZpZXcsIG9wdHMyKSB7XHJcbiAgICBjb25zdCBvcHRzID0gb3B0czIgfHwge307XHJcbiAgICB2aWV3LmluaXQoKTtcclxuICAgIGNvbnN0IGJ1dHRvbkNsYXNzID0gJ25hdmlnYXRpb24tYnV0dG9uJztcclxuICAgIGNvbnRhaW5lcnMucm9vdC52aWV3c1tuYW1lXSA9IHZpZXc7XHJcbiAgICBjb25zdCBidXR0b24gPSBtYWtlRWwoJ2J1dHRvbicpO1xyXG4gICAgZnVuY3Rpb24gZGVsZWdhdGUoKSB7XHJcbiAgICAgICAgJChidXR0b24pLmF0dHIoJ2RhdGEtb3JpZ2luYWwtdGl0bGUnLCBMMTBuLmdldFZhbHVlKGBoZWFkZXItJHtuYW1lfWApKTtcclxuICAgIH1cclxuICAgIGlmIChvcHRzLnRvb2x0aXApIHtcclxuICAgICAgICBMMTBuLm9uTDEwbkNoYW5nZShkZWxlZ2F0ZSk7XHJcbiAgICAgICAgJChidXR0b24pLnRvb2x0aXAoe1xyXG4gICAgICAgICAgICB0aXRsZTogTDEwbi5nZXRWYWx1ZShgaGVhZGVyLSR7bmFtZX1gKSxcclxuICAgICAgICAgICAgcGxhY2VtZW50OiAnYm90dG9tJ1xyXG4gICAgICAgIH0pO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgICBhZGRFbChidXR0b24sIG1ha2VUZXh0KEwxMG4uZ2V0VmFsdWUoYGhlYWRlci0ke25hbWV9YCkpKTtcclxuICAgICAgICBzZXRBdHRyKGJ1dHRvbiwgJ2wxMG4taWQnLCBgaGVhZGVyLSR7bmFtZX1gKTtcclxuICAgIH1cclxuICAgIGFkZENsYXNzKGJ1dHRvbiwgYnV0dG9uQ2xhc3MpO1xyXG4gICAgYWRkQ2xhc3MoYnV0dG9uLCBgLXRlc3QtJHtuYW1lfWApO1xyXG4gICAgYWRkQ2xhc3MoYnV0dG9uLCBgLXRvZ2dsZS1jbGFzcy0ke25hbWV9YCk7XHJcbiAgICBpZiAob3B0cy5jbGF6eikge1xyXG4gICAgICAgIGFkZENsYXNzKGJ1dHRvbiwgb3B0cy5jbGF6eik7XHJcbiAgICB9XHJcbiAgICBjb250YWluZXJzLm5hdmlnYXRpb24uYXBwZW5kQ2hpbGQoYnV0dG9uKTtcclxuXHJcbiAgICBjb25zdCBvbkNsaWNrRGVsZWdhdGUgPSBmdW5jdGlvbiAodmlldzIpIHtcclxuICAgICAgICByZXR1cm4gZnVuY3Rpb24gKGV2dCkge1xyXG4gICAgICAgICAgICAvL1Rlc3RzLnJ1bigpO1xyXG4gICAgICAgICAgICBjb25zdCBlbGVtcyA9IGNvbnRhaW5lcnMubmF2aWdhdGlvbi5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKGJ1dHRvbkNsYXNzKTtcclxuICAgICAgICAgICAgaWYgKG9wdHMudG9nZ2xlKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBlbHMgPSBnZXRFbHMoYC10b2dnbGUtY2xhc3MtJHtuYW1lfWApO1xyXG4gICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBlbHMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoZXZ0LnRhcmdldC5pc0VxdWFsTm9kZShlbHNbaV0pKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBpZiAoaGFzQ2xhc3MoZWxzW2ldLCAnYWN0aXZlJykpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZWxzW2ldLmNsaWNrKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBjb25zdCBpc0FjdGl2ZSA9IGhhc0NsYXNzKGV2dC50YXJnZXQsICdhY3RpdmUnKTtcclxuICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBlbGVtcy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICAgICAgcmVtb3ZlQ2xhc3MoZWxlbXNbaV0sICdhY3RpdmUnKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAoIW9wdHMudG9nZ2xlIHx8IChvcHRzLnRvZ2dsZSAmJiAhaXNBY3RpdmUpKSB7XHJcbiAgICAgICAgICAgICAgICBhZGRDbGFzcyhldnQudGFyZ2V0LCAnYWN0aXZlJyk7XHJcblxyXG4gICAgICAgICAgICAgICAgcGFzc0Vscyhjb250YWluZXJzLmNvbnRlbnQsIGdldEVsKCd3YXJlaG91c2UnKSk7XHJcbiAgICAgICAgICAgICAgICBjb250YWluZXJzLmNvbnRlbnQuYXBwZW5kQ2hpbGQodmlldzIuY29udGVudCk7XHJcbiAgICAgICAgICAgICAgICByZW1vdmVDbGFzcyhjb250YWluZXJzLmNvbnRlbnQsICdoaWRkZW4nKTtcclxuICAgICAgICAgICAgICAgIGNvbnRhaW5lcnMucm9vdC5jdXJyZW50VmlldyA9IHZpZXcyO1xyXG4gICAgICAgICAgICAgICAgdmlldzIucmVmcmVzaCgpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgcmVtb3ZlQ2xhc3MoZXZ0LnRhcmdldCwgJ2FjdGl2ZScpO1xyXG4gICAgICAgICAgICAgICAgcGFzc0Vscyhjb250YWluZXJzLmNvbnRlbnQsIGdldEVsKCd3YXJlaG91c2UnKSk7XHJcbiAgICAgICAgICAgICAgICBjb250YWluZXJzLnJvb3QuY3VycmVudFZpZXcgPSBudWxsO1xyXG4gICAgICAgICAgICAgICAgYWRkQ2xhc3MoY29udGFpbmVycy5jb250ZW50LCAnaGlkZGVuJyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9O1xyXG4gICAgfTtcclxuXHJcbiAgICBidXR0b24uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBvbkNsaWNrRGVsZWdhdGUodmlldykpO1xyXG4gICAgaWYgKG9wdHMubWFpblBhZ2UpIHtcclxuICAgICAgICBhZGRDbGFzcyhidXR0b24sICdhY3RpdmUnKTtcclxuICAgICAgICBjb250YWluZXJzLmNvbnRlbnQuYXBwZW5kQ2hpbGQodmlldy5jb250ZW50KTtcclxuICAgICAgICBjb250YWluZXJzLnJvb3QuY3VycmVudFZpZXcgPSB2aWV3O1xyXG4gICAgfVxyXG59O1xyXG5cclxuVXRpbHMuYWxlcnQgPSBmdW5jdGlvbiAobWVzc2FnZSkge1xyXG4gICAgdmV4LmRpYWxvZy5hbGVydChtZXNzYWdlKTtcclxufTtcclxuXHJcblV0aWxzLmNvbmZpcm0gPSBmdW5jdGlvbiAobWVzc2FnZSwgb25Paywgb25DYW5jZWwpIHtcclxuICAgIHZleC5kaWFsb2cuY29uZmlybSh7XHJcbiAgICAgICAgbWVzc2FnZSxcclxuICAgICAgICBjYWxsYmFjazogKHZhbCkgPT4ge1xyXG4gICAgICAgICAgICBpZiAodmFsKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAob25Paykgb25PaygpO1xyXG4gICAgICAgICAgICB9IGVsc2UgaWYgKG9uQ2FuY2VsKSBvbkNhbmNlbCgpO1xyXG4gICAgICAgIH1cclxuICAgIH0pO1xyXG59O1xyXG5cclxuVXRpbHMucmVtb3ZlQ2hpbGRyZW4gPSBmdW5jdGlvbiAobXlOb2RlKSB7XHJcbiAgICBpZiAoIW15Tm9kZSkge1xyXG4gICAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIHdoaWxlIChteU5vZGUuZmlyc3RDaGlsZCkge1xyXG4gICAgICAgIG15Tm9kZS5yZW1vdmVDaGlsZChteU5vZGUuZmlyc3RDaGlsZCk7XHJcbiAgICB9XHJcbn07XHJcblxyXG5VdGlscy5wcm9jZXNzRXJyb3IgPSBmdW5jdGlvbiAoY2FsbGJhY2spIHtcclxuICAgIHJldHVybiBmdW5jdGlvbiAoZXJyKSB7XHJcbiAgICAgICAgaWYgKGVycikge1xyXG4gICAgICAgICAgICBVdGlscy5oYW5kbGVFcnJvcihlcnIpO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAoY2FsbGJhY2spIHtcclxuICAgICAgICAgICAgY29uc3QgYXJyID0gW107XHJcbiAgICAgICAgICAgIGZvciAobGV0IGkgPSAxOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICBhcnIucHVzaChhcmd1bWVudHNbaV0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNhbGxiYWNrKC4uLmFycik7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxufTtcclxuXHJcblV0aWxzLmhhbmRsZUVycm9yTXNnID0gZnVuY3Rpb24gKGVycikge1xyXG4gICAgY29uc3QgY2hlY2tFcnJvclR5cGUgPSBSLmN1cnJ5KChlcnIyLCBuYW1lKSA9PiBlcnIyIGluc3RhbmNlb2YgRXJyb3JzW25hbWVdIHx8IChlcnIyLm5hbWUgJiYgZXJyMi5uYW1lID09PSBuYW1lKSk7XHJcbiAgICBpZiAoUi5rZXlzKEVycm9ycykuc29tZShjaGVja0Vycm9yVHlwZShlcnIpKSkge1xyXG4gICAgICAgIHJldHVybiBzdHJGb3JtYXQoZ2V0TDEwbihlcnIubWVzc2FnZUlkKSwgZXJyLnBhcmFtZXRlcnMpO1xyXG4gICAgfSBlbHNlIGlmICh0eXBlb2YgZXJyID09PSAnb2JqZWN0Jykge1xyXG4gICAgICAgIHJldHVybiBlcnIubWVzc2FnZTtcclxuICAgIH1cclxuICAgIHJldHVybiBlcnI7XHJcbn07XHJcblxyXG5VdGlscy5oYW5kbGVFcnJvciA9IGVyciA9PiBVdGlscy5hbGVydChVdGlscy5oYW5kbGVFcnJvck1zZyhlcnIpKTtcclxuXHJcblV0aWxzLmVuYWJsZUVsID0gUi5jdXJyeSgoZWwsIGNvbmRpdGlvbikgPT4ge1xyXG4gICAgY29uc3Qga2V5ID0gZWwudGFnTmFtZS50b0xvd2VyQ2FzZSgpID09PSAndGV4dGFyZWEnID8gJ3JlYWRvbmx5JyA6ICdkaXNhYmxlZCc7XHJcbiAgICBpZiAoY29uZGl0aW9uKSB7XHJcbiAgICAgICAgZWwucmVtb3ZlQXR0cmlidXRlKGtleSk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAgIGVsLnNldEF0dHJpYnV0ZShrZXksIGtleSk7XHJcbiAgICB9XHJcbn0pO1xyXG5cclxuVXRpbHMuZW5hYmxlID0gZnVuY3Rpb24gKHJvb3QsIGNsYXNzTmFtZSwgY29uZGl0aW9uKSB7XHJcbiAgICBubDJhcnJheShyb290LmdldEVsZW1lbnRzQnlDbGFzc05hbWUoY2xhc3NOYW1lKSkubWFwKFV0aWxzLmVuYWJsZUVsKFIuX18sIGNvbmRpdGlvbikpO1xyXG59O1xyXG5cclxuVXRpbHMuY2hhck9yZEFPYmplY3QgPSBDb21tb25VdGlscy5jaGFyT3JkQUZhY3RvcnkoYSA9PiBhLmRpc3BsYXlOYW1lLnRvTG93ZXJDYXNlKCkpO1xyXG5cclxuVXRpbHMucmVidWlsZFNlbGVjdG9yID0gZnVuY3Rpb24gKHNlbGVjdG9yLCBuYW1lcykge1xyXG4gICAgY2xlYXJFbChzZWxlY3Rvcik7XHJcbiAgICBuYW1lcy5mb3JFYWNoKChuYW1lSW5mbykgPT4ge1xyXG4gICAgICAgIGNvbnN0IG9wdGlvbiA9IG1ha2VFbCgnb3B0aW9uJyk7XHJcbiAgICAgICAgb3B0aW9uLmFwcGVuZENoaWxkKG1ha2VUZXh0KG5hbWVJbmZvLmRpc3BsYXlOYW1lKSk7XHJcbiAgICAgICAgb3B0aW9uLnZhbHVlID0gbmFtZUluZm8udmFsdWU7XHJcbiAgICAgICAgc2VsZWN0b3IuYXBwZW5kQ2hpbGQob3B0aW9uKTtcclxuICAgIH0pO1xyXG59O1xyXG5cclxuVXRpbHMucmVidWlsZFNlbGVjdG9yQXJyID0gZnVuY3Rpb24gKHNlbGVjdG9yLCBuYW1lcykge1xyXG4gICAgY2xlYXJFbChzZWxlY3Rvcik7XHJcbiAgICBuYW1lcy5mb3JFYWNoKChuYW1lKSA9PiB7XHJcbiAgICAgICAgY29uc3Qgb3B0aW9uID0gbWFrZUVsKCdvcHRpb24nKTtcclxuICAgICAgICBvcHRpb24uYXBwZW5kQ2hpbGQobWFrZVRleHQobmFtZSkpO1xyXG4gICAgICAgIHNlbGVjdG9yLmFwcGVuZENoaWxkKG9wdGlvbik7XHJcbiAgICB9KTtcclxufTtcclxuXHJcblN0cmluZy5wcm90b3R5cGUuZW5kc1dpdGggPSBmdW5jdGlvbiAoc3VmZml4KSB7XHJcbiAgICByZXR1cm4gdGhpcy5pbmRleE9mKHN1ZmZpeCwgdGhpcy5sZW5ndGggLSBzdWZmaXgubGVuZ3RoKSAhPT0gLTE7XHJcbn07XHJcblxyXG4vLyBmcm9tIGRhdGUgZm9ybWF0IHV0aWxzXHJcbi8vRm9yIGNvbnZlbmllbmNlLi4uXHJcbkRhdGUucHJvdG90eXBlLmZvcm1hdCA9IGZ1bmN0aW9uIChtYXNrLCB1dGMpIHtcclxuICAgIHJldHVybiBkYXRlRm9ybWF0KHRoaXMsIG1hc2ssIHV0Yyk7XHJcbn07XHJcbiIsIi8qQ29weXJpZ2h0IDIwMTcgVGltb2ZleSBSZWNoa2Fsb3YgPG50c2RrQHlhbmRleC5ydT5cclxuXHJcbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XHJcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cclxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XHJcblxyXG5odHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcclxuXHJcblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcclxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxyXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cclxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxyXG4gICAgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuICovXHJcblxyXG4ndXNlIHN0cmljdCc7XHJcblxyXG4oKGV4cG9ydHMpID0+IHtcclxuICAgIGNvbnN0IHN0YXRlID0ge307XHJcbiAgICBzdGF0ZS52aWV3cyA9IHt9O1xyXG5cclxuICAgIGNvbnN0IGJ0bk9wdHMgPSB7XHJcbiAgICAgICAgdG9vbHRpcDogdHJ1ZSxcclxuICAgICAgICBjbGFzc05hbWU6ICdtYWluTmF2QnV0dG9uJ1xyXG4gICAgfTtcclxuXHJcbiAgICBleHBvcnRzLm9uTWFzdGVyUGFnZUxvYWQgPSAoKSA9PiB7XHJcbiAgICAgICAgaW5pdFBhZ2UoKTtcclxuICAgICAgICBjb25zdCBMb2NhbERCTVMgPSBtYWtlTG9jYWxEQk1TKHRydWUpO1xyXG4gICAgICAgIGlmIChNT0RFID09PSAnU3RhbmRhbG9uZScpIHtcclxuICAgICAgICAgICAgd2luZG93LkRCTVMgPSBuZXcgTG9jYWxEQk1TKCk7XHJcbiAgICAgICAgICAgIERCTVMuc2V0RGF0YWJhc2UoQmFzZUV4YW1wbGUuZGF0YSwgKGVycikgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKGVycikgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgICAgIGNvbnNpc3RlbmN5Q2hlY2sob25EYXRhYmFzZUxvYWQpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9IGVsc2UgaWYgKE1PREUgPT09ICdOSU1TX1NlcnZlcicpIHtcclxuICAgICAgICAgICAgY29uc3QgUmVtb3RlREJNUyA9IG1ha2VSZW1vdGVEQk1TKExvY2FsREJNUyk7XHJcbiAgICAgICAgICAgIHdpbmRvdy5EQk1TID0gbmV3IFJlbW90ZURCTVMoKTtcclxuICAgICAgICAgICAgY29uc2lzdGVuY3lDaGVjayhvbkRhdGFiYXNlTG9hZCk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuXHJcbiAgICBmdW5jdGlvbiBvbkRhdGFiYXNlTG9hZCgpIHtcclxuICAgICAgICAvLyAgICAgICAgaW5pdFRoZW1lKCk7XHJcblxyXG4gICAgICAgIHN0YXRlSW5pdCgpO1xyXG5cclxuICAgICAgICBVdGlscy5hZGRWaWV3KHN0YXRlLmNvbnRhaW5lcnMsICdwZXJmb3JtYW5jZScsIFBlcmZvcm1hbmNlLCB7IG1haW5QYWdlOiB0cnVlIH0pO1xyXG4gICAgICAgIC8vICAgICAgICBVdGlscy5hZGRWaWV3KHN0YXRlLmNvbnRhaW5lcnMsICdpbnN0cnVjdGlvbicsIEluc3RydWN0aW9uKTtcclxuXHJcbiAgICAgICAgYWRkRWwoc3RhdGUubmF2aWdhdGlvbiwgYWRkQ2xhc3MobWFrZUVsKCdkaXYnKSwgJ25hdi1zZXBhcmF0b3InKSk7XHJcblxyXG4gICAgICAgIFV0aWxzLmFkZFZpZXcoc3RhdGUuY29udGFpbmVycywgJ2Fib3V0JywgQWJvdXQpO1xyXG5cclxuICAgICAgICBhZGRFbChzdGF0ZS5uYXZpZ2F0aW9uLCBtYWtlQnV0dG9uKCd0ZXN0QnV0dG9uJywgJ3Rlc3QnLCBydW5UZXN0cywgYnRuT3B0cykpO1xyXG5cclxuICAgICAgICBjb25zdCBidXR0b24gPSBtYWtlQnV0dG9uKCdkYXRhTG9hZEJ1dHRvbicsICdvcGVuLWRhdGFiYXNlJywgbnVsbCwgYnRuT3B0cyk7XHJcbiAgICAgICAgYnV0dG9uLmFkZEV2ZW50TGlzdGVuZXIoJ2NoYW5nZScsIEZpbGVVdGlscy5yZWFkU2luZ2xlRmlsZSwgZmFsc2UpO1xyXG5cclxuICAgICAgICBjb25zdCBpbnB1dCA9IG1ha2VFbCgnaW5wdXQnKTtcclxuICAgICAgICBpbnB1dC50eXBlID0gJ2ZpbGUnO1xyXG4gICAgICAgIGFkZENsYXNzKGlucHV0LCAnaGlkZGVuJyk7XHJcbiAgICAgICAgc2V0QXR0cihpbnB1dCwgJ3RhYmluZGV4JywgLTEpO1xyXG4gICAgICAgIGJ1dHRvbi5hcHBlbmRDaGlsZChpbnB1dCk7XHJcbiAgICAgICAgYnV0dG9uLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKGUpID0+IHtcclxuICAgICAgICAgICAgaW5wdXQudmFsdWUgPSAnJztcclxuICAgICAgICAgICAgaW5wdXQuY2xpY2soKTtcclxuICAgICAgICB9KTtcclxuICAgICAgICBhZGRFbChzdGF0ZS5uYXZpZ2F0aW9uLCBidXR0b24pO1xyXG5cclxuICAgICAgICAvLyAgICAgICAgICAgICAgICBhZGRFbChzdGF0ZS5uYXZpZ2F0aW9uLCBtYWtlQnV0dG9uKFwidGhlbWVCdXR0b25cIiwgXCJ0aGVtZVwiLCAoKSA9PiBuZXh0VGhlbWUoKSwgYnRuT3B0cykpO1xyXG4gICAgICAgIGFkZEVsKHN0YXRlLm5hdmlnYXRpb24sIG1ha2VCdXR0b24oJ2RhdGFTYXZlQnV0dG9uJywgJ3NhdmUtZGF0YWJhc2UnLCBGaWxlVXRpbHMuc2F2ZUZpbGUsIGJ0bk9wdHMpKTtcclxuICAgICAgICAvL2lmIChNT0RFID09PSAnU3RhbmRhbG9uZScpIHtcclxuICAgICAgICAvLyAgYWRkRWwoc3RhdGUubmF2aWdhdGlvbiwgbWFrZUJ1dHRvbignbmV3QmFzZUJ1dHRvbicsICdjcmVhdGUtZGF0YWJhc2UnLCBGaWxlVXRpbHMubWFrZU5ld0Jhc2UsIGJ0bk9wdHMpKTtcclxuICAgICAgICAvL31cclxuICAgICAgICAvL2FkZEVsKHN0YXRlLm5hdmlnYXRpb24sIG1ha2VCdXR0b24oXCJtYWluSGVscEJ1dHRvblwiLCBcImRvY3NcIiwgRmlsZVV0aWxzLm9wZW5IZWxwLCBidG5PcHRzKSk7XHJcblxyXG4gICAgICAgIC8vICAgICAgICBhZGRFbChzdGF0ZS5uYXZpZ2F0aW9uLCBtYWtlTDEwbkJ1dHRvbigpKTtcclxuXHJcbiAgICAgICAgLy8gICAgICAgIFV0aWxzLmFkZFZpZXcoc3RhdGUuY29udGFpbmVycywgJ2xvZ1ZpZXdlcicsIExvZ1ZpZXdlcjIsIHsgY2xheno6ICdsb2dWaWV3ZXJCdXR0b24nLCB0b29sdGlwOiB0cnVlIH0pO1xyXG4gICAgICAgIC8vICAgICAgICBhZGRFbChzdGF0ZS5uYXZpZ2F0aW9uLCBtYWtlQnV0dG9uKCd0ZXN0QnV0dG9uJywgJ3Rlc3QnLCBydW5UZXN0cywgYnRuT3B0cykpO1xyXG5cclxuICAgICAgICAvL2FkZEVsKHN0YXRlLm5hdmlnYXRpb24sIG1ha2VCdXR0b24oXCJyZWZyZXNoQnV0dG9uXCIsIFwicmVmcmVzaFwiLCAoKSA9PiBzdGF0ZS5jdXJyZW50Vmlldy5yZWZyZXNoKCksIGJ0bk9wdHMpKTtcclxuXHJcbiAgICAgICAgRmlsZVV0aWxzLmluaXQoKGVycikgPT4ge1xyXG4gICAgICAgICAgICBpZiAoZXJyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycik7IHJldHVybjsgfVxyXG4gICAgICAgICAgICBjb25zaXN0ZW5jeUNoZWNrKHN0YXRlLmN1cnJlbnRWaWV3LnJlZnJlc2gpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBzdGF0ZS5jdXJyZW50Vmlldy5yZWZyZXNoKCk7XHJcbiAgICAgICAgYWRkQmVmb3JlVW5sb2FkTGlzdGVuZXIoKTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBpbml0UGFnZSgpIHtcclxuICAgICAgICBMMTBuLmxvY2FsaXplU3RhdGljKCk7XHJcbiAgICAgICAgTDEwbi5vbkwxMG5DaGFuZ2UoKCkgPT4gc3RhdGUuY3VycmVudFZpZXcucmVmcmVzaCgpKTtcclxuICAgICAgICBVSS5pbml0U2VsZWN0b3JGaWx0ZXJzKCk7XHJcbiAgICAgICAgVUkuaW5pdFBhbmVsVG9nZ2xlcnMoKTtcclxuICAgICAgICBmdW5jdGlvbiB1cGRhdGVEaWFsb2dzKCkge1xyXG4gICAgICAgICAgICB2ZXguZGlhbG9nLmJ1dHRvbnMuWUVTLnRleHQgPSBnZXRMMTBuKCdjb21tb24tb2snKTtcclxuICAgICAgICAgICAgdmV4LmRpYWxvZy5idXR0b25zLk5PLnRleHQgPSBnZXRMMTBuKCdjb21tb24tY2FuY2VsJyk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHVwZGF0ZURpYWxvZ3MoKTtcclxuICAgICAgICBMMTBuLm9uTDEwbkNoYW5nZSh1cGRhdGVEaWFsb2dzKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyAgICB2YXIgY3VyVGhlbWUgPSBDb25zdGFudHMudGhlbWVMaXN0WzFdO1xyXG4gICAgLy9cclxuICAgIC8vICAgIHZhciBpbml0VGhlbWUgPSBmdW5jdGlvbigpIHtcclxuICAgIC8vICAgICAgICBpZihEQk1TLnNldFRoZW1lKXtcclxuICAgIC8vICAgICAgICAgICAgREJNUy5nZXRUaGVtZShmdW5jdGlvbihlcnIsIHRoZW1lKXtcclxuICAgIC8vICAgICAgICAgICAgICAgIGlmKGVycikge2NvbnNvbGUubG9nKGVycik7fVxyXG4gICAgLy8gICAgICAgICAgICAgICAgaWYodGhlbWUgIT09ICcnKXtcclxuICAgIC8vICAgICAgICAgICAgICAgICAgICBjdXJUaGVtZSA9IHRoZW1lO1xyXG4gICAgLy8gICAgICAgICAgICAgICAgfVxyXG4gICAgLy8gICAgICAgICAgICAgICAgYWRkQ2xhc3MocXVlcnlFbCgnYm9keScpLCBjdXJUaGVtZSk7XHJcbiAgICAvLyAgICAgICAgICAgIH0pO1xyXG4gICAgLy8gICAgICAgIH0gZWxzZSB7XHJcbiAgICAvLyAgICAgICAgICAgIGFkZENsYXNzKHF1ZXJ5RWwoJ2JvZHknKSwgY3VyVGhlbWUpO1xyXG4gICAgLy8gICAgICAgIH1cclxuICAgIC8vICAgIH07XHJcbiAgICAvL1xyXG4gICAgLy8gICAgdmFyIG5leHRUaGVtZSA9IGZ1bmN0aW9uKCkge1xyXG4gICAgLy8gICAgICAgIHJlbW92ZUNsYXNzKHF1ZXJ5RWwoJ2JvZHknKSwgY3VyVGhlbWUpO1xyXG4gICAgLy8gICAgICAgIGN1clRoZW1lID0gQ29uc3RhbnRzLnRoZW1lTGlzdFsoUi5pbmRleE9mKGN1clRoZW1lLCBDb25zdGFudHMudGhlbWVMaXN0KSsxKSVDb25zdGFudHMudGhlbWVMaXN0Lmxlbmd0aF07XHJcbiAgICAvLyAgICAgICAgYWRkQ2xhc3MocXVlcnlFbCgnYm9keScpLCBjdXJUaGVtZSk7XHJcbiAgICAvLyAgICAgICAgaWYoREJNUy5zZXRUaGVtZSl7XHJcbiAgICAvLyAgICAgICAgICAgIERCTVMuc2V0VGhlbWUoY3VyVGhlbWUsIGZ1bmN0aW9uKGVycil7XHJcbiAgICAvLyAgICAgICAgICAgICAgICBpZihlcnIpIHtjb25zb2xlLmxvZyhlcnIpOyByZXR1cm47fVxyXG4gICAgLy8gICAgICAgICAgICB9KTtcclxuICAgIC8vICAgICAgICB9XHJcbiAgICAvLyAgICB9O1xyXG5cclxuICAgIGZ1bmN0aW9uIGNvbnNpc3RlbmN5Q2hlY2soY2FsbGJhY2spIHtcclxuICAgICAgICBEQk1TLmdldENvbnNpc3RlbmN5Q2hlY2tSZXN1bHQoKGVyciwgY29uc2lzdGVuY3lFcnJvcnMpID0+IHtcclxuICAgICAgICAgICAgaWYgKGVycikgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgY29uc2lzdGVuY3lFcnJvcnMuZm9yRWFjaChDb21tb25VdGlscy5jb25zb2xlTG9nKTtcclxuICAgICAgICAgICAgaWYgKGNvbnNpc3RlbmN5RXJyb3JzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgICAgIFV0aWxzLmFsZXJ0KGdldEwxMG4oJ292ZXJ2aWV3LWNvbnNpc3RlbmN5LXByb2JsZW0tZGV0ZWN0ZWQnKSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnQ29uc2lzdGVuY3kgY2hlY2sgZGlkblxcJ3QgZmluZCBlcnJvcnMnKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjYWxsYmFjaygpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIHN0YXRlSW5pdCgpIHtcclxuICAgICAgICBzdGF0ZS5uYXZpZ2F0aW9uID0gZ2V0RWwoJ25hdmlnYXRpb24nKTtcclxuICAgICAgICBzdGF0ZS5jb250YWluZXJzID0ge1xyXG4gICAgICAgICAgICByb290OiBzdGF0ZSxcclxuICAgICAgICAgICAgbmF2aWdhdGlvbjogc3RhdGUubmF2aWdhdGlvbixcclxuICAgICAgICAgICAgY29udGVudDogZ2V0RWwoJ2NvbnRlbnRBcmVhJylcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIHJ1blRlc3RzKCkge1xyXG4gICAgICAgIERCTVMuZ2V0Q29uc2lzdGVuY3lDaGVja1Jlc3VsdCgoZXJyLCBjb25zaXN0ZW5jeUVycm9ycykgPT4ge1xyXG4gICAgICAgICAgICBpZiAoZXJyKSB7IFV0aWxzLmhhbmRsZUVycm9yKGVycik7IHJldHVybjsgfVxyXG4gICAgICAgICAgICBjb25zaXN0ZW5jeUVycm9ycy5mb3JFYWNoKENvbW1vblV0aWxzLmNvbnNvbGVMb2cpO1xyXG4gICAgICAgICAgICBpZiAoY29uc2lzdGVuY3lFcnJvcnMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICAgICAgVXRpbHMuYWxlcnQoZ2V0TDEwbignb3ZlcnZpZXctY29uc2lzdGVuY3ktcHJvYmxlbS1kZXRlY3RlZCcpKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIFV0aWxzLmFsZXJ0KGdldEwxMG4oJ292ZXJ2aWV3LWNvbnNpc3RlbmN5LWlzLW9rJykpO1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ0NvbnNpc3RlbmN5IGNoZWNrIGRpZG5cXCd0IGZpbmQgZXJyb3JzJyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBtYWtlQnV0dG9uKGNsYXp6LCBuYW1lLCBjYWxsYmFjaywgb3B0cykge1xyXG4gICAgICAgIGNvbnN0IGJ1dHRvbiA9IG1ha2VFbCgnYnV0dG9uJyk7XHJcbiAgICAgICAgYWRkQ2xhc3MoYnV0dG9uLCBjbGF6eik7XHJcbiAgICAgICAgZnVuY3Rpb24gZGVsZWdhdGUoKSB7XHJcbiAgICAgICAgICAgICQoYnV0dG9uKS5hdHRyKCdkYXRhLW9yaWdpbmFsLXRpdGxlJywgTDEwbi5nZXRWYWx1ZShgaGVhZGVyLSR7bmFtZX1gKSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChvcHRzLnRvb2x0aXApIHtcclxuICAgICAgICAgICAgTDEwbi5vbkwxMG5DaGFuZ2UoZGVsZWdhdGUpO1xyXG4gICAgICAgICAgICAkKGJ1dHRvbikudG9vbHRpcCh7XHJcbiAgICAgICAgICAgICAgICB0aXRsZTogTDEwbi5nZXRWYWx1ZShgaGVhZGVyLSR7bmFtZX1gKSxcclxuICAgICAgICAgICAgICAgIHBsYWNlbWVudDogJ2JvdHRvbSdcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGFkZENsYXNzKGJ1dHRvbiwgJ2FjdGlvbi1idXR0b24nKTtcclxuICAgICAgICBpZiAob3B0cy5jbGFzc05hbWUpIHtcclxuICAgICAgICAgICAgYWRkQ2xhc3MoYnV0dG9uLCBvcHRzLmNsYXNzTmFtZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChjYWxsYmFjaykge1xyXG4gICAgICAgICAgICBsaXN0ZW4oYnV0dG9uLCAnY2xpY2snLCBjYWxsYmFjayk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBidXR0b247XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gbWFrZUwxMG5CdXR0b24oKSB7XHJcbiAgICAgICAgY29uc3QgbDEwbkJ0biA9IG1ha2VCdXR0b24oJ3RvZ2dsZUwxMG5CdXR0b24nLCAnbDEwbicsIEwxMG4udG9nZ2xlTDEwbiwgYnRuT3B0cyk7XHJcbiAgICAgICAgZnVuY3Rpb24gc2V0SWNvbigpIHtcclxuICAgICAgICAgICAgbDEwbkJ0bi5zdHlsZS5iYWNrZ3JvdW5kSW1hZ2UgPSBzdHJGb3JtYXQoJ3VybChcIi4vaW1hZ2VzL3swfS5zdmdcIiknLCBbZ2V0TDEwbignaGVhZGVyLWRpY3Rpb25hcnktaWNvbicpXSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIEwxMG4ub25MMTBuQ2hhbmdlKHNldEljb24pO1xyXG4gICAgICAgIHNldEljb24oKTtcclxuICAgICAgICByZXR1cm4gbDEwbkJ0bjtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBhZGRCZWZvcmVVbmxvYWRMaXN0ZW5lcigpIHtcclxuICAgICAgICB3aW5kb3cub25iZWZvcmV1bmxvYWQgPSAoZXZ0KSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IG1lc3NhZ2UgPSBnZXRMMTBuKCd1dGlscy1jbG9zZS1wYWdlLXdhcm5pbmcnKTtcclxuICAgICAgICAgICAgaWYgKHR5cGVvZiBldnQgPT09ICd1bmRlZmluZWQnKSB7XHJcbiAgICAgICAgICAgICAgICBldnQgPSB3aW5kb3cuZXZlbnQ7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKGV2dCkge1xyXG4gICAgICAgICAgICAgICAgZXZ0LnJldHVyblZhbHVlID0gbWVzc2FnZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gbWVzc2FnZTtcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG4gICAgXHJcbiAgICBsaXN0ZW4od2luZG93LCAncGFzdGUnLCBmdW5jdGlvbiAoZXZ0KSB7XHJcbiAgICAgICAgdHJ5e1xyXG4gICAgICAgICAgICBKU09OLnBhcnNlKGV2dC5jbGlwYm9hcmREYXRhLmdldERhdGEoXCJ0ZXh0XCIpKVxyXG4gICAgICAgIH0gY2F0Y2goZSl7XHJcbiAgICAgICAgICAgIFV0aWxzLmFsZXJ0KCdFcnJvciBvbiBwYXJzaW5nIGJhc2UgJyArIGUpO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIERCTVMuc2V0RGF0YWJhc2UoSlNPTi5wYXJzZShldnQuY2xpcGJvYXJkRGF0YS5nZXREYXRhKFwidGV4dFwiKSksIChlcnIpID0+IHtcclxuICAgICAgICAgICAgaWYgKGVycikgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgY29uc2lzdGVuY3lDaGVjayhzdGF0ZS5jdXJyZW50Vmlldy5yZWZyZXNoKTtcclxuICAgICAgICB9KTtcclxuICAgIH0pO1xyXG59KSh0aGlzLlBhZ2VNYW5hZ2VyID0ge30pO1xyXG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=

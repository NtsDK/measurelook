/*Copyright 2017 Timofey Rechkalov <ntsdk@yandex.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

'use strict';

function makeLocalDBMS(fullVersion) {
    const opts = {
        Migrator,
        CommonUtils,
        EventEmitter,
        Precondition,
        R,
        Ajv,
        Schema,
        Errors,
        listeners: {},
        Constants,
        dbmsUtils: {},
        dateFormat,
    };

    function LocalDBMS() {
        this._init(opts.listeners);
    }

    LocalDBMS.prototype.getSettings = () => this.database.Settings;

    const func = name => window[name](LocalDBMS, opts);

    [
        'baseAPI',
        'consistencyCheckAPI',
        //        'logAPI',
        //        'charsheetAPI',
        //        'settingsAPI',
    ].map(func);

    //    Logger.attachLogCalls(LocalDBMS, R, false);
    return LocalDBMS;
}

/*Copyright 2015-2017 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

'use strict';

((exports) => {
    const state = {};

    exports.init = (callback) => {
        state.callback = callback;
    };

    exports.makeNewBase = () => {
        Utils.confirm(getL10n('utils-new-base-warning'), () => {
            DBMS.setDatabase(CommonUtils.clone(EmptyBase.data), state.callback);
        });
    };

    exports.openHelp = () => {
        window.open('extras/doc/nims.html');
    };

    exports.readSingleFile = (evt) => {
        // Retrieve the first (and only!) File from the FileList object
        const f = evt.target.files[0];

        if (f) {
            const r = new FileReader();
            r.onload = (e) => {
                const contents = e.target.result;
                const database = JSON.parse(contents);
                DBMS.setDatabase(database, state.callback);
            };
            r.readAsText(f);
        } else {
            Utils.alert(getL10n('utils-base-file-loading-error'));
        }
    };

    exports.saveFile = () => {
        DBMS.getDatabase((err, database) => {
            if (err) { Utils.handleError(err); return; }
            exports.json2File(database, `${BASE_FILE_NAME}.json`);
        });
    };

    exports.json2File = (str, fileName) => {
        exports.str2File(JSON.stringify(str, null, '  '), fileName);
    };

    exports.str2File = (str, fileName) => {
        const blob = new Blob([str], {
            type: 'text/plain;charset=utf-8'
        });
        saveAs(blob, fileName);
    };

    function preprocessCsvStr(str) {
        if (!(typeof str === 'string' || str instanceof String)) {
            return str;
        }
        let result = str.replace(/"/g, '""');
        if (result.search(/("|,|\n)/g) >= 0) {
            result = `"${result}"`;
        }
        return result;
    }

    exports.arr2d2Csv = (arr, fileName) => {
        const csv = `\ufeff${arr.map(dataArray => dataArray.map(preprocessCsvStr).join(';')).join('\n')}`;

        const out = new Blob([csv], {
            type: 'text/csv;charset=utf-8;'
        });
        saveAs(out, 'table.csv');
    };
})(this.FileUtils = {});

/*Copyright 2015-2017 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

'use strict';

/* eslint-disable no-var,vars-on-top */

((exports, Dictionaries) => {
    const state = {};

    state.initialized = false;
    state.l10nDelegates = [];
    state.dictionaries = {};
    state.lang = defaultLang;

    const init = () => {
        if (state.initialized) {
            return;
        }
        //        console.log(navigator.language);

        state.dictionaries = R.map(processDictionary, Dictionaries);

        //    var lang = (navigator.languages ? navigator.languages[0] : navigator.browserLanguage).split('-')[0];
        //    var lang = 'ru';
        //        var lang = defaultLang;
        //        console.log(lang);

        if (state.dictionaries[defaultLang]) {
            state.dict = state.dictionaries[defaultLang];
        } else {
            state.dict = state.dictionaries.en;
        }
        setHtmlLang(defaultLang);
        exports.onL10nChange(exports.localizeStatic);
        state.initialized = true;
    };

    var processDictionary = (dictionary) => {
        const processedDictionary = {};
        R.toPairs(dictionary).forEach(([sectionName, section]) => {
            R.toPairs(section).forEach(([key, value]) => {
                processedDictionary[`${sectionName}-${key}`] = value;
            });
        });
        //        for (const sectionName in dictionary) {
        //            for (const name in dictionary[sectionName]) {
        //                processedDictionary[`${sectionName}-${name}`] = dictionary[sectionName][name];
        //            }
        //        }
        return processedDictionary;
    };

    var setHtmlLang = lang => setAttr(document.getElementsByTagName('html')[0], 'lang', lang);

    exports.toggleL10n = () => {
        if (state.lang === 'ru') {
            state.dict = state.dictionaries.en;
            state.lang = 'en';
        } else {
            state.dict = state.dictionaries.ru;
            state.lang = 'ru';
        }
        setHtmlLang(state.lang);
        state.l10nDelegates.forEach((delegate) => {
            delegate();
        });
    };

    exports.getLang = () => state.lang.toLowerCase();

    exports.format = R.curry((namespace, name, args) => strFormat(exports.get(namespace, name), args));

    exports.get = R.curry((namespace, name) => L10n.getValue(`${namespace}-${name}`));

    exports.getValue = (name) => {
        const value = state.dict[name];
        if (value === undefined) console.log(`Value is not found: ${name}`);
        return value || `${name}:RA RA-AH-AH-AH ROMA ROMA-MA GAGA OH LA-LA`;
    };

    exports.onL10nChange = (delegate) => {
        state.l10nDelegates.push(delegate);
    };

    exports.localizeStatic = () => {
        init();
        nl2array(document.querySelectorAll('[l10n-id]')).map(el => addEl(clearEl(el), makeText(exports.getValue(getAttr(el, 'l10n-id')))));
        nl2array(document.querySelectorAll('[l10n-placeholder-id]')).map(el => setAttr(el, 'placeholder', exports.getValue(getAttr(el, 'l10n-placeholder-id'))));
    };
})(this.L10n = {}, Dictionaries);

/*Copyright 2015-2017 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

'use strict';

/* eslint-disable no-var,vars-on-top */

((exports) => {
    exports.initTabPanel = (tabClazz, containerClazz) => {
        const containers = getEls(containerClazz);

        let i;
        for (i = 1; i < containers.length; i++) { // don't hide 1st element
            addClass(containers[i], 'hidden');
        }

        const tabButtons = getEls(tabClazz);

        addClass(tabButtons[0], 'active');

        for (i = 0; i < tabButtons.length; i++) {
            listen(tabButtons[i], 'click', tabButtonClick(tabButtons, containers));
        }
    };

    var tabButtonClick = (buttons, containers) => (event) => {
        for (let i = 0; i < buttons.length; i++) {
            setClassByCondition(buttons[i], 'active', event.target.id === buttons[i].id);
        }
        for (let i = 0; i < containers.length; i++) {
            setClassByCondition(containers[i], 'hidden', `${event.target.id}Container` !== containers[i].id);
        }
    };

    exports.fillShowItemSelector = (selector, displayArray) => {
        let el;
        setAttr(selector, 'size', displayArray.length);
        displayArray.forEach((value) => {
            el = setProps(makeEl('option'), {
                selected: true,
            });
            setClassByCondition(el, 'hidden', value.hidden);
            addEl(selector, addEl(el, makeText(value.name)));
        });
    };

    exports.fillShowItemSelector2 = (selector, optionGroups) => {
        let el, groupEl, counter = 0;
        addEls(selector, optionGroups.map((group) => {
            counter++;
            groupEl = setAttr(makeEl('optgroup'), 'label', group.name);
            addEls(groupEl, group.array.map((value) => {
                el = setProps(makeEl('option'), {
                    selected: true,
                });
                setClassByCondition(el, 'hidden', value.hidden);
                counter += (value.hidden ? 0 : 1);
                return addEl(el, makeText(value.name));
            }));
            return groupEl;
        }));
        setAttr(selector, 'size', counter);
    };

    exports.showSelectedEls = classKey => (event) => {
        const el = event.target;
        let els, i, j;
        for (i = 0; i < el.options.length; i += 1) {
            els = getEls(i + classKey);
            for (j = 0; j < els.length; j++) {
                setClassByCondition(els[j], 'hidden', !el.options[i].selected);
            }
        }
    };

    exports.initSelectorFilters = () => {
        const elems = document.querySelectorAll('[selector-filter]');
        let el, sel;
        for (let i = 0; i < elems.length; i++) {
            el = elems[i];
            sel = queryEl(getAttr(el, 'selector-filter'));
            el.value = '';
            listen(el, 'input', filterOptions(sel));
        }
    };

    var filterOptions = sel => (event) => {
        let val = event.target.value;
        let i, opt;
        val = CommonUtils.globStringToRegex(val.trim().toLowerCase());
        for (i = 0; i < sel.options.length; i += 1) {
            opt = sel.options[i];
            const isVisible = opt.innerHTML.toLowerCase().search(val) !== -1;
            if (!isVisible) {
                opt.selected = false;
            }
            setClassByCondition(opt, 'hidden', !isVisible);
            //                setClassByCondition(opt, "hidden", opt.innerHTML.toLowerCase().search(val) === -1);
        }
        sel.dispatchEvent(new Event('change'));
    };

    exports.initPanelTogglers = () => {
        const elems = document.querySelectorAll('[panel-toggler]');
        let el, sel, attr;
        for (let i = 0; i < elems.length; i++) {
            el = elems[i];
            attr = getAttr(el, 'panel-toggler');
            sel = document.querySelector(attr);
            if (sel == null) {
                Utils.alert(`Panel toggler is broken: ${attr}`);
            }
            listen(el, 'click', exports.togglePanel(sel));
        }
    };

    exports.togglePanel = sel => (event) => {
        toggleClass(sel, 'hidden');
    };

    exports.makeEventTimePicker = (opts) => {
        const input = makeEl('input');
        R.ap([addClass(input)], opts.extraClasses);
        addClass(input, 'eventTime');
        input.value = opts.eventTime;

        input.eventIndex = opts.index;

        const pickerOpts = {
            lang: L10n.getLang(),
            mask: true,
            startDate: new Date(opts.preGameDate),
            endDate: new Date(opts.date),
            onChangeDateTime: opts.onChangeDateTimeCreator(input),
        };

        if (opts.eventTime !== '') {
            pickerOpts.value = opts.eventTime;
        } else {
            pickerOpts.value = opts.date;
            addClass(input, 'defaultDate');
        }

        jQuery(input).datetimepicker(pickerOpts);
        return input;
    };

    // bug about setting 0900 years in Braavos game is event date. Fixed in production.
    //  exports.makeEventTimePicker = function (opts) {
    //      var input = makeEl("input");
    //      R.ap([addClass(input)], opts.extraClasses);
    //      addClass(input, "eventTime");
    //      input.value = opts.eventTime;
    //
    //      input.eventIndex = opts.index;
    //
    //      var pickerOpts = {
    //          lang : L10n.getLang(),
    //          mask : true,
    //          startDate : new Date(opts.preGameDate),
    //          endDate : new Date(opts.date),
    //          onChangeDateTime : opts.onChangeDateTimeCreator(input),
    //      };
    //
    //      var picker = jQuery(input).datetimepicker(pickerOpts);
    //
    //      var value;
    //      if (opts.eventTime !== "") {
    //          value = new Date(opts.eventTime);
    //      } else {
    //          value = opts.date;
    //          addClass(input, "defaultDate");
    //      }
    //
    //      picker.value = value;
    //
    //
    //      return input;
    //  };

    exports.resizeTextarea = (ev) => {
        const that = ev.target;
        that.style.height = '24px';
        that.style.height = `${that.scrollHeight + 12}px`;
    };

    exports.resizeTextarea2 = (that) => {
        that.style.height = '24px';
        that.style.height = `${that.scrollHeight + 12}px`;
    };

    exports.makeAdaptationTimeInput = (storyName, event, characterName, isEditable) => {
        const input = makeEl('input');
        setClassByCondition(input, 'notEditable', !isEditable);
        addClass(input, 'adaptationTimeInput');
        input.value = event.characters[characterName].time;
        input.dataKey = JSON.stringify([storyName, event.index, characterName]);
        listen(input, 'change', onChangePersonalTimeDelegate);
        return input;
    };

    var onChangePersonalTimeDelegate = (event) => {
        const dataKey = JSON.parse(event.target.dataKey);
        const time = event.target.value;
        DBMS.setEventAdaptationProperty(dataKey[0], dataKey[1], dataKey[2], 'time', time, Utils.processError());
    };

    exports.makeAdaptationReadyInput = (storyName, event, characterName, isEditable) => {
        const div = makeEl('div');
        const input = makeEl('input');
        setClassByCondition(input, 'notEditable', !isEditable);
        input.type = 'checkbox';
        input.checked = event.characters[characterName].ready;
        input.dataKey = JSON.stringify([storyName, event.index, characterName]);
        input.id = `${event.index}-${storyName}-${characterName}`;
        listen(input, 'change', onChangeReadyStatus);
        addEl(div, input);

        addEl(div, setAttr(addEl(makeEl('label'), makeText(constL10n(Constants.finishedText))), 'for', input.id));
        return div;
    };

    var onChangeReadyStatus = (event) => {
        const dataKey = JSON.parse(event.target.dataKey);
        const value = event.target.checked;
        DBMS.setEventAdaptationProperty(dataKey[0], dataKey[1], dataKey[2], 'ready', value, Utils.processError());
    };

    exports.makePanelCore = (title, content) => {
        const panel = addClasses(makeEl('div'), ['panel', 'panel-default']);
        const h3 = addClass(addEl(makeEl('h3'), title), 'panel-title');
        const a = setAttr(makeEl('a'), 'href', '#/');
        const headDiv = addClass(makeEl('div'), 'panel-heading');
        addEl(panel, addEl(headDiv, addEl(a, h3)));
        const contentDiv = addClass(makeEl('div'), 'panel-body');
        addEl(panel, addEl(contentDiv, content));
        return {
            panel,
            contentDiv,
            a
        };
    };

    exports.makeProfileTable = (profileStructure, profile) => {
        let value;
        const profileDiv = addEls(makeEl('tbody'), profileStructure.filter(element => element.doExport).map((element) => {
            switch (element.type) {
            case 'text':
                value = addClass(makeEl('span'), 'briefingTextSpan');
                addEl(value, makeText(profile[element.name]));
                break;
            case 'enum':
            case 'multiEnum':
            case 'number':
            case 'string':
                value = makeText(profile[element.name]);
                break;
            case 'checkbox':
                value = makeText(constL10n(Constants[profile[element.name]]));
                break;
            default:
                throw new Error(`Unexpected type ${element.type}`);
            }
            return exports.makeTableRow(makeText(element.name), value);
        }));
        return addEl(addClasses(makeEl('table'), ['table', 'table-striped']), profileDiv);
    };

    exports.makeTableRow = (col1, col2) => addEls(makeEl('tr'), [addEl(makeEl('td'), col1), addEl(makeEl('td'), col2)]);
})(this.UI = {});

/*Copyright 2015-2017 Timofey Rechkalov <ntsdk@yandex.ru>, Maria Sidekhmenova <matilda_@list.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

'use strict';

// TODO need to lint utils with NIMS fixes
/* eslint-disable */

const strFormat = R.curry(CommonUtils.strFormat);

function getL10n(key) {
    return L10n.getValue(key);
}

function constL10n(key) {
    return L10n.getValue(`constant-${key}`);
}

function isEmpty(obj) {
    return (Object.getOwnPropertyNames(obj).length === 0);
}

const addClass = R.curry((o, c) => {
    const re = new RegExp(`(^|\\s)${c}(\\s|$)`, 'g');
    if (re.test(o.className)) return o;
    o.className = (`${o.className} ${c}`).replace(/\s+/g, ' ').replace(/(^ | $)/g, '');
    return o;
});

const addClasses = R.curry((o, c) => {
    R.ap([addClass(o)], c);
    return o;
});

const rAddClass = R.curry((c, o) => addClass(o, c));

function hasClass(o, c) {
    const re = new RegExp(`(^|\\s)${c}(\\s|$)`, 'g');
    return (re.test(o.className));
}

const removeClass = R.curry((o, c) => {
    const re = new RegExp(`(^|\\s)${c}(\\s|$)`, 'g');
    o.className = o.className.replace(re, '$1').replace(/\s+/g, ' ').replace(/(^ | $)/g, '');
});

const toggleClass = R.curry((o, c) => {
    if (hasClass(o, c)) {
        removeClass(o, c);
    } else {
        addClass(o, c);
    }
});

function setClassByCondition(o, c, condition) {
    if (condition) {
        addClass(o, c);
    } else {
        removeClass(o, c);
    }
    return o;
}

function getEl(id) {
    return document.getElementById(id);
}

function queryEl(sel) {
    return document.querySelector(sel);
}

function queryEls(sel) {
    return nl2array(document.querySelectorAll(sel));
}

function queryElEls(el, sel) {
    return nl2array(el.querySelectorAll(sel));
}

function getEls(clazz) {
    return document.getElementsByClassName(clazz);
}

function makeEl(elTag) {
    return document.createElement(elTag);
}

function makeText(text) {
    return document.createTextNode(text);
}

const addEl = R.curry((parent, child) => {
    parent.appendChild(child);
    return parent;
});
const addEls = R.curry((parent, children) => {
    R.ap([addEl(parent)], children);
    return parent;
});

const makeOpt = function (label) {
    const option = makeEl('option');
    addEl(option, (makeText(label)));
    return option;
};

const rAddEl = R.curry((child, parent) => {
    parent.appendChild(child);
    return parent;
});


const setAttr = R.curry((el, name, value) => {
    el.setAttribute(name, value);
    return el;
});

const setStyle = R.curry((el, name, value) => {
    el.style.setProperty(name, value);
    return el;
});

const setImportantStyle = R.curry((el, name, value) => {
    el.style.setProperty(name, value, 'important');
    return el;
});

function delAttr(el, name) {
    el.removeAttribute(name);
    return el;
}

function getAttr(el, name) {
    return el.getAttribute(name);
}

const setProp = R.curry((el, key, value) => {
    el[key] = value;
    return el;
});

const setProps = R.curry((el, map) => {
    for (const key in map) {
        setProp(el, key, map[key]);
    }
    return el;
});

function clearEl(el) {
    Utils.removeChildren(el);
    return el;
}

function passEls(src, dst) {
    for (let i = 0; i < src.children.length; i++) {
        addEl(dst, src.children[i]);
    }
}

const listen = R.curry((el, event, listener) => {
    el.addEventListener(event, listener);
    return el;
});

const listenOnEnter = R.curry((el, callback) => {
    listen(el, 'keydown', (e) => {
        if (e.keyCode === 13) {
            callback();
        }
    });
});

const fillSelector = R.curry((sel, data) => addEls(sel, data.map((item) => {
    const opt = makeEl('option');
    addEl(opt, makeText(item.name));
    if (item.value) { opt.value = item.value; }
    if (item.selected) { opt.selected = true; }
    if (item.className) { addClass(opt, item.className); }
    return opt;
})));

function nl2array(nodeList) {
    return Array.prototype.slice.call(nodeList);
}

const remapProps = R.curry((outKeys, pickKeys, obj) => R.compose(R.zipObj(outKeys), R.values, R.pick(pickKeys))(obj));

const remapProps4Select2 = remapProps(['id', 'text'], ['value', 'displayName']);
const remapProps4Select = remapProps(['value', 'name'], ['value', 'displayName']);

const getSelect2DataCommon = R.curry((preparator, obj) => R.compose(R.zipObj(['data']), R.append(R.__, []), R.map(preparator))(obj));

const getSelect2Data = getSelect2DataCommon(remapProps4Select2);

const makeSelect2Opt = R.compose(R.zipObj(['id', 'text']), R.repeat(R.__, 2));
const arr2Select2 = R.compose(R.assoc('data', R.__, {}), R.map(makeSelect2Opt));
const arr2Select = R.map(R.compose(R.zipObj(['value', 'name']), R.repeat(R.__, 2)));
const constArr2Select = R.map(R.compose(R.zipObj(['value', 'name']), name => [name, constL10n(name)]));

const getSelectedRadio = function (query) {
    const els = document.querySelectorAll(query);
    for (let i = 0; i < els.length; i++) {
        if (els[i].checked === true) {
            return els[i];
        }
    }
    return null;
};

const debugInterceptor = function (callback) {
    return function () {
        console.log(JSON.stringify(arguments[0]));
        callback(...arguments);
    };
};

const Utils = {};

/** opts
    tooltip - add tooltip to button, used for iconic buttons
    id - set button id
    mainPage - enable view as first page
    toggle - toggle content, associated with button
*/
Utils.addView = function (containers, name, view, opts2) {
    const opts = opts2 || {};
    view.init();
    const buttonClass = 'navigation-button';
    containers.root.views[name] = view;
    const button = makeEl('button');
    function delegate() {
        $(button).attr('data-original-title', L10n.getValue(`header-${name}`));
    }
    if (opts.tooltip) {
        L10n.onL10nChange(delegate);
        $(button).tooltip({
            title: L10n.getValue(`header-${name}`),
            placement: 'bottom'
        });
    } else {
        addEl(button, makeText(L10n.getValue(`header-${name}`)));
        setAttr(button, 'l10n-id', `header-${name}`);
    }
    addClass(button, buttonClass);
    addClass(button, `-test-${name}`);
    addClass(button, `-toggle-class-${name}`);
    if (opts.clazz) {
        addClass(button, opts.clazz);
    }
    containers.navigation.appendChild(button);

    const onClickDelegate = function (view2) {
        return function (evt) {
            //Tests.run();
            const elems = containers.navigation.getElementsByClassName(buttonClass);
            if (opts.toggle) {
                const els = getEls(`-toggle-class-${name}`);
                for (let i = 0; i < els.length; i++) {
                    if (evt.target.isEqualNode(els[i])) {
                        continue;
                    }
                    if (hasClass(els[i], 'active')) {
                        els[i].click();
                    }
                }
            }

            const isActive = hasClass(evt.target, 'active');
            for (let i = 0; i < elems.length; i++) {
                removeClass(elems[i], 'active');
            }
            if (!opts.toggle || (opts.toggle && !isActive)) {
                addClass(evt.target, 'active');

                passEls(containers.content, getEl('warehouse'));
                containers.content.appendChild(view2.content);
                removeClass(containers.content, 'hidden');
                containers.root.currentView = view2;
                view2.refresh();
            } else {
                removeClass(evt.target, 'active');
                passEls(containers.content, getEl('warehouse'));
                containers.root.currentView = null;
                addClass(containers.content, 'hidden');
            }
        };
    };

    button.addEventListener('click', onClickDelegate(view));
    if (opts.mainPage) {
        addClass(button, 'active');
        containers.content.appendChild(view.content);
        containers.root.currentView = view;
    }
};

Utils.alert = function (message) {
    vex.dialog.alert(message);
};

Utils.confirm = function (message, onOk, onCancel) {
    vex.dialog.confirm({
        message,
        callback: (val) => {
            if (val) {
                if (onOk) onOk();
            } else if (onCancel) onCancel();
        }
    });
};

Utils.removeChildren = function (myNode) {
    if (!myNode) {
        return;
    }
    while (myNode.firstChild) {
        myNode.removeChild(myNode.firstChild);
    }
};

Utils.processError = function (callback) {
    return function (err) {
        if (err) {
            Utils.handleError(err);
            return;
        }

        if (callback) {
            const arr = [];
            for (let i = 1; i < arguments.length; i++) {
                arr.push(arguments[i]);
            }
            callback(...arr);
        }
    };
};

Utils.handleErrorMsg = function (err) {
    const checkErrorType = R.curry((err2, name) => err2 instanceof Errors[name] || (err2.name && err2.name === name));
    if (R.keys(Errors).some(checkErrorType(err))) {
        return strFormat(getL10n(err.messageId), err.parameters);
    } else if (typeof err === 'object') {
        return err.message;
    }
    return err;
};

Utils.handleError = err => Utils.alert(Utils.handleErrorMsg(err));

Utils.enableEl = R.curry((el, condition) => {
    const key = el.tagName.toLowerCase() === 'textarea' ? 'readonly' : 'disabled';
    if (condition) {
        el.removeAttribute(key);
    } else {
        el.setAttribute(key, key);
    }
});

Utils.enable = function (root, className, condition) {
    nl2array(root.getElementsByClassName(className)).map(Utils.enableEl(R.__, condition));
};

Utils.charOrdAObject = CommonUtils.charOrdAFactory(a => a.displayName.toLowerCase());

Utils.rebuildSelector = function (selector, names) {
    clearEl(selector);
    names.forEach((nameInfo) => {
        const option = makeEl('option');
        option.appendChild(makeText(nameInfo.displayName));
        option.value = nameInfo.value;
        selector.appendChild(option);
    });
};

Utils.rebuildSelectorArr = function (selector, names) {
    clearEl(selector);
    names.forEach((name) => {
        const option = makeEl('option');
        option.appendChild(makeText(name));
        selector.appendChild(option);
    });
};

String.prototype.endsWith = function (suffix) {
    return this.indexOf(suffix, this.length - suffix.length) !== -1;
};

// from date format utils
//For convenience...
Date.prototype.format = function (mask, utc) {
    return dateFormat(this, mask, utc);
};

/*Copyright 2017 Timofey Rechkalov <ntsdk@yandex.ru>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
    limitations under the License. */

'use strict';

((exports) => {
    const state = {};
    state.views = {};

    const btnOpts = {
        tooltip: true,
        className: 'mainNavButton'
    };

    exports.onMasterPageLoad = () => {
        initPage();
        const LocalDBMS = makeLocalDBMS(true);
        if (MODE === 'Standalone') {
            window.DBMS = new LocalDBMS();
            DBMS.setDatabase(BaseExample.data, (err) => {
                if (err) { Utils.handleError(err); return; }
                consistencyCheck(onDatabaseLoad);
            });
        } else if (MODE === 'NIMS_Server') {
            const RemoteDBMS = makeRemoteDBMS(LocalDBMS);
            window.DBMS = new RemoteDBMS();
            consistencyCheck(onDatabaseLoad);
        }
    };

    function onDatabaseLoad() {
        //        initTheme();

        stateInit();

        Utils.addView(state.containers, 'performance', Performance, { mainPage: true });
        //        Utils.addView(state.containers, 'instruction', Instruction);

        addEl(state.navigation, addClass(makeEl('div'), 'nav-separator'));

        Utils.addView(state.containers, 'about', About);

        addEl(state.navigation, makeButton('testButton', 'test', runTests, btnOpts));

        const button = makeButton('dataLoadButton', 'open-database', null, btnOpts);
        button.addEventListener('change', FileUtils.readSingleFile, false);

        const input = makeEl('input');
        input.type = 'file';
        addClass(input, 'hidden');
        setAttr(input, 'tabindex', -1);
        button.appendChild(input);
        button.addEventListener('click', (e) => {
            input.value = '';
            input.click();
        });
        addEl(state.navigation, button);

        //                addEl(state.navigation, makeButton("themeButton", "theme", () => nextTheme(), btnOpts));
        addEl(state.navigation, makeButton('dataSaveButton', 'save-database', FileUtils.saveFile, btnOpts));
        //if (MODE === 'Standalone') {
        //  addEl(state.navigation, makeButton('newBaseButton', 'create-database', FileUtils.makeNewBase, btnOpts));
        //}
        //addEl(state.navigation, makeButton("mainHelpButton", "docs", FileUtils.openHelp, btnOpts));

        //        addEl(state.navigation, makeL10nButton());

        //        Utils.addView(state.containers, 'logViewer', LogViewer2, { clazz: 'logViewerButton', tooltip: true });
        //        addEl(state.navigation, makeButton('testButton', 'test', runTests, btnOpts));

        //addEl(state.navigation, makeButton("refreshButton", "refresh", () => state.currentView.refresh(), btnOpts));

        FileUtils.init((err) => {
            if (err) { Utils.handleError(err); return; }
            consistencyCheck(state.currentView.refresh);
        });

        state.currentView.refresh();
        addBeforeUnloadListener();
    }

    function initPage() {
        L10n.localizeStatic();
        L10n.onL10nChange(() => state.currentView.refresh());
        UI.initSelectorFilters();
        UI.initPanelTogglers();
        function updateDialogs() {
            vex.dialog.buttons.YES.text = getL10n('common-ok');
            vex.dialog.buttons.NO.text = getL10n('common-cancel');
        }
        updateDialogs();
        L10n.onL10nChange(updateDialogs);
    }

    //    var curTheme = Constants.themeList[1];
    //
    //    var initTheme = function() {
    //        if(DBMS.setTheme){
    //            DBMS.getTheme(function(err, theme){
    //                if(err) {console.log(err);}
    //                if(theme !== ''){
    //                    curTheme = theme;
    //                }
    //                addClass(queryEl('body'), curTheme);
    //            });
    //        } else {
    //            addClass(queryEl('body'), curTheme);
    //        }
    //    };
    //
    //    var nextTheme = function() {
    //        removeClass(queryEl('body'), curTheme);
    //        curTheme = Constants.themeList[(R.indexOf(curTheme, Constants.themeList)+1)%Constants.themeList.length];
    //        addClass(queryEl('body'), curTheme);
    //        if(DBMS.setTheme){
    //            DBMS.setTheme(curTheme, function(err){
    //                if(err) {console.log(err); return;}
    //            });
    //        }
    //    };

    function consistencyCheck(callback) {
        DBMS.getConsistencyCheckResult((err, consistencyErrors) => {
            if (err) { Utils.handleError(err); return; }
            consistencyErrors.forEach(CommonUtils.consoleLog);
            if (consistencyErrors.length > 0) {
                Utils.alert(getL10n('overview-consistency-problem-detected'));
            } else {
                console.log('Consistency check didn\'t find errors');
            }
            callback();
        });
    }

    function stateInit() {
        state.navigation = getEl('navigation');
        state.containers = {
            root: state,
            navigation: state.navigation,
            content: getEl('contentArea')
        };
    }

    function runTests() {
        DBMS.getConsistencyCheckResult((err, consistencyErrors) => {
            if (err) { Utils.handleError(err); return; }
            consistencyErrors.forEach(CommonUtils.consoleLog);
            if (consistencyErrors.length > 0) {
                Utils.alert(getL10n('overview-consistency-problem-detected'));
            } else {
                Utils.alert(getL10n('overview-consistency-is-ok'));
                console.log('Consistency check didn\'t find errors');
            }
        });
    }

    function makeButton(clazz, name, callback, opts) {
        const button = makeEl('button');
        addClass(button, clazz);
        function delegate() {
            $(button).attr('data-original-title', L10n.getValue(`header-${name}`));
        }
        if (opts.tooltip) {
            L10n.onL10nChange(delegate);
            $(button).tooltip({
                title: L10n.getValue(`header-${name}`),
                placement: 'bottom'
            });
        }
        addClass(button, 'action-button');
        if (opts.className) {
            addClass(button, opts.className);
        }
        if (callback) {
            listen(button, 'click', callback);
        }
        return button;
    }

    function makeL10nButton() {
        const l10nBtn = makeButton('toggleL10nButton', 'l10n', L10n.toggleL10n, btnOpts);
        function setIcon() {
            l10nBtn.style.backgroundImage = strFormat('url("./images/{0}.svg")', [getL10n('header-dictionary-icon')]);
        }
        L10n.onL10nChange(setIcon);
        setIcon();
        return l10nBtn;
    }

    function addBeforeUnloadListener() {
        window.onbeforeunload = (evt) => {
            const message = getL10n('utils-close-page-warning');
            if (typeof evt === 'undefined') {
                evt = window.event;
            }
            if (evt) {
                evt.returnValue = message;
            }
            return message;
        };
    }
})(this.PageManager = {});

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImpzL2RibXMvbG9jYWxEQk1TLmpzIiwiLi4vY29yZS9qcy9maWxlVXRpbHMuanMiLCIuLi9jb3JlL2pzL2wxMG4uanMiLCIuLi9jb3JlL2pzL3VpVXRpbHMuanMiLCIuLi9jb3JlL2pzL3V0aWxzLmpzIiwianMvcGFnZU1hbmFnZXIuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNuREE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ3hGQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ3RHQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUN6UkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ25aQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSIsImZpbGUiOiJzY3JpcHRzLm1pbi5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qQ29weXJpZ2h0IDIwMTcgVGltb2ZleSBSZWNoa2Fsb3YgPG50c2RrQHlhbmRleC5ydT5cclxuXHJcbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XHJcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cclxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XHJcblxyXG5odHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcclxuXHJcblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcclxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxyXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cclxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxyXG4gICAgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuICovXHJcblxyXG4ndXNlIHN0cmljdCc7XHJcblxyXG5mdW5jdGlvbiBtYWtlTG9jYWxEQk1TKGZ1bGxWZXJzaW9uKSB7XHJcbiAgICBjb25zdCBvcHRzID0ge1xyXG4gICAgICAgIE1pZ3JhdG9yLFxyXG4gICAgICAgIENvbW1vblV0aWxzLFxyXG4gICAgICAgIEV2ZW50RW1pdHRlcixcclxuICAgICAgICBQcmVjb25kaXRpb24sXHJcbiAgICAgICAgUixcclxuICAgICAgICBBanYsXHJcbiAgICAgICAgU2NoZW1hLFxyXG4gICAgICAgIEVycm9ycyxcclxuICAgICAgICBsaXN0ZW5lcnM6IHt9LFxyXG4gICAgICAgIENvbnN0YW50cyxcclxuICAgICAgICBkYm1zVXRpbHM6IHt9LFxyXG4gICAgICAgIGRhdGVGb3JtYXQsXHJcbiAgICB9O1xyXG5cclxuICAgIGZ1bmN0aW9uIExvY2FsREJNUygpIHtcclxuICAgICAgICB0aGlzLl9pbml0KG9wdHMubGlzdGVuZXJzKTtcclxuICAgIH1cclxuXHJcbiAgICBMb2NhbERCTVMucHJvdG90eXBlLmdldFNldHRpbmdzID0gKCkgPT4gdGhpcy5kYXRhYmFzZS5TZXR0aW5ncztcclxuXHJcbiAgICBjb25zdCBmdW5jID0gbmFtZSA9PiB3aW5kb3dbbmFtZV0oTG9jYWxEQk1TLCBvcHRzKTtcclxuXHJcbiAgICBbXHJcbiAgICAgICAgJ2Jhc2VBUEknLFxyXG4gICAgICAgICdjb25zaXN0ZW5jeUNoZWNrQVBJJyxcclxuICAgICAgICAvLyAgICAgICAgJ2xvZ0FQSScsXHJcbiAgICAgICAgLy8gICAgICAgICdjaGFyc2hlZXRBUEknLFxyXG4gICAgICAgIC8vICAgICAgICAnc2V0dGluZ3NBUEknLFxyXG4gICAgXS5tYXAoZnVuYyk7XHJcblxyXG4gICAgLy8gICAgTG9nZ2VyLmF0dGFjaExvZ0NhbGxzKExvY2FsREJNUywgUiwgZmFsc2UpO1xyXG4gICAgcmV0dXJuIExvY2FsREJNUztcclxufVxyXG4iLCIvKkNvcHlyaWdodCAyMDE1LTIwMTcgVGltb2ZleSBSZWNoa2Fsb3YgPG50c2RrQHlhbmRleC5ydT4sIE1hcmlhIFNpZGVraG1lbm92YSA8bWF0aWxkYV9AbGlzdC5ydT5cclxuXHJcbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XHJcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cclxuWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XHJcblxyXG5odHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcclxuXHJcblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcclxuZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxyXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cclxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxyXG4gICAgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuICovXHJcblxyXG4ndXNlIHN0cmljdCc7XHJcblxyXG4oKGV4cG9ydHMpID0+IHtcclxuICAgIGNvbnN0IHN0YXRlID0ge307XHJcblxyXG4gICAgZXhwb3J0cy5pbml0ID0gKGNhbGxiYWNrKSA9PiB7XHJcbiAgICAgICAgc3RhdGUuY2FsbGJhY2sgPSBjYWxsYmFjaztcclxuICAgIH07XHJcblxyXG4gICAgZXhwb3J0cy5tYWtlTmV3QmFzZSA9ICgpID0+IHtcclxuICAgICAgICBVdGlscy5jb25maXJtKGdldEwxMG4oJ3V0aWxzLW5ldy1iYXNlLXdhcm5pbmcnKSwgKCkgPT4ge1xyXG4gICAgICAgICAgICBEQk1TLnNldERhdGFiYXNlKENvbW1vblV0aWxzLmNsb25lKEVtcHR5QmFzZS5kYXRhKSwgc3RhdGUuY2FsbGJhY2spO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuXHJcbiAgICBleHBvcnRzLm9wZW5IZWxwID0gKCkgPT4ge1xyXG4gICAgICAgIHdpbmRvdy5vcGVuKCdleHRyYXMvZG9jL25pbXMuaHRtbCcpO1xyXG4gICAgfTtcclxuXHJcbiAgICBleHBvcnRzLnJlYWRTaW5nbGVGaWxlID0gKGV2dCkgPT4ge1xyXG4gICAgICAgIC8vIFJldHJpZXZlIHRoZSBmaXJzdCAoYW5kIG9ubHkhKSBGaWxlIGZyb20gdGhlIEZpbGVMaXN0IG9iamVjdFxyXG4gICAgICAgIGNvbnN0IGYgPSBldnQudGFyZ2V0LmZpbGVzWzBdO1xyXG5cclxuICAgICAgICBpZiAoZikge1xyXG4gICAgICAgICAgICBjb25zdCByID0gbmV3IEZpbGVSZWFkZXIoKTtcclxuICAgICAgICAgICAgci5vbmxvYWQgPSAoZSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgY29udGVudHMgPSBlLnRhcmdldC5yZXN1bHQ7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBkYXRhYmFzZSA9IEpTT04ucGFyc2UoY29udGVudHMpO1xyXG4gICAgICAgICAgICAgICAgREJNUy5zZXREYXRhYmFzZShkYXRhYmFzZSwgc3RhdGUuY2FsbGJhY2spO1xyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICByLnJlYWRBc1RleHQoZik7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgVXRpbHMuYWxlcnQoZ2V0TDEwbigndXRpbHMtYmFzZS1maWxlLWxvYWRpbmctZXJyb3InKSk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuXHJcbiAgICBleHBvcnRzLnNhdmVGaWxlID0gKCkgPT4ge1xyXG4gICAgICAgIERCTVMuZ2V0RGF0YWJhc2UoKGVyciwgZGF0YWJhc2UpID0+IHtcclxuICAgICAgICAgICAgaWYgKGVycikgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgZXhwb3J0cy5qc29uMkZpbGUoZGF0YWJhc2UsIGAke0JBU0VfRklMRV9OQU1FfS5qc29uYCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG5cclxuICAgIGV4cG9ydHMuanNvbjJGaWxlID0gKHN0ciwgZmlsZU5hbWUpID0+IHtcclxuICAgICAgICBleHBvcnRzLnN0cjJGaWxlKEpTT04uc3RyaW5naWZ5KHN0ciwgbnVsbCwgJyAgJyksIGZpbGVOYW1lKTtcclxuICAgIH07XHJcblxyXG4gICAgZXhwb3J0cy5zdHIyRmlsZSA9IChzdHIsIGZpbGVOYW1lKSA9PiB7XHJcbiAgICAgICAgY29uc3QgYmxvYiA9IG5ldyBCbG9iKFtzdHJdLCB7XHJcbiAgICAgICAgICAgIHR5cGU6ICd0ZXh0L3BsYWluO2NoYXJzZXQ9dXRmLTgnXHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgc2F2ZUFzKGJsb2IsIGZpbGVOYW1lKTtcclxuICAgIH07XHJcblxyXG4gICAgZnVuY3Rpb24gcHJlcHJvY2Vzc0NzdlN0cihzdHIpIHtcclxuICAgICAgICBpZiAoISh0eXBlb2Ygc3RyID09PSAnc3RyaW5nJyB8fCBzdHIgaW5zdGFuY2VvZiBTdHJpbmcpKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBzdHI7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGxldCByZXN1bHQgPSBzdHIucmVwbGFjZSgvXCIvZywgJ1wiXCInKTtcclxuICAgICAgICBpZiAocmVzdWx0LnNlYXJjaCgvKFwifCx8XFxuKS9nKSA+PSAwKSB7XHJcbiAgICAgICAgICAgIHJlc3VsdCA9IGBcIiR7cmVzdWx0fVwiYDtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcclxuICAgIH1cclxuXHJcbiAgICBleHBvcnRzLmFycjJkMkNzdiA9IChhcnIsIGZpbGVOYW1lKSA9PiB7XHJcbiAgICAgICAgY29uc3QgY3N2ID0gYFxcdWZlZmYke2Fyci5tYXAoZGF0YUFycmF5ID0+IGRhdGFBcnJheS5tYXAocHJlcHJvY2Vzc0NzdlN0cikuam9pbignOycpKS5qb2luKCdcXG4nKX1gO1xyXG5cclxuICAgICAgICBjb25zdCBvdXQgPSBuZXcgQmxvYihbY3N2XSwge1xyXG4gICAgICAgICAgICB0eXBlOiAndGV4dC9jc3Y7Y2hhcnNldD11dGYtODsnXHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgc2F2ZUFzKG91dCwgJ3RhYmxlLmNzdicpO1xyXG4gICAgfTtcclxufSkodGhpcy5GaWxlVXRpbHMgPSB7fSk7XHJcbiIsIi8qQ29weXJpZ2h0IDIwMTUtMjAxNyBUaW1vZmV5IFJlY2hrYWxvdiA8bnRzZGtAeWFuZGV4LnJ1PiwgTWFyaWEgU2lkZWtobWVub3ZhIDxtYXRpbGRhX0BsaXN0LnJ1PlxyXG5cclxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcclxueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxyXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcclxuXHJcbmh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxyXG5cclxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxyXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXHJcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxyXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXHJcbiAgICBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4gKi9cclxuXHJcbid1c2Ugc3RyaWN0JztcclxuXHJcbi8qIGVzbGludC1kaXNhYmxlIG5vLXZhcix2YXJzLW9uLXRvcCAqL1xyXG5cclxuKChleHBvcnRzLCBEaWN0aW9uYXJpZXMpID0+IHtcclxuICAgIGNvbnN0IHN0YXRlID0ge307XHJcblxyXG4gICAgc3RhdGUuaW5pdGlhbGl6ZWQgPSBmYWxzZTtcclxuICAgIHN0YXRlLmwxMG5EZWxlZ2F0ZXMgPSBbXTtcclxuICAgIHN0YXRlLmRpY3Rpb25hcmllcyA9IHt9O1xyXG4gICAgc3RhdGUubGFuZyA9IGRlZmF1bHRMYW5nO1xyXG5cclxuICAgIGNvbnN0IGluaXQgPSAoKSA9PiB7XHJcbiAgICAgICAgaWYgKHN0YXRlLmluaXRpYWxpemVkKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgLy8gICAgICAgIGNvbnNvbGUubG9nKG5hdmlnYXRvci5sYW5ndWFnZSk7XHJcblxyXG4gICAgICAgIHN0YXRlLmRpY3Rpb25hcmllcyA9IFIubWFwKHByb2Nlc3NEaWN0aW9uYXJ5LCBEaWN0aW9uYXJpZXMpO1xyXG5cclxuICAgICAgICAvLyAgICB2YXIgbGFuZyA9IChuYXZpZ2F0b3IubGFuZ3VhZ2VzID8gbmF2aWdhdG9yLmxhbmd1YWdlc1swXSA6IG5hdmlnYXRvci5icm93c2VyTGFuZ3VhZ2UpLnNwbGl0KCctJylbMF07XHJcbiAgICAgICAgLy8gICAgdmFyIGxhbmcgPSAncnUnO1xyXG4gICAgICAgIC8vICAgICAgICB2YXIgbGFuZyA9IGRlZmF1bHRMYW5nO1xyXG4gICAgICAgIC8vICAgICAgICBjb25zb2xlLmxvZyhsYW5nKTtcclxuXHJcbiAgICAgICAgaWYgKHN0YXRlLmRpY3Rpb25hcmllc1tkZWZhdWx0TGFuZ10pIHtcclxuICAgICAgICAgICAgc3RhdGUuZGljdCA9IHN0YXRlLmRpY3Rpb25hcmllc1tkZWZhdWx0TGFuZ107XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgc3RhdGUuZGljdCA9IHN0YXRlLmRpY3Rpb25hcmllcy5lbjtcclxuICAgICAgICB9XHJcbiAgICAgICAgc2V0SHRtbExhbmcoZGVmYXVsdExhbmcpO1xyXG4gICAgICAgIGV4cG9ydHMub25MMTBuQ2hhbmdlKGV4cG9ydHMubG9jYWxpemVTdGF0aWMpO1xyXG4gICAgICAgIHN0YXRlLmluaXRpYWxpemVkID0gdHJ1ZTtcclxuICAgIH07XHJcblxyXG4gICAgdmFyIHByb2Nlc3NEaWN0aW9uYXJ5ID0gKGRpY3Rpb25hcnkpID0+IHtcclxuICAgICAgICBjb25zdCBwcm9jZXNzZWREaWN0aW9uYXJ5ID0ge307XHJcbiAgICAgICAgUi50b1BhaXJzKGRpY3Rpb25hcnkpLmZvckVhY2goKFtzZWN0aW9uTmFtZSwgc2VjdGlvbl0pID0+IHtcclxuICAgICAgICAgICAgUi50b1BhaXJzKHNlY3Rpb24pLmZvckVhY2goKFtrZXksIHZhbHVlXSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgcHJvY2Vzc2VkRGljdGlvbmFyeVtgJHtzZWN0aW9uTmFtZX0tJHtrZXl9YF0gPSB2YWx1ZTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgLy8gICAgICAgIGZvciAoY29uc3Qgc2VjdGlvbk5hbWUgaW4gZGljdGlvbmFyeSkge1xyXG4gICAgICAgIC8vICAgICAgICAgICAgZm9yIChjb25zdCBuYW1lIGluIGRpY3Rpb25hcnlbc2VjdGlvbk5hbWVdKSB7XHJcbiAgICAgICAgLy8gICAgICAgICAgICAgICAgcHJvY2Vzc2VkRGljdGlvbmFyeVtgJHtzZWN0aW9uTmFtZX0tJHtuYW1lfWBdID0gZGljdGlvbmFyeVtzZWN0aW9uTmFtZV1bbmFtZV07XHJcbiAgICAgICAgLy8gICAgICAgICAgICB9XHJcbiAgICAgICAgLy8gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gcHJvY2Vzc2VkRGljdGlvbmFyeTtcclxuICAgIH07XHJcblxyXG4gICAgdmFyIHNldEh0bWxMYW5nID0gbGFuZyA9PiBzZXRBdHRyKGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdodG1sJylbMF0sICdsYW5nJywgbGFuZyk7XHJcblxyXG4gICAgZXhwb3J0cy50b2dnbGVMMTBuID0gKCkgPT4ge1xyXG4gICAgICAgIGlmIChzdGF0ZS5sYW5nID09PSAncnUnKSB7XHJcbiAgICAgICAgICAgIHN0YXRlLmRpY3QgPSBzdGF0ZS5kaWN0aW9uYXJpZXMuZW47XHJcbiAgICAgICAgICAgIHN0YXRlLmxhbmcgPSAnZW4nO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHN0YXRlLmRpY3QgPSBzdGF0ZS5kaWN0aW9uYXJpZXMucnU7XHJcbiAgICAgICAgICAgIHN0YXRlLmxhbmcgPSAncnUnO1xyXG4gICAgICAgIH1cclxuICAgICAgICBzZXRIdG1sTGFuZyhzdGF0ZS5sYW5nKTtcclxuICAgICAgICBzdGF0ZS5sMTBuRGVsZWdhdGVzLmZvckVhY2goKGRlbGVnYXRlKSA9PiB7XHJcbiAgICAgICAgICAgIGRlbGVnYXRlKCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG5cclxuICAgIGV4cG9ydHMuZ2V0TGFuZyA9ICgpID0+IHN0YXRlLmxhbmcudG9Mb3dlckNhc2UoKTtcclxuXHJcbiAgICBleHBvcnRzLmZvcm1hdCA9IFIuY3VycnkoKG5hbWVzcGFjZSwgbmFtZSwgYXJncykgPT4gc3RyRm9ybWF0KGV4cG9ydHMuZ2V0KG5hbWVzcGFjZSwgbmFtZSksIGFyZ3MpKTtcclxuXHJcbiAgICBleHBvcnRzLmdldCA9IFIuY3VycnkoKG5hbWVzcGFjZSwgbmFtZSkgPT4gTDEwbi5nZXRWYWx1ZShgJHtuYW1lc3BhY2V9LSR7bmFtZX1gKSk7XHJcblxyXG4gICAgZXhwb3J0cy5nZXRWYWx1ZSA9IChuYW1lKSA9PiB7XHJcbiAgICAgICAgY29uc3QgdmFsdWUgPSBzdGF0ZS5kaWN0W25hbWVdO1xyXG4gICAgICAgIGlmICh2YWx1ZSA9PT0gdW5kZWZpbmVkKSBjb25zb2xlLmxvZyhgVmFsdWUgaXMgbm90IGZvdW5kOiAke25hbWV9YCk7XHJcbiAgICAgICAgcmV0dXJuIHZhbHVlIHx8IGAke25hbWV9OlJBIFJBLUFILUFILUFIIFJPTUEgUk9NQS1NQSBHQUdBIE9IIExBLUxBYDtcclxuICAgIH07XHJcblxyXG4gICAgZXhwb3J0cy5vbkwxMG5DaGFuZ2UgPSAoZGVsZWdhdGUpID0+IHtcclxuICAgICAgICBzdGF0ZS5sMTBuRGVsZWdhdGVzLnB1c2goZGVsZWdhdGUpO1xyXG4gICAgfTtcclxuXHJcbiAgICBleHBvcnRzLmxvY2FsaXplU3RhdGljID0gKCkgPT4ge1xyXG4gICAgICAgIGluaXQoKTtcclxuICAgICAgICBubDJhcnJheShkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCdbbDEwbi1pZF0nKSkubWFwKGVsID0+IGFkZEVsKGNsZWFyRWwoZWwpLCBtYWtlVGV4dChleHBvcnRzLmdldFZhbHVlKGdldEF0dHIoZWwsICdsMTBuLWlkJykpKSkpO1xyXG4gICAgICAgIG5sMmFycmF5KGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJ1tsMTBuLXBsYWNlaG9sZGVyLWlkXScpKS5tYXAoZWwgPT4gc2V0QXR0cihlbCwgJ3BsYWNlaG9sZGVyJywgZXhwb3J0cy5nZXRWYWx1ZShnZXRBdHRyKGVsLCAnbDEwbi1wbGFjZWhvbGRlci1pZCcpKSkpO1xyXG4gICAgfTtcclxufSkodGhpcy5MMTBuID0ge30sIERpY3Rpb25hcmllcyk7XHJcbiIsIi8qQ29weXJpZ2h0IDIwMTUtMjAxNyBUaW1vZmV5IFJlY2hrYWxvdiA8bnRzZGtAeWFuZGV4LnJ1PiwgTWFyaWEgU2lkZWtobWVub3ZhIDxtYXRpbGRhX0BsaXN0LnJ1PlxyXG5cclxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcclxueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxyXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcclxuXHJcbmh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxyXG5cclxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxyXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXHJcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxyXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXHJcbiAgICBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4gKi9cclxuXHJcbid1c2Ugc3RyaWN0JztcclxuXHJcbi8qIGVzbGludC1kaXNhYmxlIG5vLXZhcix2YXJzLW9uLXRvcCAqL1xyXG5cclxuKChleHBvcnRzKSA9PiB7XHJcbiAgICBleHBvcnRzLmluaXRUYWJQYW5lbCA9ICh0YWJDbGF6eiwgY29udGFpbmVyQ2xhenopID0+IHtcclxuICAgICAgICBjb25zdCBjb250YWluZXJzID0gZ2V0RWxzKGNvbnRhaW5lckNsYXp6KTtcclxuXHJcbiAgICAgICAgbGV0IGk7XHJcbiAgICAgICAgZm9yIChpID0gMTsgaSA8IGNvbnRhaW5lcnMubGVuZ3RoOyBpKyspIHsgLy8gZG9uJ3QgaGlkZSAxc3QgZWxlbWVudFxyXG4gICAgICAgICAgICBhZGRDbGFzcyhjb250YWluZXJzW2ldLCAnaGlkZGVuJyk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCB0YWJCdXR0b25zID0gZ2V0RWxzKHRhYkNsYXp6KTtcclxuXHJcbiAgICAgICAgYWRkQ2xhc3ModGFiQnV0dG9uc1swXSwgJ2FjdGl2ZScpO1xyXG5cclxuICAgICAgICBmb3IgKGkgPSAwOyBpIDwgdGFiQnV0dG9ucy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICBsaXN0ZW4odGFiQnV0dG9uc1tpXSwgJ2NsaWNrJywgdGFiQnV0dG9uQ2xpY2sodGFiQnV0dG9ucywgY29udGFpbmVycykpO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcblxyXG4gICAgdmFyIHRhYkJ1dHRvbkNsaWNrID0gKGJ1dHRvbnMsIGNvbnRhaW5lcnMpID0+IChldmVudCkgPT4ge1xyXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYnV0dG9ucy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICBzZXRDbGFzc0J5Q29uZGl0aW9uKGJ1dHRvbnNbaV0sICdhY3RpdmUnLCBldmVudC50YXJnZXQuaWQgPT09IGJ1dHRvbnNbaV0uaWQpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNvbnRhaW5lcnMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgc2V0Q2xhc3NCeUNvbmRpdGlvbihjb250YWluZXJzW2ldLCAnaGlkZGVuJywgYCR7ZXZlbnQudGFyZ2V0LmlkfUNvbnRhaW5lcmAgIT09IGNvbnRhaW5lcnNbaV0uaWQpO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcblxyXG4gICAgZXhwb3J0cy5maWxsU2hvd0l0ZW1TZWxlY3RvciA9IChzZWxlY3RvciwgZGlzcGxheUFycmF5KSA9PiB7XHJcbiAgICAgICAgbGV0IGVsO1xyXG4gICAgICAgIHNldEF0dHIoc2VsZWN0b3IsICdzaXplJywgZGlzcGxheUFycmF5Lmxlbmd0aCk7XHJcbiAgICAgICAgZGlzcGxheUFycmF5LmZvckVhY2goKHZhbHVlKSA9PiB7XHJcbiAgICAgICAgICAgIGVsID0gc2V0UHJvcHMobWFrZUVsKCdvcHRpb24nKSwge1xyXG4gICAgICAgICAgICAgICAgc2VsZWN0ZWQ6IHRydWUsXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICBzZXRDbGFzc0J5Q29uZGl0aW9uKGVsLCAnaGlkZGVuJywgdmFsdWUuaGlkZGVuKTtcclxuICAgICAgICAgICAgYWRkRWwoc2VsZWN0b3IsIGFkZEVsKGVsLCBtYWtlVGV4dCh2YWx1ZS5uYW1lKSkpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuXHJcbiAgICBleHBvcnRzLmZpbGxTaG93SXRlbVNlbGVjdG9yMiA9IChzZWxlY3Rvciwgb3B0aW9uR3JvdXBzKSA9PiB7XHJcbiAgICAgICAgbGV0IGVsLCBncm91cEVsLCBjb3VudGVyID0gMDtcclxuICAgICAgICBhZGRFbHMoc2VsZWN0b3IsIG9wdGlvbkdyb3Vwcy5tYXAoKGdyb3VwKSA9PiB7XHJcbiAgICAgICAgICAgIGNvdW50ZXIrKztcclxuICAgICAgICAgICAgZ3JvdXBFbCA9IHNldEF0dHIobWFrZUVsKCdvcHRncm91cCcpLCAnbGFiZWwnLCBncm91cC5uYW1lKTtcclxuICAgICAgICAgICAgYWRkRWxzKGdyb3VwRWwsIGdyb3VwLmFycmF5Lm1hcCgodmFsdWUpID0+IHtcclxuICAgICAgICAgICAgICAgIGVsID0gc2V0UHJvcHMobWFrZUVsKCdvcHRpb24nKSwge1xyXG4gICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkOiB0cnVlLFxyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICBzZXRDbGFzc0J5Q29uZGl0aW9uKGVsLCAnaGlkZGVuJywgdmFsdWUuaGlkZGVuKTtcclxuICAgICAgICAgICAgICAgIGNvdW50ZXIgKz0gKHZhbHVlLmhpZGRlbiA/IDAgOiAxKTtcclxuICAgICAgICAgICAgICAgIHJldHVybiBhZGRFbChlbCwgbWFrZVRleHQodmFsdWUubmFtZSkpO1xyXG4gICAgICAgICAgICB9KSk7XHJcbiAgICAgICAgICAgIHJldHVybiBncm91cEVsO1xyXG4gICAgICAgIH0pKTtcclxuICAgICAgICBzZXRBdHRyKHNlbGVjdG9yLCAnc2l6ZScsIGNvdW50ZXIpO1xyXG4gICAgfTtcclxuXHJcbiAgICBleHBvcnRzLnNob3dTZWxlY3RlZEVscyA9IGNsYXNzS2V5ID0+IChldmVudCkgPT4ge1xyXG4gICAgICAgIGNvbnN0IGVsID0gZXZlbnQudGFyZ2V0O1xyXG4gICAgICAgIGxldCBlbHMsIGksIGo7XHJcbiAgICAgICAgZm9yIChpID0gMDsgaSA8IGVsLm9wdGlvbnMubGVuZ3RoOyBpICs9IDEpIHtcclxuICAgICAgICAgICAgZWxzID0gZ2V0RWxzKGkgKyBjbGFzc0tleSk7XHJcbiAgICAgICAgICAgIGZvciAoaiA9IDA7IGogPCBlbHMubGVuZ3RoOyBqKyspIHtcclxuICAgICAgICAgICAgICAgIHNldENsYXNzQnlDb25kaXRpb24oZWxzW2pdLCAnaGlkZGVuJywgIWVsLm9wdGlvbnNbaV0uc2VsZWN0ZWQpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuXHJcbiAgICBleHBvcnRzLmluaXRTZWxlY3RvckZpbHRlcnMgPSAoKSA9PiB7XHJcbiAgICAgICAgY29uc3QgZWxlbXMgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCdbc2VsZWN0b3ItZmlsdGVyXScpO1xyXG4gICAgICAgIGxldCBlbCwgc2VsO1xyXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZWxlbXMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgZWwgPSBlbGVtc1tpXTtcclxuICAgICAgICAgICAgc2VsID0gcXVlcnlFbChnZXRBdHRyKGVsLCAnc2VsZWN0b3ItZmlsdGVyJykpO1xyXG4gICAgICAgICAgICBlbC52YWx1ZSA9ICcnO1xyXG4gICAgICAgICAgICBsaXN0ZW4oZWwsICdpbnB1dCcsIGZpbHRlck9wdGlvbnMoc2VsKSk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuXHJcbiAgICB2YXIgZmlsdGVyT3B0aW9ucyA9IHNlbCA9PiAoZXZlbnQpID0+IHtcclxuICAgICAgICBsZXQgdmFsID0gZXZlbnQudGFyZ2V0LnZhbHVlO1xyXG4gICAgICAgIGxldCBpLCBvcHQ7XHJcbiAgICAgICAgdmFsID0gQ29tbW9uVXRpbHMuZ2xvYlN0cmluZ1RvUmVnZXgodmFsLnRyaW0oKS50b0xvd2VyQ2FzZSgpKTtcclxuICAgICAgICBmb3IgKGkgPSAwOyBpIDwgc2VsLm9wdGlvbnMubGVuZ3RoOyBpICs9IDEpIHtcclxuICAgICAgICAgICAgb3B0ID0gc2VsLm9wdGlvbnNbaV07XHJcbiAgICAgICAgICAgIGNvbnN0IGlzVmlzaWJsZSA9IG9wdC5pbm5lckhUTUwudG9Mb3dlckNhc2UoKS5zZWFyY2godmFsKSAhPT0gLTE7XHJcbiAgICAgICAgICAgIGlmICghaXNWaXNpYmxlKSB7XHJcbiAgICAgICAgICAgICAgICBvcHQuc2VsZWN0ZWQgPSBmYWxzZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBzZXRDbGFzc0J5Q29uZGl0aW9uKG9wdCwgJ2hpZGRlbicsICFpc1Zpc2libGUpO1xyXG4gICAgICAgICAgICAvLyAgICAgICAgICAgICAgICBzZXRDbGFzc0J5Q29uZGl0aW9uKG9wdCwgXCJoaWRkZW5cIiwgb3B0LmlubmVySFRNTC50b0xvd2VyQ2FzZSgpLnNlYXJjaCh2YWwpID09PSAtMSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHNlbC5kaXNwYXRjaEV2ZW50KG5ldyBFdmVudCgnY2hhbmdlJykpO1xyXG4gICAgfTtcclxuXHJcbiAgICBleHBvcnRzLmluaXRQYW5lbFRvZ2dsZXJzID0gKCkgPT4ge1xyXG4gICAgICAgIGNvbnN0IGVsZW1zID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnW3BhbmVsLXRvZ2dsZXJdJyk7XHJcbiAgICAgICAgbGV0IGVsLCBzZWwsIGF0dHI7XHJcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBlbGVtcy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICBlbCA9IGVsZW1zW2ldO1xyXG4gICAgICAgICAgICBhdHRyID0gZ2V0QXR0cihlbCwgJ3BhbmVsLXRvZ2dsZXInKTtcclxuICAgICAgICAgICAgc2VsID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihhdHRyKTtcclxuICAgICAgICAgICAgaWYgKHNlbCA9PSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICBVdGlscy5hbGVydChgUGFuZWwgdG9nZ2xlciBpcyBicm9rZW46ICR7YXR0cn1gKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBsaXN0ZW4oZWwsICdjbGljaycsIGV4cG9ydHMudG9nZ2xlUGFuZWwoc2VsKSk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuXHJcbiAgICBleHBvcnRzLnRvZ2dsZVBhbmVsID0gc2VsID0+IChldmVudCkgPT4ge1xyXG4gICAgICAgIHRvZ2dsZUNsYXNzKHNlbCwgJ2hpZGRlbicpO1xyXG4gICAgfTtcclxuXHJcbiAgICBleHBvcnRzLm1ha2VFdmVudFRpbWVQaWNrZXIgPSAob3B0cykgPT4ge1xyXG4gICAgICAgIGNvbnN0IGlucHV0ID0gbWFrZUVsKCdpbnB1dCcpO1xyXG4gICAgICAgIFIuYXAoW2FkZENsYXNzKGlucHV0KV0sIG9wdHMuZXh0cmFDbGFzc2VzKTtcclxuICAgICAgICBhZGRDbGFzcyhpbnB1dCwgJ2V2ZW50VGltZScpO1xyXG4gICAgICAgIGlucHV0LnZhbHVlID0gb3B0cy5ldmVudFRpbWU7XHJcblxyXG4gICAgICAgIGlucHV0LmV2ZW50SW5kZXggPSBvcHRzLmluZGV4O1xyXG5cclxuICAgICAgICBjb25zdCBwaWNrZXJPcHRzID0ge1xyXG4gICAgICAgICAgICBsYW5nOiBMMTBuLmdldExhbmcoKSxcclxuICAgICAgICAgICAgbWFzazogdHJ1ZSxcclxuICAgICAgICAgICAgc3RhcnREYXRlOiBuZXcgRGF0ZShvcHRzLnByZUdhbWVEYXRlKSxcclxuICAgICAgICAgICAgZW5kRGF0ZTogbmV3IERhdGUob3B0cy5kYXRlKSxcclxuICAgICAgICAgICAgb25DaGFuZ2VEYXRlVGltZTogb3B0cy5vbkNoYW5nZURhdGVUaW1lQ3JlYXRvcihpbnB1dCksXHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgaWYgKG9wdHMuZXZlbnRUaW1lICE9PSAnJykge1xyXG4gICAgICAgICAgICBwaWNrZXJPcHRzLnZhbHVlID0gb3B0cy5ldmVudFRpbWU7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgcGlja2VyT3B0cy52YWx1ZSA9IG9wdHMuZGF0ZTtcclxuICAgICAgICAgICAgYWRkQ2xhc3MoaW5wdXQsICdkZWZhdWx0RGF0ZScpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgalF1ZXJ5KGlucHV0KS5kYXRldGltZXBpY2tlcihwaWNrZXJPcHRzKTtcclxuICAgICAgICByZXR1cm4gaW5wdXQ7XHJcbiAgICB9O1xyXG5cclxuICAgIC8vIGJ1ZyBhYm91dCBzZXR0aW5nIDA5MDAgeWVhcnMgaW4gQnJhYXZvcyBnYW1lIGlzIGV2ZW50IGRhdGUuIEZpeGVkIGluIHByb2R1Y3Rpb24uXHJcbiAgICAvLyAgZXhwb3J0cy5tYWtlRXZlbnRUaW1lUGlja2VyID0gZnVuY3Rpb24gKG9wdHMpIHtcclxuICAgIC8vICAgICAgdmFyIGlucHV0ID0gbWFrZUVsKFwiaW5wdXRcIik7XHJcbiAgICAvLyAgICAgIFIuYXAoW2FkZENsYXNzKGlucHV0KV0sIG9wdHMuZXh0cmFDbGFzc2VzKTtcclxuICAgIC8vICAgICAgYWRkQ2xhc3MoaW5wdXQsIFwiZXZlbnRUaW1lXCIpO1xyXG4gICAgLy8gICAgICBpbnB1dC52YWx1ZSA9IG9wdHMuZXZlbnRUaW1lO1xyXG4gICAgLy9cclxuICAgIC8vICAgICAgaW5wdXQuZXZlbnRJbmRleCA9IG9wdHMuaW5kZXg7XHJcbiAgICAvL1xyXG4gICAgLy8gICAgICB2YXIgcGlja2VyT3B0cyA9IHtcclxuICAgIC8vICAgICAgICAgIGxhbmcgOiBMMTBuLmdldExhbmcoKSxcclxuICAgIC8vICAgICAgICAgIG1hc2sgOiB0cnVlLFxyXG4gICAgLy8gICAgICAgICAgc3RhcnREYXRlIDogbmV3IERhdGUob3B0cy5wcmVHYW1lRGF0ZSksXHJcbiAgICAvLyAgICAgICAgICBlbmREYXRlIDogbmV3IERhdGUob3B0cy5kYXRlKSxcclxuICAgIC8vICAgICAgICAgIG9uQ2hhbmdlRGF0ZVRpbWUgOiBvcHRzLm9uQ2hhbmdlRGF0ZVRpbWVDcmVhdG9yKGlucHV0KSxcclxuICAgIC8vICAgICAgfTtcclxuICAgIC8vXHJcbiAgICAvLyAgICAgIHZhciBwaWNrZXIgPSBqUXVlcnkoaW5wdXQpLmRhdGV0aW1lcGlja2VyKHBpY2tlck9wdHMpO1xyXG4gICAgLy9cclxuICAgIC8vICAgICAgdmFyIHZhbHVlO1xyXG4gICAgLy8gICAgICBpZiAob3B0cy5ldmVudFRpbWUgIT09IFwiXCIpIHtcclxuICAgIC8vICAgICAgICAgIHZhbHVlID0gbmV3IERhdGUob3B0cy5ldmVudFRpbWUpO1xyXG4gICAgLy8gICAgICB9IGVsc2Uge1xyXG4gICAgLy8gICAgICAgICAgdmFsdWUgPSBvcHRzLmRhdGU7XHJcbiAgICAvLyAgICAgICAgICBhZGRDbGFzcyhpbnB1dCwgXCJkZWZhdWx0RGF0ZVwiKTtcclxuICAgIC8vICAgICAgfVxyXG4gICAgLy9cclxuICAgIC8vICAgICAgcGlja2VyLnZhbHVlID0gdmFsdWU7XHJcbiAgICAvL1xyXG4gICAgLy9cclxuICAgIC8vICAgICAgcmV0dXJuIGlucHV0O1xyXG4gICAgLy8gIH07XHJcblxyXG4gICAgZXhwb3J0cy5yZXNpemVUZXh0YXJlYSA9IChldikgPT4ge1xyXG4gICAgICAgIGNvbnN0IHRoYXQgPSBldi50YXJnZXQ7XHJcbiAgICAgICAgdGhhdC5zdHlsZS5oZWlnaHQgPSAnMjRweCc7XHJcbiAgICAgICAgdGhhdC5zdHlsZS5oZWlnaHQgPSBgJHt0aGF0LnNjcm9sbEhlaWdodCArIDEyfXB4YDtcclxuICAgIH07XHJcblxyXG4gICAgZXhwb3J0cy5yZXNpemVUZXh0YXJlYTIgPSAodGhhdCkgPT4ge1xyXG4gICAgICAgIHRoYXQuc3R5bGUuaGVpZ2h0ID0gJzI0cHgnO1xyXG4gICAgICAgIHRoYXQuc3R5bGUuaGVpZ2h0ID0gYCR7dGhhdC5zY3JvbGxIZWlnaHQgKyAxMn1weGA7XHJcbiAgICB9O1xyXG5cclxuICAgIGV4cG9ydHMubWFrZUFkYXB0YXRpb25UaW1lSW5wdXQgPSAoc3RvcnlOYW1lLCBldmVudCwgY2hhcmFjdGVyTmFtZSwgaXNFZGl0YWJsZSkgPT4ge1xyXG4gICAgICAgIGNvbnN0IGlucHV0ID0gbWFrZUVsKCdpbnB1dCcpO1xyXG4gICAgICAgIHNldENsYXNzQnlDb25kaXRpb24oaW5wdXQsICdub3RFZGl0YWJsZScsICFpc0VkaXRhYmxlKTtcclxuICAgICAgICBhZGRDbGFzcyhpbnB1dCwgJ2FkYXB0YXRpb25UaW1lSW5wdXQnKTtcclxuICAgICAgICBpbnB1dC52YWx1ZSA9IGV2ZW50LmNoYXJhY3RlcnNbY2hhcmFjdGVyTmFtZV0udGltZTtcclxuICAgICAgICBpbnB1dC5kYXRhS2V5ID0gSlNPTi5zdHJpbmdpZnkoW3N0b3J5TmFtZSwgZXZlbnQuaW5kZXgsIGNoYXJhY3Rlck5hbWVdKTtcclxuICAgICAgICBsaXN0ZW4oaW5wdXQsICdjaGFuZ2UnLCBvbkNoYW5nZVBlcnNvbmFsVGltZURlbGVnYXRlKTtcclxuICAgICAgICByZXR1cm4gaW5wdXQ7XHJcbiAgICB9O1xyXG5cclxuICAgIHZhciBvbkNoYW5nZVBlcnNvbmFsVGltZURlbGVnYXRlID0gKGV2ZW50KSA9PiB7XHJcbiAgICAgICAgY29uc3QgZGF0YUtleSA9IEpTT04ucGFyc2UoZXZlbnQudGFyZ2V0LmRhdGFLZXkpO1xyXG4gICAgICAgIGNvbnN0IHRpbWUgPSBldmVudC50YXJnZXQudmFsdWU7XHJcbiAgICAgICAgREJNUy5zZXRFdmVudEFkYXB0YXRpb25Qcm9wZXJ0eShkYXRhS2V5WzBdLCBkYXRhS2V5WzFdLCBkYXRhS2V5WzJdLCAndGltZScsIHRpbWUsIFV0aWxzLnByb2Nlc3NFcnJvcigpKTtcclxuICAgIH07XHJcblxyXG4gICAgZXhwb3J0cy5tYWtlQWRhcHRhdGlvblJlYWR5SW5wdXQgPSAoc3RvcnlOYW1lLCBldmVudCwgY2hhcmFjdGVyTmFtZSwgaXNFZGl0YWJsZSkgPT4ge1xyXG4gICAgICAgIGNvbnN0IGRpdiA9IG1ha2VFbCgnZGl2Jyk7XHJcbiAgICAgICAgY29uc3QgaW5wdXQgPSBtYWtlRWwoJ2lucHV0Jyk7XHJcbiAgICAgICAgc2V0Q2xhc3NCeUNvbmRpdGlvbihpbnB1dCwgJ25vdEVkaXRhYmxlJywgIWlzRWRpdGFibGUpO1xyXG4gICAgICAgIGlucHV0LnR5cGUgPSAnY2hlY2tib3gnO1xyXG4gICAgICAgIGlucHV0LmNoZWNrZWQgPSBldmVudC5jaGFyYWN0ZXJzW2NoYXJhY3Rlck5hbWVdLnJlYWR5O1xyXG4gICAgICAgIGlucHV0LmRhdGFLZXkgPSBKU09OLnN0cmluZ2lmeShbc3RvcnlOYW1lLCBldmVudC5pbmRleCwgY2hhcmFjdGVyTmFtZV0pO1xyXG4gICAgICAgIGlucHV0LmlkID0gYCR7ZXZlbnQuaW5kZXh9LSR7c3RvcnlOYW1lfS0ke2NoYXJhY3Rlck5hbWV9YDtcclxuICAgICAgICBsaXN0ZW4oaW5wdXQsICdjaGFuZ2UnLCBvbkNoYW5nZVJlYWR5U3RhdHVzKTtcclxuICAgICAgICBhZGRFbChkaXYsIGlucHV0KTtcclxuXHJcbiAgICAgICAgYWRkRWwoZGl2LCBzZXRBdHRyKGFkZEVsKG1ha2VFbCgnbGFiZWwnKSwgbWFrZVRleHQoY29uc3RMMTBuKENvbnN0YW50cy5maW5pc2hlZFRleHQpKSksICdmb3InLCBpbnB1dC5pZCkpO1xyXG4gICAgICAgIHJldHVybiBkaXY7XHJcbiAgICB9O1xyXG5cclxuICAgIHZhciBvbkNoYW5nZVJlYWR5U3RhdHVzID0gKGV2ZW50KSA9PiB7XHJcbiAgICAgICAgY29uc3QgZGF0YUtleSA9IEpTT04ucGFyc2UoZXZlbnQudGFyZ2V0LmRhdGFLZXkpO1xyXG4gICAgICAgIGNvbnN0IHZhbHVlID0gZXZlbnQudGFyZ2V0LmNoZWNrZWQ7XHJcbiAgICAgICAgREJNUy5zZXRFdmVudEFkYXB0YXRpb25Qcm9wZXJ0eShkYXRhS2V5WzBdLCBkYXRhS2V5WzFdLCBkYXRhS2V5WzJdLCAncmVhZHknLCB2YWx1ZSwgVXRpbHMucHJvY2Vzc0Vycm9yKCkpO1xyXG4gICAgfTtcclxuXHJcbiAgICBleHBvcnRzLm1ha2VQYW5lbENvcmUgPSAodGl0bGUsIGNvbnRlbnQpID0+IHtcclxuICAgICAgICBjb25zdCBwYW5lbCA9IGFkZENsYXNzZXMobWFrZUVsKCdkaXYnKSwgWydwYW5lbCcsICdwYW5lbC1kZWZhdWx0J10pO1xyXG4gICAgICAgIGNvbnN0IGgzID0gYWRkQ2xhc3MoYWRkRWwobWFrZUVsKCdoMycpLCB0aXRsZSksICdwYW5lbC10aXRsZScpO1xyXG4gICAgICAgIGNvbnN0IGEgPSBzZXRBdHRyKG1ha2VFbCgnYScpLCAnaHJlZicsICcjLycpO1xyXG4gICAgICAgIGNvbnN0IGhlYWREaXYgPSBhZGRDbGFzcyhtYWtlRWwoJ2RpdicpLCAncGFuZWwtaGVhZGluZycpO1xyXG4gICAgICAgIGFkZEVsKHBhbmVsLCBhZGRFbChoZWFkRGl2LCBhZGRFbChhLCBoMykpKTtcclxuICAgICAgICBjb25zdCBjb250ZW50RGl2ID0gYWRkQ2xhc3MobWFrZUVsKCdkaXYnKSwgJ3BhbmVsLWJvZHknKTtcclxuICAgICAgICBhZGRFbChwYW5lbCwgYWRkRWwoY29udGVudERpdiwgY29udGVudCkpO1xyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIHBhbmVsLFxyXG4gICAgICAgICAgICBjb250ZW50RGl2LFxyXG4gICAgICAgICAgICBhXHJcbiAgICAgICAgfTtcclxuICAgIH07XHJcblxyXG4gICAgZXhwb3J0cy5tYWtlUHJvZmlsZVRhYmxlID0gKHByb2ZpbGVTdHJ1Y3R1cmUsIHByb2ZpbGUpID0+IHtcclxuICAgICAgICBsZXQgdmFsdWU7XHJcbiAgICAgICAgY29uc3QgcHJvZmlsZURpdiA9IGFkZEVscyhtYWtlRWwoJ3Rib2R5JyksIHByb2ZpbGVTdHJ1Y3R1cmUuZmlsdGVyKGVsZW1lbnQgPT4gZWxlbWVudC5kb0V4cG9ydCkubWFwKChlbGVtZW50KSA9PiB7XHJcbiAgICAgICAgICAgIHN3aXRjaCAoZWxlbWVudC50eXBlKSB7XHJcbiAgICAgICAgICAgIGNhc2UgJ3RleHQnOlxyXG4gICAgICAgICAgICAgICAgdmFsdWUgPSBhZGRDbGFzcyhtYWtlRWwoJ3NwYW4nKSwgJ2JyaWVmaW5nVGV4dFNwYW4nKTtcclxuICAgICAgICAgICAgICAgIGFkZEVsKHZhbHVlLCBtYWtlVGV4dChwcm9maWxlW2VsZW1lbnQubmFtZV0pKTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlICdlbnVtJzpcclxuICAgICAgICAgICAgY2FzZSAnbXVsdGlFbnVtJzpcclxuICAgICAgICAgICAgY2FzZSAnbnVtYmVyJzpcclxuICAgICAgICAgICAgY2FzZSAnc3RyaW5nJzpcclxuICAgICAgICAgICAgICAgIHZhbHVlID0gbWFrZVRleHQocHJvZmlsZVtlbGVtZW50Lm5hbWVdKTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlICdjaGVja2JveCc6XHJcbiAgICAgICAgICAgICAgICB2YWx1ZSA9IG1ha2VUZXh0KGNvbnN0TDEwbihDb25zdGFudHNbcHJvZmlsZVtlbGVtZW50Lm5hbWVdXSkpO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFVuZXhwZWN0ZWQgdHlwZSAke2VsZW1lbnQudHlwZX1gKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gZXhwb3J0cy5tYWtlVGFibGVSb3cobWFrZVRleHQoZWxlbWVudC5uYW1lKSwgdmFsdWUpO1xyXG4gICAgICAgIH0pKTtcclxuICAgICAgICByZXR1cm4gYWRkRWwoYWRkQ2xhc3NlcyhtYWtlRWwoJ3RhYmxlJyksIFsndGFibGUnLCAndGFibGUtc3RyaXBlZCddKSwgcHJvZmlsZURpdik7XHJcbiAgICB9O1xyXG5cclxuICAgIGV4cG9ydHMubWFrZVRhYmxlUm93ID0gKGNvbDEsIGNvbDIpID0+IGFkZEVscyhtYWtlRWwoJ3RyJyksIFthZGRFbChtYWtlRWwoJ3RkJyksIGNvbDEpLCBhZGRFbChtYWtlRWwoJ3RkJyksIGNvbDIpXSk7XHJcbn0pKHRoaXMuVUkgPSB7fSk7XHJcbiIsIi8qQ29weXJpZ2h0IDIwMTUtMjAxNyBUaW1vZmV5IFJlY2hrYWxvdiA8bnRzZGtAeWFuZGV4LnJ1PiwgTWFyaWEgU2lkZWtobWVub3ZhIDxtYXRpbGRhX0BsaXN0LnJ1PlxyXG5cclxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcclxueW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxyXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcclxuXHJcbmh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxyXG5cclxuVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxyXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXHJcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxyXG5TZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXHJcbiAgICBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4gKi9cclxuXHJcbid1c2Ugc3RyaWN0JztcclxuXHJcbi8vIFRPRE8gbmVlZCB0byBsaW50IHV0aWxzIHdpdGggTklNUyBmaXhlc1xyXG4vKiBlc2xpbnQtZGlzYWJsZSAqL1xyXG5cclxuY29uc3Qgc3RyRm9ybWF0ID0gUi5jdXJyeShDb21tb25VdGlscy5zdHJGb3JtYXQpO1xyXG5cclxuZnVuY3Rpb24gZ2V0TDEwbihrZXkpIHtcclxuICAgIHJldHVybiBMMTBuLmdldFZhbHVlKGtleSk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGNvbnN0TDEwbihrZXkpIHtcclxuICAgIHJldHVybiBMMTBuLmdldFZhbHVlKGBjb25zdGFudC0ke2tleX1gKTtcclxufVxyXG5cclxuZnVuY3Rpb24gaXNFbXB0eShvYmopIHtcclxuICAgIHJldHVybiAoT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXMob2JqKS5sZW5ndGggPT09IDApO1xyXG59XHJcblxyXG5jb25zdCBhZGRDbGFzcyA9IFIuY3VycnkoKG8sIGMpID0+IHtcclxuICAgIGNvbnN0IHJlID0gbmV3IFJlZ0V4cChgKF58XFxcXHMpJHtjfShcXFxcc3wkKWAsICdnJyk7XHJcbiAgICBpZiAocmUudGVzdChvLmNsYXNzTmFtZSkpIHJldHVybiBvO1xyXG4gICAgby5jbGFzc05hbWUgPSAoYCR7by5jbGFzc05hbWV9ICR7Y31gKS5yZXBsYWNlKC9cXHMrL2csICcgJykucmVwbGFjZSgvKF4gfCAkKS9nLCAnJyk7XHJcbiAgICByZXR1cm4gbztcclxufSk7XHJcblxyXG5jb25zdCBhZGRDbGFzc2VzID0gUi5jdXJyeSgobywgYykgPT4ge1xyXG4gICAgUi5hcChbYWRkQ2xhc3MobyldLCBjKTtcclxuICAgIHJldHVybiBvO1xyXG59KTtcclxuXHJcbmNvbnN0IHJBZGRDbGFzcyA9IFIuY3VycnkoKGMsIG8pID0+IGFkZENsYXNzKG8sIGMpKTtcclxuXHJcbmZ1bmN0aW9uIGhhc0NsYXNzKG8sIGMpIHtcclxuICAgIGNvbnN0IHJlID0gbmV3IFJlZ0V4cChgKF58XFxcXHMpJHtjfShcXFxcc3wkKWAsICdnJyk7XHJcbiAgICByZXR1cm4gKHJlLnRlc3Qoby5jbGFzc05hbWUpKTtcclxufVxyXG5cclxuY29uc3QgcmVtb3ZlQ2xhc3MgPSBSLmN1cnJ5KChvLCBjKSA9PiB7XHJcbiAgICBjb25zdCByZSA9IG5ldyBSZWdFeHAoYChefFxcXFxzKSR7Y30oXFxcXHN8JClgLCAnZycpO1xyXG4gICAgby5jbGFzc05hbWUgPSBvLmNsYXNzTmFtZS5yZXBsYWNlKHJlLCAnJDEnKS5yZXBsYWNlKC9cXHMrL2csICcgJykucmVwbGFjZSgvKF4gfCAkKS9nLCAnJyk7XHJcbn0pO1xyXG5cclxuY29uc3QgdG9nZ2xlQ2xhc3MgPSBSLmN1cnJ5KChvLCBjKSA9PiB7XHJcbiAgICBpZiAoaGFzQ2xhc3MobywgYykpIHtcclxuICAgICAgICByZW1vdmVDbGFzcyhvLCBjKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgICAgYWRkQ2xhc3MobywgYyk7XHJcbiAgICB9XHJcbn0pO1xyXG5cclxuZnVuY3Rpb24gc2V0Q2xhc3NCeUNvbmRpdGlvbihvLCBjLCBjb25kaXRpb24pIHtcclxuICAgIGlmIChjb25kaXRpb24pIHtcclxuICAgICAgICBhZGRDbGFzcyhvLCBjKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgICAgcmVtb3ZlQ2xhc3MobywgYyk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gbztcclxufVxyXG5cclxuZnVuY3Rpb24gZ2V0RWwoaWQpIHtcclxuICAgIHJldHVybiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChpZCk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHF1ZXJ5RWwoc2VsKSB7XHJcbiAgICByZXR1cm4gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihzZWwpO1xyXG59XHJcblxyXG5mdW5jdGlvbiBxdWVyeUVscyhzZWwpIHtcclxuICAgIHJldHVybiBubDJhcnJheShkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKHNlbCkpO1xyXG59XHJcblxyXG5mdW5jdGlvbiBxdWVyeUVsRWxzKGVsLCBzZWwpIHtcclxuICAgIHJldHVybiBubDJhcnJheShlbC5xdWVyeVNlbGVjdG9yQWxsKHNlbCkpO1xyXG59XHJcblxyXG5mdW5jdGlvbiBnZXRFbHMoY2xhenopIHtcclxuICAgIHJldHVybiBkb2N1bWVudC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKGNsYXp6KTtcclxufVxyXG5cclxuZnVuY3Rpb24gbWFrZUVsKGVsVGFnKSB7XHJcbiAgICByZXR1cm4gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChlbFRhZyk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIG1ha2VUZXh0KHRleHQpIHtcclxuICAgIHJldHVybiBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSh0ZXh0KTtcclxufVxyXG5cclxuY29uc3QgYWRkRWwgPSBSLmN1cnJ5KChwYXJlbnQsIGNoaWxkKSA9PiB7XHJcbiAgICBwYXJlbnQuYXBwZW5kQ2hpbGQoY2hpbGQpO1xyXG4gICAgcmV0dXJuIHBhcmVudDtcclxufSk7XHJcbmNvbnN0IGFkZEVscyA9IFIuY3VycnkoKHBhcmVudCwgY2hpbGRyZW4pID0+IHtcclxuICAgIFIuYXAoW2FkZEVsKHBhcmVudCldLCBjaGlsZHJlbik7XHJcbiAgICByZXR1cm4gcGFyZW50O1xyXG59KTtcclxuXHJcbmNvbnN0IG1ha2VPcHQgPSBmdW5jdGlvbiAobGFiZWwpIHtcclxuICAgIGNvbnN0IG9wdGlvbiA9IG1ha2VFbCgnb3B0aW9uJyk7XHJcbiAgICBhZGRFbChvcHRpb24sIChtYWtlVGV4dChsYWJlbCkpKTtcclxuICAgIHJldHVybiBvcHRpb247XHJcbn07XHJcblxyXG5jb25zdCByQWRkRWwgPSBSLmN1cnJ5KChjaGlsZCwgcGFyZW50KSA9PiB7XHJcbiAgICBwYXJlbnQuYXBwZW5kQ2hpbGQoY2hpbGQpO1xyXG4gICAgcmV0dXJuIHBhcmVudDtcclxufSk7XHJcblxyXG5cclxuY29uc3Qgc2V0QXR0ciA9IFIuY3VycnkoKGVsLCBuYW1lLCB2YWx1ZSkgPT4ge1xyXG4gICAgZWwuc2V0QXR0cmlidXRlKG5hbWUsIHZhbHVlKTtcclxuICAgIHJldHVybiBlbDtcclxufSk7XHJcblxyXG5jb25zdCBzZXRTdHlsZSA9IFIuY3VycnkoKGVsLCBuYW1lLCB2YWx1ZSkgPT4ge1xyXG4gICAgZWwuc3R5bGUuc2V0UHJvcGVydHkobmFtZSwgdmFsdWUpO1xyXG4gICAgcmV0dXJuIGVsO1xyXG59KTtcclxuXHJcbmNvbnN0IHNldEltcG9ydGFudFN0eWxlID0gUi5jdXJyeSgoZWwsIG5hbWUsIHZhbHVlKSA9PiB7XHJcbiAgICBlbC5zdHlsZS5zZXRQcm9wZXJ0eShuYW1lLCB2YWx1ZSwgJ2ltcG9ydGFudCcpO1xyXG4gICAgcmV0dXJuIGVsO1xyXG59KTtcclxuXHJcbmZ1bmN0aW9uIGRlbEF0dHIoZWwsIG5hbWUpIHtcclxuICAgIGVsLnJlbW92ZUF0dHJpYnV0ZShuYW1lKTtcclxuICAgIHJldHVybiBlbDtcclxufVxyXG5cclxuZnVuY3Rpb24gZ2V0QXR0cihlbCwgbmFtZSkge1xyXG4gICAgcmV0dXJuIGVsLmdldEF0dHJpYnV0ZShuYW1lKTtcclxufVxyXG5cclxuY29uc3Qgc2V0UHJvcCA9IFIuY3VycnkoKGVsLCBrZXksIHZhbHVlKSA9PiB7XHJcbiAgICBlbFtrZXldID0gdmFsdWU7XHJcbiAgICByZXR1cm4gZWw7XHJcbn0pO1xyXG5cclxuY29uc3Qgc2V0UHJvcHMgPSBSLmN1cnJ5KChlbCwgbWFwKSA9PiB7XHJcbiAgICBmb3IgKGNvbnN0IGtleSBpbiBtYXApIHtcclxuICAgICAgICBzZXRQcm9wKGVsLCBrZXksIG1hcFtrZXldKTtcclxuICAgIH1cclxuICAgIHJldHVybiBlbDtcclxufSk7XHJcblxyXG5mdW5jdGlvbiBjbGVhckVsKGVsKSB7XHJcbiAgICBVdGlscy5yZW1vdmVDaGlsZHJlbihlbCk7XHJcbiAgICByZXR1cm4gZWw7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHBhc3NFbHMoc3JjLCBkc3QpIHtcclxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc3JjLmNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgYWRkRWwoZHN0LCBzcmMuY2hpbGRyZW5baV0pO1xyXG4gICAgfVxyXG59XHJcblxyXG5jb25zdCBsaXN0ZW4gPSBSLmN1cnJ5KChlbCwgZXZlbnQsIGxpc3RlbmVyKSA9PiB7XHJcbiAgICBlbC5hZGRFdmVudExpc3RlbmVyKGV2ZW50LCBsaXN0ZW5lcik7XHJcbiAgICByZXR1cm4gZWw7XHJcbn0pO1xyXG5cclxuY29uc3QgbGlzdGVuT25FbnRlciA9IFIuY3VycnkoKGVsLCBjYWxsYmFjaykgPT4ge1xyXG4gICAgbGlzdGVuKGVsLCAna2V5ZG93bicsIChlKSA9PiB7XHJcbiAgICAgICAgaWYgKGUua2V5Q29kZSA9PT0gMTMpIHtcclxuICAgICAgICAgICAgY2FsbGJhY2soKTtcclxuICAgICAgICB9XHJcbiAgICB9KTtcclxufSk7XHJcblxyXG5jb25zdCBmaWxsU2VsZWN0b3IgPSBSLmN1cnJ5KChzZWwsIGRhdGEpID0+IGFkZEVscyhzZWwsIGRhdGEubWFwKChpdGVtKSA9PiB7XHJcbiAgICBjb25zdCBvcHQgPSBtYWtlRWwoJ29wdGlvbicpO1xyXG4gICAgYWRkRWwob3B0LCBtYWtlVGV4dChpdGVtLm5hbWUpKTtcclxuICAgIGlmIChpdGVtLnZhbHVlKSB7IG9wdC52YWx1ZSA9IGl0ZW0udmFsdWU7IH1cclxuICAgIGlmIChpdGVtLnNlbGVjdGVkKSB7IG9wdC5zZWxlY3RlZCA9IHRydWU7IH1cclxuICAgIGlmIChpdGVtLmNsYXNzTmFtZSkgeyBhZGRDbGFzcyhvcHQsIGl0ZW0uY2xhc3NOYW1lKTsgfVxyXG4gICAgcmV0dXJuIG9wdDtcclxufSkpKTtcclxuXHJcbmZ1bmN0aW9uIG5sMmFycmF5KG5vZGVMaXN0KSB7XHJcbiAgICByZXR1cm4gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwobm9kZUxpc3QpO1xyXG59XHJcblxyXG5jb25zdCByZW1hcFByb3BzID0gUi5jdXJyeSgob3V0S2V5cywgcGlja0tleXMsIG9iaikgPT4gUi5jb21wb3NlKFIuemlwT2JqKG91dEtleXMpLCBSLnZhbHVlcywgUi5waWNrKHBpY2tLZXlzKSkob2JqKSk7XHJcblxyXG5jb25zdCByZW1hcFByb3BzNFNlbGVjdDIgPSByZW1hcFByb3BzKFsnaWQnLCAndGV4dCddLCBbJ3ZhbHVlJywgJ2Rpc3BsYXlOYW1lJ10pO1xyXG5jb25zdCByZW1hcFByb3BzNFNlbGVjdCA9IHJlbWFwUHJvcHMoWyd2YWx1ZScsICduYW1lJ10sIFsndmFsdWUnLCAnZGlzcGxheU5hbWUnXSk7XHJcblxyXG5jb25zdCBnZXRTZWxlY3QyRGF0YUNvbW1vbiA9IFIuY3VycnkoKHByZXBhcmF0b3IsIG9iaikgPT4gUi5jb21wb3NlKFIuemlwT2JqKFsnZGF0YSddKSwgUi5hcHBlbmQoUi5fXywgW10pLCBSLm1hcChwcmVwYXJhdG9yKSkob2JqKSk7XHJcblxyXG5jb25zdCBnZXRTZWxlY3QyRGF0YSA9IGdldFNlbGVjdDJEYXRhQ29tbW9uKHJlbWFwUHJvcHM0U2VsZWN0Mik7XHJcblxyXG5jb25zdCBtYWtlU2VsZWN0Mk9wdCA9IFIuY29tcG9zZShSLnppcE9iaihbJ2lkJywgJ3RleHQnXSksIFIucmVwZWF0KFIuX18sIDIpKTtcclxuY29uc3QgYXJyMlNlbGVjdDIgPSBSLmNvbXBvc2UoUi5hc3NvYygnZGF0YScsIFIuX18sIHt9KSwgUi5tYXAobWFrZVNlbGVjdDJPcHQpKTtcclxuY29uc3QgYXJyMlNlbGVjdCA9IFIubWFwKFIuY29tcG9zZShSLnppcE9iaihbJ3ZhbHVlJywgJ25hbWUnXSksIFIucmVwZWF0KFIuX18sIDIpKSk7XHJcbmNvbnN0IGNvbnN0QXJyMlNlbGVjdCA9IFIubWFwKFIuY29tcG9zZShSLnppcE9iaihbJ3ZhbHVlJywgJ25hbWUnXSksIG5hbWUgPT4gW25hbWUsIGNvbnN0TDEwbihuYW1lKV0pKTtcclxuXHJcbmNvbnN0IGdldFNlbGVjdGVkUmFkaW8gPSBmdW5jdGlvbiAocXVlcnkpIHtcclxuICAgIGNvbnN0IGVscyA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwocXVlcnkpO1xyXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBlbHMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICBpZiAoZWxzW2ldLmNoZWNrZWQgPT09IHRydWUpIHtcclxuICAgICAgICAgICAgcmV0dXJuIGVsc1tpXTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gbnVsbDtcclxufTtcclxuXHJcbmNvbnN0IGRlYnVnSW50ZXJjZXB0b3IgPSBmdW5jdGlvbiAoY2FsbGJhY2spIHtcclxuICAgIHJldHVybiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgY29uc29sZS5sb2coSlNPTi5zdHJpbmdpZnkoYXJndW1lbnRzWzBdKSk7XHJcbiAgICAgICAgY2FsbGJhY2soLi4uYXJndW1lbnRzKTtcclxuICAgIH07XHJcbn07XHJcblxyXG5jb25zdCBVdGlscyA9IHt9O1xyXG5cclxuLyoqIG9wdHNcclxuICAgIHRvb2x0aXAgLSBhZGQgdG9vbHRpcCB0byBidXR0b24sIHVzZWQgZm9yIGljb25pYyBidXR0b25zXHJcbiAgICBpZCAtIHNldCBidXR0b24gaWRcclxuICAgIG1haW5QYWdlIC0gZW5hYmxlIHZpZXcgYXMgZmlyc3QgcGFnZVxyXG4gICAgdG9nZ2xlIC0gdG9nZ2xlIGNvbnRlbnQsIGFzc29jaWF0ZWQgd2l0aCBidXR0b25cclxuKi9cclxuVXRpbHMuYWRkVmlldyA9IGZ1bmN0aW9uIChjb250YWluZXJzLCBuYW1lLCB2aWV3LCBvcHRzMikge1xyXG4gICAgY29uc3Qgb3B0cyA9IG9wdHMyIHx8IHt9O1xyXG4gICAgdmlldy5pbml0KCk7XHJcbiAgICBjb25zdCBidXR0b25DbGFzcyA9ICduYXZpZ2F0aW9uLWJ1dHRvbic7XHJcbiAgICBjb250YWluZXJzLnJvb3Qudmlld3NbbmFtZV0gPSB2aWV3O1xyXG4gICAgY29uc3QgYnV0dG9uID0gbWFrZUVsKCdidXR0b24nKTtcclxuICAgIGZ1bmN0aW9uIGRlbGVnYXRlKCkge1xyXG4gICAgICAgICQoYnV0dG9uKS5hdHRyKCdkYXRhLW9yaWdpbmFsLXRpdGxlJywgTDEwbi5nZXRWYWx1ZShgaGVhZGVyLSR7bmFtZX1gKSk7XHJcbiAgICB9XHJcbiAgICBpZiAob3B0cy50b29sdGlwKSB7XHJcbiAgICAgICAgTDEwbi5vbkwxMG5DaGFuZ2UoZGVsZWdhdGUpO1xyXG4gICAgICAgICQoYnV0dG9uKS50b29sdGlwKHtcclxuICAgICAgICAgICAgdGl0bGU6IEwxMG4uZ2V0VmFsdWUoYGhlYWRlci0ke25hbWV9YCksXHJcbiAgICAgICAgICAgIHBsYWNlbWVudDogJ2JvdHRvbSdcclxuICAgICAgICB9KTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgICAgYWRkRWwoYnV0dG9uLCBtYWtlVGV4dChMMTBuLmdldFZhbHVlKGBoZWFkZXItJHtuYW1lfWApKSk7XHJcbiAgICAgICAgc2V0QXR0cihidXR0b24sICdsMTBuLWlkJywgYGhlYWRlci0ke25hbWV9YCk7XHJcbiAgICB9XHJcbiAgICBhZGRDbGFzcyhidXR0b24sIGJ1dHRvbkNsYXNzKTtcclxuICAgIGFkZENsYXNzKGJ1dHRvbiwgYC10ZXN0LSR7bmFtZX1gKTtcclxuICAgIGFkZENsYXNzKGJ1dHRvbiwgYC10b2dnbGUtY2xhc3MtJHtuYW1lfWApO1xyXG4gICAgaWYgKG9wdHMuY2xhenopIHtcclxuICAgICAgICBhZGRDbGFzcyhidXR0b24sIG9wdHMuY2xhenopO1xyXG4gICAgfVxyXG4gICAgY29udGFpbmVycy5uYXZpZ2F0aW9uLmFwcGVuZENoaWxkKGJ1dHRvbik7XHJcblxyXG4gICAgY29uc3Qgb25DbGlja0RlbGVnYXRlID0gZnVuY3Rpb24gKHZpZXcyKSB7XHJcbiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChldnQpIHtcclxuICAgICAgICAgICAgLy9UZXN0cy5ydW4oKTtcclxuICAgICAgICAgICAgY29uc3QgZWxlbXMgPSBjb250YWluZXJzLm5hdmlnYXRpb24uZ2V0RWxlbWVudHNCeUNsYXNzTmFtZShidXR0b25DbGFzcyk7XHJcbiAgICAgICAgICAgIGlmIChvcHRzLnRvZ2dsZSkge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgZWxzID0gZ2V0RWxzKGAtdG9nZ2xlLWNsYXNzLSR7bmFtZX1gKTtcclxuICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZWxzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGV2dC50YXJnZXQuaXNFcXVhbE5vZGUoZWxzW2ldKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGhhc0NsYXNzKGVsc1tpXSwgJ2FjdGl2ZScpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc1tpXS5jbGljaygpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgY29uc3QgaXNBY3RpdmUgPSBoYXNDbGFzcyhldnQudGFyZ2V0LCAnYWN0aXZlJyk7XHJcbiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZWxlbXMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgICAgIHJlbW92ZUNsYXNzKGVsZW1zW2ldLCAnYWN0aXZlJyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKCFvcHRzLnRvZ2dsZSB8fCAob3B0cy50b2dnbGUgJiYgIWlzQWN0aXZlKSkge1xyXG4gICAgICAgICAgICAgICAgYWRkQ2xhc3MoZXZ0LnRhcmdldCwgJ2FjdGl2ZScpO1xyXG5cclxuICAgICAgICAgICAgICAgIHBhc3NFbHMoY29udGFpbmVycy5jb250ZW50LCBnZXRFbCgnd2FyZWhvdXNlJykpO1xyXG4gICAgICAgICAgICAgICAgY29udGFpbmVycy5jb250ZW50LmFwcGVuZENoaWxkKHZpZXcyLmNvbnRlbnQpO1xyXG4gICAgICAgICAgICAgICAgcmVtb3ZlQ2xhc3MoY29udGFpbmVycy5jb250ZW50LCAnaGlkZGVuJyk7XHJcbiAgICAgICAgICAgICAgICBjb250YWluZXJzLnJvb3QuY3VycmVudFZpZXcgPSB2aWV3MjtcclxuICAgICAgICAgICAgICAgIHZpZXcyLnJlZnJlc2goKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHJlbW92ZUNsYXNzKGV2dC50YXJnZXQsICdhY3RpdmUnKTtcclxuICAgICAgICAgICAgICAgIHBhc3NFbHMoY29udGFpbmVycy5jb250ZW50LCBnZXRFbCgnd2FyZWhvdXNlJykpO1xyXG4gICAgICAgICAgICAgICAgY29udGFpbmVycy5yb290LmN1cnJlbnRWaWV3ID0gbnVsbDtcclxuICAgICAgICAgICAgICAgIGFkZENsYXNzKGNvbnRhaW5lcnMuY29udGVudCwgJ2hpZGRlbicpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfTtcclxuICAgIH07XHJcblxyXG4gICAgYnV0dG9uLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgb25DbGlja0RlbGVnYXRlKHZpZXcpKTtcclxuICAgIGlmIChvcHRzLm1haW5QYWdlKSB7XHJcbiAgICAgICAgYWRkQ2xhc3MoYnV0dG9uLCAnYWN0aXZlJyk7XHJcbiAgICAgICAgY29udGFpbmVycy5jb250ZW50LmFwcGVuZENoaWxkKHZpZXcuY29udGVudCk7XHJcbiAgICAgICAgY29udGFpbmVycy5yb290LmN1cnJlbnRWaWV3ID0gdmlldztcclxuICAgIH1cclxufTtcclxuXHJcblV0aWxzLmFsZXJ0ID0gZnVuY3Rpb24gKG1lc3NhZ2UpIHtcclxuICAgIHZleC5kaWFsb2cuYWxlcnQobWVzc2FnZSk7XHJcbn07XHJcblxyXG5VdGlscy5jb25maXJtID0gZnVuY3Rpb24gKG1lc3NhZ2UsIG9uT2ssIG9uQ2FuY2VsKSB7XHJcbiAgICB2ZXguZGlhbG9nLmNvbmZpcm0oe1xyXG4gICAgICAgIG1lc3NhZ2UsXHJcbiAgICAgICAgY2FsbGJhY2s6ICh2YWwpID0+IHtcclxuICAgICAgICAgICAgaWYgKHZhbCkge1xyXG4gICAgICAgICAgICAgICAgaWYgKG9uT2spIG9uT2soKTtcclxuICAgICAgICAgICAgfSBlbHNlIGlmIChvbkNhbmNlbCkgb25DYW5jZWwoKTtcclxuICAgICAgICB9XHJcbiAgICB9KTtcclxufTtcclxuXHJcblV0aWxzLnJlbW92ZUNoaWxkcmVuID0gZnVuY3Rpb24gKG15Tm9kZSkge1xyXG4gICAgaWYgKCFteU5vZGUpIHtcclxuICAgICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICB3aGlsZSAobXlOb2RlLmZpcnN0Q2hpbGQpIHtcclxuICAgICAgICBteU5vZGUucmVtb3ZlQ2hpbGQobXlOb2RlLmZpcnN0Q2hpbGQpO1xyXG4gICAgfVxyXG59O1xyXG5cclxuVXRpbHMucHJvY2Vzc0Vycm9yID0gZnVuY3Rpb24gKGNhbGxiYWNrKSB7XHJcbiAgICByZXR1cm4gZnVuY3Rpb24gKGVycikge1xyXG4gICAgICAgIGlmIChlcnIpIHtcclxuICAgICAgICAgICAgVXRpbHMuaGFuZGxlRXJyb3IoZXJyKTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKGNhbGxiYWNrKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGFyciA9IFtdO1xyXG4gICAgICAgICAgICBmb3IgKGxldCBpID0gMTsgaSA8IGFyZ3VtZW50cy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICAgICAgYXJyLnB1c2goYXJndW1lbnRzW2ldKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjYWxsYmFjayguLi5hcnIpO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbn07XHJcblxyXG5VdGlscy5oYW5kbGVFcnJvck1zZyA9IGZ1bmN0aW9uIChlcnIpIHtcclxuICAgIGNvbnN0IGNoZWNrRXJyb3JUeXBlID0gUi5jdXJyeSgoZXJyMiwgbmFtZSkgPT4gZXJyMiBpbnN0YW5jZW9mIEVycm9yc1tuYW1lXSB8fCAoZXJyMi5uYW1lICYmIGVycjIubmFtZSA9PT0gbmFtZSkpO1xyXG4gICAgaWYgKFIua2V5cyhFcnJvcnMpLnNvbWUoY2hlY2tFcnJvclR5cGUoZXJyKSkpIHtcclxuICAgICAgICByZXR1cm4gc3RyRm9ybWF0KGdldEwxMG4oZXJyLm1lc3NhZ2VJZCksIGVyci5wYXJhbWV0ZXJzKTtcclxuICAgIH0gZWxzZSBpZiAodHlwZW9mIGVyciA9PT0gJ29iamVjdCcpIHtcclxuICAgICAgICByZXR1cm4gZXJyLm1lc3NhZ2U7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gZXJyO1xyXG59O1xyXG5cclxuVXRpbHMuaGFuZGxlRXJyb3IgPSBlcnIgPT4gVXRpbHMuYWxlcnQoVXRpbHMuaGFuZGxlRXJyb3JNc2coZXJyKSk7XHJcblxyXG5VdGlscy5lbmFibGVFbCA9IFIuY3VycnkoKGVsLCBjb25kaXRpb24pID0+IHtcclxuICAgIGNvbnN0IGtleSA9IGVsLnRhZ05hbWUudG9Mb3dlckNhc2UoKSA9PT0gJ3RleHRhcmVhJyA/ICdyZWFkb25seScgOiAnZGlzYWJsZWQnO1xyXG4gICAgaWYgKGNvbmRpdGlvbikge1xyXG4gICAgICAgIGVsLnJlbW92ZUF0dHJpYnV0ZShrZXkpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgICBlbC5zZXRBdHRyaWJ1dGUoa2V5LCBrZXkpO1xyXG4gICAgfVxyXG59KTtcclxuXHJcblV0aWxzLmVuYWJsZSA9IGZ1bmN0aW9uIChyb290LCBjbGFzc05hbWUsIGNvbmRpdGlvbikge1xyXG4gICAgbmwyYXJyYXkocm9vdC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKGNsYXNzTmFtZSkpLm1hcChVdGlscy5lbmFibGVFbChSLl9fLCBjb25kaXRpb24pKTtcclxufTtcclxuXHJcblV0aWxzLmNoYXJPcmRBT2JqZWN0ID0gQ29tbW9uVXRpbHMuY2hhck9yZEFGYWN0b3J5KGEgPT4gYS5kaXNwbGF5TmFtZS50b0xvd2VyQ2FzZSgpKTtcclxuXHJcblV0aWxzLnJlYnVpbGRTZWxlY3RvciA9IGZ1bmN0aW9uIChzZWxlY3RvciwgbmFtZXMpIHtcclxuICAgIGNsZWFyRWwoc2VsZWN0b3IpO1xyXG4gICAgbmFtZXMuZm9yRWFjaCgobmFtZUluZm8pID0+IHtcclxuICAgICAgICBjb25zdCBvcHRpb24gPSBtYWtlRWwoJ29wdGlvbicpO1xyXG4gICAgICAgIG9wdGlvbi5hcHBlbmRDaGlsZChtYWtlVGV4dChuYW1lSW5mby5kaXNwbGF5TmFtZSkpO1xyXG4gICAgICAgIG9wdGlvbi52YWx1ZSA9IG5hbWVJbmZvLnZhbHVlO1xyXG4gICAgICAgIHNlbGVjdG9yLmFwcGVuZENoaWxkKG9wdGlvbik7XHJcbiAgICB9KTtcclxufTtcclxuXHJcblV0aWxzLnJlYnVpbGRTZWxlY3RvckFyciA9IGZ1bmN0aW9uIChzZWxlY3RvciwgbmFtZXMpIHtcclxuICAgIGNsZWFyRWwoc2VsZWN0b3IpO1xyXG4gICAgbmFtZXMuZm9yRWFjaCgobmFtZSkgPT4ge1xyXG4gICAgICAgIGNvbnN0IG9wdGlvbiA9IG1ha2VFbCgnb3B0aW9uJyk7XHJcbiAgICAgICAgb3B0aW9uLmFwcGVuZENoaWxkKG1ha2VUZXh0KG5hbWUpKTtcclxuICAgICAgICBzZWxlY3Rvci5hcHBlbmRDaGlsZChvcHRpb24pO1xyXG4gICAgfSk7XHJcbn07XHJcblxyXG5TdHJpbmcucHJvdG90eXBlLmVuZHNXaXRoID0gZnVuY3Rpb24gKHN1ZmZpeCkge1xyXG4gICAgcmV0dXJuIHRoaXMuaW5kZXhPZihzdWZmaXgsIHRoaXMubGVuZ3RoIC0gc3VmZml4Lmxlbmd0aCkgIT09IC0xO1xyXG59O1xyXG5cclxuLy8gZnJvbSBkYXRlIGZvcm1hdCB1dGlsc1xyXG4vL0ZvciBjb252ZW5pZW5jZS4uLlxyXG5EYXRlLnByb3RvdHlwZS5mb3JtYXQgPSBmdW5jdGlvbiAobWFzaywgdXRjKSB7XHJcbiAgICByZXR1cm4gZGF0ZUZvcm1hdCh0aGlzLCBtYXNrLCB1dGMpO1xyXG59O1xyXG4iLCIvKkNvcHlyaWdodCAyMDE3IFRpbW9mZXkgUmVjaGthbG92IDxudHNka0B5YW5kZXgucnU+XHJcblxyXG5MaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xyXG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXHJcbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxyXG5cclxuaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXHJcblxyXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXHJcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcclxuV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXHJcblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcclxuICAgIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLiAqL1xyXG5cclxuJ3VzZSBzdHJpY3QnO1xyXG5cclxuKChleHBvcnRzKSA9PiB7XHJcbiAgICBjb25zdCBzdGF0ZSA9IHt9O1xyXG4gICAgc3RhdGUudmlld3MgPSB7fTtcclxuXHJcbiAgICBjb25zdCBidG5PcHRzID0ge1xyXG4gICAgICAgIHRvb2x0aXA6IHRydWUsXHJcbiAgICAgICAgY2xhc3NOYW1lOiAnbWFpbk5hdkJ1dHRvbidcclxuICAgIH07XHJcblxyXG4gICAgZXhwb3J0cy5vbk1hc3RlclBhZ2VMb2FkID0gKCkgPT4ge1xyXG4gICAgICAgIGluaXRQYWdlKCk7XHJcbiAgICAgICAgY29uc3QgTG9jYWxEQk1TID0gbWFrZUxvY2FsREJNUyh0cnVlKTtcclxuICAgICAgICBpZiAoTU9ERSA9PT0gJ1N0YW5kYWxvbmUnKSB7XHJcbiAgICAgICAgICAgIHdpbmRvdy5EQk1TID0gbmV3IExvY2FsREJNUygpO1xyXG4gICAgICAgICAgICBEQk1TLnNldERhdGFiYXNlKEJhc2VFeGFtcGxlLmRhdGEsIChlcnIpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChlcnIpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgICAgICBjb25zaXN0ZW5jeUNoZWNrKG9uRGF0YWJhc2VMb2FkKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSBlbHNlIGlmIChNT0RFID09PSAnTklNU19TZXJ2ZXInKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IFJlbW90ZURCTVMgPSBtYWtlUmVtb3RlREJNUyhMb2NhbERCTVMpO1xyXG4gICAgICAgICAgICB3aW5kb3cuREJNUyA9IG5ldyBSZW1vdGVEQk1TKCk7XHJcbiAgICAgICAgICAgIGNvbnNpc3RlbmN5Q2hlY2sob25EYXRhYmFzZUxvYWQpO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcblxyXG4gICAgZnVuY3Rpb24gb25EYXRhYmFzZUxvYWQoKSB7XHJcbiAgICAgICAgLy8gICAgICAgIGluaXRUaGVtZSgpO1xyXG5cclxuICAgICAgICBzdGF0ZUluaXQoKTtcclxuXHJcbiAgICAgICAgVXRpbHMuYWRkVmlldyhzdGF0ZS5jb250YWluZXJzLCAncGVyZm9ybWFuY2UnLCBQZXJmb3JtYW5jZSwgeyBtYWluUGFnZTogdHJ1ZSB9KTtcclxuICAgICAgICAvLyAgICAgICAgVXRpbHMuYWRkVmlldyhzdGF0ZS5jb250YWluZXJzLCAnaW5zdHJ1Y3Rpb24nLCBJbnN0cnVjdGlvbik7XHJcblxyXG4gICAgICAgIGFkZEVsKHN0YXRlLm5hdmlnYXRpb24sIGFkZENsYXNzKG1ha2VFbCgnZGl2JyksICduYXYtc2VwYXJhdG9yJykpO1xyXG5cclxuICAgICAgICBVdGlscy5hZGRWaWV3KHN0YXRlLmNvbnRhaW5lcnMsICdhYm91dCcsIEFib3V0KTtcclxuXHJcbiAgICAgICAgYWRkRWwoc3RhdGUubmF2aWdhdGlvbiwgbWFrZUJ1dHRvbigndGVzdEJ1dHRvbicsICd0ZXN0JywgcnVuVGVzdHMsIGJ0bk9wdHMpKTtcclxuXHJcbiAgICAgICAgY29uc3QgYnV0dG9uID0gbWFrZUJ1dHRvbignZGF0YUxvYWRCdXR0b24nLCAnb3Blbi1kYXRhYmFzZScsIG51bGwsIGJ0bk9wdHMpO1xyXG4gICAgICAgIGJ1dHRvbi5hZGRFdmVudExpc3RlbmVyKCdjaGFuZ2UnLCBGaWxlVXRpbHMucmVhZFNpbmdsZUZpbGUsIGZhbHNlKTtcclxuXHJcbiAgICAgICAgY29uc3QgaW5wdXQgPSBtYWtlRWwoJ2lucHV0Jyk7XHJcbiAgICAgICAgaW5wdXQudHlwZSA9ICdmaWxlJztcclxuICAgICAgICBhZGRDbGFzcyhpbnB1dCwgJ2hpZGRlbicpO1xyXG4gICAgICAgIHNldEF0dHIoaW5wdXQsICd0YWJpbmRleCcsIC0xKTtcclxuICAgICAgICBidXR0b24uYXBwZW5kQ2hpbGQoaW5wdXQpO1xyXG4gICAgICAgIGJ1dHRvbi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChlKSA9PiB7XHJcbiAgICAgICAgICAgIGlucHV0LnZhbHVlID0gJyc7XHJcbiAgICAgICAgICAgIGlucHV0LmNsaWNrKCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgYWRkRWwoc3RhdGUubmF2aWdhdGlvbiwgYnV0dG9uKTtcclxuXHJcbiAgICAgICAgLy8gICAgICAgICAgICAgICAgYWRkRWwoc3RhdGUubmF2aWdhdGlvbiwgbWFrZUJ1dHRvbihcInRoZW1lQnV0dG9uXCIsIFwidGhlbWVcIiwgKCkgPT4gbmV4dFRoZW1lKCksIGJ0bk9wdHMpKTtcclxuICAgICAgICBhZGRFbChzdGF0ZS5uYXZpZ2F0aW9uLCBtYWtlQnV0dG9uKCdkYXRhU2F2ZUJ1dHRvbicsICdzYXZlLWRhdGFiYXNlJywgRmlsZVV0aWxzLnNhdmVGaWxlLCBidG5PcHRzKSk7XHJcbiAgICAgICAgLy9pZiAoTU9ERSA9PT0gJ1N0YW5kYWxvbmUnKSB7XHJcbiAgICAgICAgLy8gIGFkZEVsKHN0YXRlLm5hdmlnYXRpb24sIG1ha2VCdXR0b24oJ25ld0Jhc2VCdXR0b24nLCAnY3JlYXRlLWRhdGFiYXNlJywgRmlsZVV0aWxzLm1ha2VOZXdCYXNlLCBidG5PcHRzKSk7XHJcbiAgICAgICAgLy99XHJcbiAgICAgICAgLy9hZGRFbChzdGF0ZS5uYXZpZ2F0aW9uLCBtYWtlQnV0dG9uKFwibWFpbkhlbHBCdXR0b25cIiwgXCJkb2NzXCIsIEZpbGVVdGlscy5vcGVuSGVscCwgYnRuT3B0cykpO1xyXG5cclxuICAgICAgICAvLyAgICAgICAgYWRkRWwoc3RhdGUubmF2aWdhdGlvbiwgbWFrZUwxMG5CdXR0b24oKSk7XHJcblxyXG4gICAgICAgIC8vICAgICAgICBVdGlscy5hZGRWaWV3KHN0YXRlLmNvbnRhaW5lcnMsICdsb2dWaWV3ZXInLCBMb2dWaWV3ZXIyLCB7IGNsYXp6OiAnbG9nVmlld2VyQnV0dG9uJywgdG9vbHRpcDogdHJ1ZSB9KTtcclxuICAgICAgICAvLyAgICAgICAgYWRkRWwoc3RhdGUubmF2aWdhdGlvbiwgbWFrZUJ1dHRvbigndGVzdEJ1dHRvbicsICd0ZXN0JywgcnVuVGVzdHMsIGJ0bk9wdHMpKTtcclxuXHJcbiAgICAgICAgLy9hZGRFbChzdGF0ZS5uYXZpZ2F0aW9uLCBtYWtlQnV0dG9uKFwicmVmcmVzaEJ1dHRvblwiLCBcInJlZnJlc2hcIiwgKCkgPT4gc3RhdGUuY3VycmVudFZpZXcucmVmcmVzaCgpLCBidG5PcHRzKSk7XHJcblxyXG4gICAgICAgIEZpbGVVdGlscy5pbml0KChlcnIpID0+IHtcclxuICAgICAgICAgICAgaWYgKGVycikgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgY29uc2lzdGVuY3lDaGVjayhzdGF0ZS5jdXJyZW50Vmlldy5yZWZyZXNoKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgc3RhdGUuY3VycmVudFZpZXcucmVmcmVzaCgpO1xyXG4gICAgICAgIGFkZEJlZm9yZVVubG9hZExpc3RlbmVyKCk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gaW5pdFBhZ2UoKSB7XHJcbiAgICAgICAgTDEwbi5sb2NhbGl6ZVN0YXRpYygpO1xyXG4gICAgICAgIEwxMG4ub25MMTBuQ2hhbmdlKCgpID0+IHN0YXRlLmN1cnJlbnRWaWV3LnJlZnJlc2goKSk7XHJcbiAgICAgICAgVUkuaW5pdFNlbGVjdG9yRmlsdGVycygpO1xyXG4gICAgICAgIFVJLmluaXRQYW5lbFRvZ2dsZXJzKCk7XHJcbiAgICAgICAgZnVuY3Rpb24gdXBkYXRlRGlhbG9ncygpIHtcclxuICAgICAgICAgICAgdmV4LmRpYWxvZy5idXR0b25zLllFUy50ZXh0ID0gZ2V0TDEwbignY29tbW9uLW9rJyk7XHJcbiAgICAgICAgICAgIHZleC5kaWFsb2cuYnV0dG9ucy5OTy50ZXh0ID0gZ2V0TDEwbignY29tbW9uLWNhbmNlbCcpO1xyXG4gICAgICAgIH1cclxuICAgICAgICB1cGRhdGVEaWFsb2dzKCk7XHJcbiAgICAgICAgTDEwbi5vbkwxMG5DaGFuZ2UodXBkYXRlRGlhbG9ncyk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gICAgdmFyIGN1clRoZW1lID0gQ29uc3RhbnRzLnRoZW1lTGlzdFsxXTtcclxuICAgIC8vXHJcbiAgICAvLyAgICB2YXIgaW5pdFRoZW1lID0gZnVuY3Rpb24oKSB7XHJcbiAgICAvLyAgICAgICAgaWYoREJNUy5zZXRUaGVtZSl7XHJcbiAgICAvLyAgICAgICAgICAgIERCTVMuZ2V0VGhlbWUoZnVuY3Rpb24oZXJyLCB0aGVtZSl7XHJcbiAgICAvLyAgICAgICAgICAgICAgICBpZihlcnIpIHtjb25zb2xlLmxvZyhlcnIpO31cclxuICAgIC8vICAgICAgICAgICAgICAgIGlmKHRoZW1lICE9PSAnJyl7XHJcbiAgICAvLyAgICAgICAgICAgICAgICAgICAgY3VyVGhlbWUgPSB0aGVtZTtcclxuICAgIC8vICAgICAgICAgICAgICAgIH1cclxuICAgIC8vICAgICAgICAgICAgICAgIGFkZENsYXNzKHF1ZXJ5RWwoJ2JvZHknKSwgY3VyVGhlbWUpO1xyXG4gICAgLy8gICAgICAgICAgICB9KTtcclxuICAgIC8vICAgICAgICB9IGVsc2Uge1xyXG4gICAgLy8gICAgICAgICAgICBhZGRDbGFzcyhxdWVyeUVsKCdib2R5JyksIGN1clRoZW1lKTtcclxuICAgIC8vICAgICAgICB9XHJcbiAgICAvLyAgICB9O1xyXG4gICAgLy9cclxuICAgIC8vICAgIHZhciBuZXh0VGhlbWUgPSBmdW5jdGlvbigpIHtcclxuICAgIC8vICAgICAgICByZW1vdmVDbGFzcyhxdWVyeUVsKCdib2R5JyksIGN1clRoZW1lKTtcclxuICAgIC8vICAgICAgICBjdXJUaGVtZSA9IENvbnN0YW50cy50aGVtZUxpc3RbKFIuaW5kZXhPZihjdXJUaGVtZSwgQ29uc3RhbnRzLnRoZW1lTGlzdCkrMSklQ29uc3RhbnRzLnRoZW1lTGlzdC5sZW5ndGhdO1xyXG4gICAgLy8gICAgICAgIGFkZENsYXNzKHF1ZXJ5RWwoJ2JvZHknKSwgY3VyVGhlbWUpO1xyXG4gICAgLy8gICAgICAgIGlmKERCTVMuc2V0VGhlbWUpe1xyXG4gICAgLy8gICAgICAgICAgICBEQk1TLnNldFRoZW1lKGN1clRoZW1lLCBmdW5jdGlvbihlcnIpe1xyXG4gICAgLy8gICAgICAgICAgICAgICAgaWYoZXJyKSB7Y29uc29sZS5sb2coZXJyKTsgcmV0dXJuO31cclxuICAgIC8vICAgICAgICAgICAgfSk7XHJcbiAgICAvLyAgICAgICAgfVxyXG4gICAgLy8gICAgfTtcclxuXHJcbiAgICBmdW5jdGlvbiBjb25zaXN0ZW5jeUNoZWNrKGNhbGxiYWNrKSB7XHJcbiAgICAgICAgREJNUy5nZXRDb25zaXN0ZW5jeUNoZWNrUmVzdWx0KChlcnIsIGNvbnNpc3RlbmN5RXJyb3JzKSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChlcnIpIHsgVXRpbHMuaGFuZGxlRXJyb3IoZXJyKTsgcmV0dXJuOyB9XHJcbiAgICAgICAgICAgIGNvbnNpc3RlbmN5RXJyb3JzLmZvckVhY2goQ29tbW9uVXRpbHMuY29uc29sZUxvZyk7XHJcbiAgICAgICAgICAgIGlmIChjb25zaXN0ZW5jeUVycm9ycy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgICAgICBVdGlscy5hbGVydChnZXRMMTBuKCdvdmVydmlldy1jb25zaXN0ZW5jeS1wcm9ibGVtLWRldGVjdGVkJykpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ0NvbnNpc3RlbmN5IGNoZWNrIGRpZG5cXCd0IGZpbmQgZXJyb3JzJyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY2FsbGJhY2soKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBzdGF0ZUluaXQoKSB7XHJcbiAgICAgICAgc3RhdGUubmF2aWdhdGlvbiA9IGdldEVsKCduYXZpZ2F0aW9uJyk7XHJcbiAgICAgICAgc3RhdGUuY29udGFpbmVycyA9IHtcclxuICAgICAgICAgICAgcm9vdDogc3RhdGUsXHJcbiAgICAgICAgICAgIG5hdmlnYXRpb246IHN0YXRlLm5hdmlnYXRpb24sXHJcbiAgICAgICAgICAgIGNvbnRlbnQ6IGdldEVsKCdjb250ZW50QXJlYScpXHJcbiAgICAgICAgfTtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBydW5UZXN0cygpIHtcclxuICAgICAgICBEQk1TLmdldENvbnNpc3RlbmN5Q2hlY2tSZXN1bHQoKGVyciwgY29uc2lzdGVuY3lFcnJvcnMpID0+IHtcclxuICAgICAgICAgICAgaWYgKGVycikgeyBVdGlscy5oYW5kbGVFcnJvcihlcnIpOyByZXR1cm47IH1cclxuICAgICAgICAgICAgY29uc2lzdGVuY3lFcnJvcnMuZm9yRWFjaChDb21tb25VdGlscy5jb25zb2xlTG9nKTtcclxuICAgICAgICAgICAgaWYgKGNvbnNpc3RlbmN5RXJyb3JzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgICAgIFV0aWxzLmFsZXJ0KGdldEwxMG4oJ292ZXJ2aWV3LWNvbnNpc3RlbmN5LXByb2JsZW0tZGV0ZWN0ZWQnKSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBVdGlscy5hbGVydChnZXRMMTBuKCdvdmVydmlldy1jb25zaXN0ZW5jeS1pcy1vaycpKTtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdDb25zaXN0ZW5jeSBjaGVjayBkaWRuXFwndCBmaW5kIGVycm9ycycpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gbWFrZUJ1dHRvbihjbGF6eiwgbmFtZSwgY2FsbGJhY2ssIG9wdHMpIHtcclxuICAgICAgICBjb25zdCBidXR0b24gPSBtYWtlRWwoJ2J1dHRvbicpO1xyXG4gICAgICAgIGFkZENsYXNzKGJ1dHRvbiwgY2xhenopO1xyXG4gICAgICAgIGZ1bmN0aW9uIGRlbGVnYXRlKCkge1xyXG4gICAgICAgICAgICAkKGJ1dHRvbikuYXR0cignZGF0YS1vcmlnaW5hbC10aXRsZScsIEwxMG4uZ2V0VmFsdWUoYGhlYWRlci0ke25hbWV9YCkpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAob3B0cy50b29sdGlwKSB7XHJcbiAgICAgICAgICAgIEwxMG4ub25MMTBuQ2hhbmdlKGRlbGVnYXRlKTtcclxuICAgICAgICAgICAgJChidXR0b24pLnRvb2x0aXAoe1xyXG4gICAgICAgICAgICAgICAgdGl0bGU6IEwxMG4uZ2V0VmFsdWUoYGhlYWRlci0ke25hbWV9YCksXHJcbiAgICAgICAgICAgICAgICBwbGFjZW1lbnQ6ICdib3R0b20nXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICBhZGRDbGFzcyhidXR0b24sICdhY3Rpb24tYnV0dG9uJyk7XHJcbiAgICAgICAgaWYgKG9wdHMuY2xhc3NOYW1lKSB7XHJcbiAgICAgICAgICAgIGFkZENsYXNzKGJ1dHRvbiwgb3B0cy5jbGFzc05hbWUpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoY2FsbGJhY2spIHtcclxuICAgICAgICAgICAgbGlzdGVuKGJ1dHRvbiwgJ2NsaWNrJywgY2FsbGJhY2spO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gYnV0dG9uO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIG1ha2VMMTBuQnV0dG9uKCkge1xyXG4gICAgICAgIGNvbnN0IGwxMG5CdG4gPSBtYWtlQnV0dG9uKCd0b2dnbGVMMTBuQnV0dG9uJywgJ2wxMG4nLCBMMTBuLnRvZ2dsZUwxMG4sIGJ0bk9wdHMpO1xyXG4gICAgICAgIGZ1bmN0aW9uIHNldEljb24oKSB7XHJcbiAgICAgICAgICAgIGwxMG5CdG4uc3R5bGUuYmFja2dyb3VuZEltYWdlID0gc3RyRm9ybWF0KCd1cmwoXCIuL2ltYWdlcy97MH0uc3ZnXCIpJywgW2dldEwxMG4oJ2hlYWRlci1kaWN0aW9uYXJ5LWljb24nKV0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICBMMTBuLm9uTDEwbkNoYW5nZShzZXRJY29uKTtcclxuICAgICAgICBzZXRJY29uKCk7XHJcbiAgICAgICAgcmV0dXJuIGwxMG5CdG47XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gYWRkQmVmb3JlVW5sb2FkTGlzdGVuZXIoKSB7XHJcbiAgICAgICAgd2luZG93Lm9uYmVmb3JldW5sb2FkID0gKGV2dCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBtZXNzYWdlID0gZ2V0TDEwbigndXRpbHMtY2xvc2UtcGFnZS13YXJuaW5nJyk7XHJcbiAgICAgICAgICAgIGlmICh0eXBlb2YgZXZ0ID09PSAndW5kZWZpbmVkJykge1xyXG4gICAgICAgICAgICAgICAgZXZ0ID0gd2luZG93LmV2ZW50O1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmIChldnQpIHtcclxuICAgICAgICAgICAgICAgIGV2dC5yZXR1cm5WYWx1ZSA9IG1lc3NhZ2U7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIG1lc3NhZ2U7XHJcbiAgICAgICAgfTtcclxuICAgIH1cclxufSkodGhpcy5QYWdlTWFuYWdlciA9IHt9KTtcclxuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
